<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />



<meta name="date" content="2025-03-13" />

<title>MRP norming tutorial</title>

<script src="site_libs/header-attrs-2.27/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="site_libs/font-awesome-6.4.2/css/all.min.css" rel="stylesheet" />
<link href="site_libs/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>






<link rel="stylesheet" href="styles.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="01_data_cleaning.html">Data preprocessing</a>
</li>
<li>
  <a href="02_model_selection.html">Model selection</a>
</li>
<li>
  <a href="03_norm_comparisons.html">Norm comparisons</a>
</li>
<li>
  <a href="04_supplements.html">Additional analyses</a>
</li>
<li>
  <a href="05_tutorial.html">MRP Norming Tutorial</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/TaymAlsalti/MRP_Norming">
    <span class="fa fa-github"></span>
     
    
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">MRP norming tutorial</h1>
<h4 class="date">2025-03-13</h4>

</div>


<pre class="r"><code>knitr::opts_chunk$set(
    message = FALSE,
    warning = T,
    include = TRUE,
    error = TRUE,
    fig.width = 8,
    fig.height = 4
)

library(tidyverse)
library(haven)
library(data.table)
library(ggrepel)
library(kableExtra)
library(brms)
library(tidybayes)
library(marginaleffects)
library(bayesplot)
library(rstan)

# depending on the platform on which you want to run the brm you might need this or not. We ran the models on a Linux-operated server
options(mc.cores = 4,
        brms.backend = &quot;cmdstanr&quot;)

options(scipen = 999,
        digits = 4)

# windowsFonts(Times = windowsFont(&quot;Times New Roman&quot;))
theme_set(theme_minimal(base_size = 12, base_family = &quot;Times&quot;))

## load preprocessed datasets (see preprocessing code below)

sb_data &lt;- readRDS(&quot;data/preprocessed/wordsum/sb_data.rds&quot;)
census_sb &lt;- readRDS(&quot;data/preprocessed/us_census/census_sb.rds&quot;)

# MRP/RPP function
source(&quot;age_norm_comparisons.R&quot;)</code></pre>
<div id="data-preprocessing" class="section level1" number="1">
<h1><span class="header-section-number">1</span> Data preprocessing</h1>
<div id="sample-data" class="section level2" number="1.1">
<h2><span class="header-section-number">1.1</span> Sample data</h2>
<pre class="r"><code># load dataset after basic cleaning and labelling (see github.com/synth-science/synth-rep-dataset for the raw data and basic cleaning code)
sb_raw &lt;- read_rds(&quot;data/raw/sb/sosci_labelled.rds&quot;) 


OCC_classification &lt;- readxl::read_xlsx(path = &quot;data/raw/sb/OCC_classification.xlsx&quot;, sheet = &quot;classification_table&quot; ) %&gt;% 
  mutate(occ = as.character(occ_occupation)) 

# load the degfield classification table

degfield_hierarchy &lt;- readxl::read_excel(&quot;data/raw/sb/degfield_hierarchy.xlsx&quot;) %&gt;% # contains a classification of the general codes into larger categories based on this wikipedia article: https://en.wikipedia.org/wiki/Outline_of_academic_disciplines
  mutate(
    degfield_label = str_to_lower(degfield_label),
    degfield_category = str_to_lower(degfield_category),
    degfield_alternative_category = str_to_lower(degfield_alternative_category))

divisions &lt;- list(
  new_england = c(&quot;connecticut&quot;, &quot;maine&quot;, &quot;massachusetts&quot;, &quot;new hampshire&quot;, &quot;rhode island&quot;, &quot;vermont&quot;),
  middle_atlantic = c(&quot;new jersey&quot;, &quot;new york&quot;, &quot;pennsylvania&quot;),
  east_north_central = c(&quot;illinois&quot;, &quot;indiana&quot;, &quot;michigan&quot;, &quot;ohio&quot;, &quot;wisconsin&quot;),
  west_north_central = c(&quot;iowa&quot;, &quot;kansas&quot;, &quot;minnesota&quot;, &quot;missouri&quot;, &quot;nebraska&quot;, &quot;north dakota&quot;, &quot;south dakota&quot;),
  south_atlantic = c(&quot;delaware&quot;, &quot;district of columbia&quot;, &quot;florida&quot;, &quot;georgia&quot;, &quot;maryland&quot;, 
                     &quot;north carolina&quot;, &quot;south carolina&quot;, &quot;virginia&quot;, &quot;west virginia&quot;),
  east_south_central = c(&quot;alabama&quot;, &quot;kentucky&quot;, &quot;mississippi&quot;, &quot;tennessee&quot;),
  west_south_central = c(&quot;arkansas&quot;, &quot;louisiana&quot;, &quot;oklahoma/indian territory&quot;, &quot;oklahoma&quot;, &quot;texas&quot;),
  mountain = c(&quot;arizona&quot;, &quot;colorado&quot;, &quot;idaho&quot;, &quot;montana&quot;, &quot;nevada&quot;, &quot;new mexico&quot;, &quot;utah&quot;, &quot;wyoming&quot;),
  pacific = c(&quot;alaska&quot;, &quot;california&quot;, &quot;hawaii&quot;, &quot;oregon&quot;, &quot;washington&quot;)
)


sb_data &lt;- sb_raw %&gt;% 
  select(CASE,
         starts_with(&quot;SD&quot;),
         gender,
         starts_with(&quot;WS&quot;)) %&gt;%
  rename(educ = SD08,
         occ = SD10) %&gt;%
    setNames(sapply(names(.), function(x) {
    label &lt;- attr(sb_raw[[x]], &quot;label&quot;, exact = TRUE)
    if (!is.null(label)) label else x
  })) %&gt;% 
  rename_all(tolower) %&gt;% 
  rename(age = &quot;age: [01]&quot;,
         inctot = &quot;inctot: [01]&quot;) %&gt;% 
  left_join(OCC_classification %&gt;% select(occ, occ_category),
            by = &quot;occ&quot;) %&gt;% # to classify the occ variable merge with the OCC_classification df
    mutate(across(where(~ is.character(.) || is.factor(.) || inherits(., &quot;labelled&quot;)),
                ~ if (is.factor(.)) {
                    factor(tolower(as.character(.)))
                  } else if (inherits(., &quot;labelled&quot;)) {
                    haven::labelled(tolower(as.character(.)), attr(., &quot;labels&quot;))
                  } else {
                    tolower(.)
                  })) %&gt;% 
  left_join(degfield_hierarchy %&gt;% select(degfield_label, degfield_category), # to categorize degfield merge with degfield_hierarchy
            by = c(&quot;degfield&quot; = &quot;degfield_label&quot;)) %&gt;% 
  rename_all(~ gsub(&quot; &quot;, &quot;_&quot;, .)) %&gt;% 
  rename_all(~ gsub(&quot;-&quot;, &quot;&quot;, .)) %&gt;% 
  mutate(
      region_birth = case_when(
        bpl_state %in% divisions$new_england ~ &quot;new england division&quot;,
        bpl_state %in% divisions$middle_atlantic ~ &quot;middle atlantic division&quot;,
        bpl_state %in% divisions$east_north_central ~ &quot;east north central division&quot;,
        bpl_state %in% divisions$west_north_central ~ &quot;west north central division&quot;,
        bpl_state %in% divisions$south_atlantic ~ &quot;south atlantic division&quot;,
        bpl_state %in% divisions$east_south_central ~ &quot;east south central division&quot;,
        bpl_state %in% divisions$west_south_central ~ &quot;west south central division&quot;,
        bpl_state %in% divisions$mountain ~ &quot;mountain division&quot;,
        bpl_state %in% divisions$pacific ~ &quot;pacific division&quot;,
        TRUE ~ &quot;abroad&quot;
      ),
      region_residence = case_when(
        state %in% divisions$new_england ~ &quot;new england division&quot;,
        state %in% divisions$middle_atlantic ~ &quot;middle atlantic division&quot;,
        state %in% divisions$east_north_central ~ &quot;east north central division&quot;,
        state %in% divisions$west_north_central ~ &quot;west north central division&quot;,
        state %in% divisions$south_atlantic ~ &quot;south atlantic division&quot;,
        state %in% divisions$east_south_central ~ &quot;east south central division&quot;,
        state %in% divisions$west_south_central ~ &quot;west south central division&quot;,
        state %in% divisions$mountain ~ &quot;mountain division&quot;,
        state %in% divisions$pacific ~ &quot;pacific division&quot;,
        TRUE ~ &quot;abroad&quot;
      ),
    income_brackets = cut(as.integer(inctot),
                        breaks = c(-Inf, 1000, 6000, 12500, 22500, 35000, 50000, 60000, 75000, 90000, 110000, Inf),
                        ordered_result = FALSE,
                        labels = c(&quot;&lt; $1,000&quot;, &quot;$1,000 - $5,999&quot;, &quot;$6,000 - $12,499&quot;, &quot;$12,500 - $22,499&quot;, 
                                   &quot;$22,500 - $34,999&quot;, &quot;$35,000 - $49,999&quot;, &quot;$50,000 - $59,999&quot;, 
                                   &quot;$60,000 - $74,999&quot;, &quot;$75,000 - $89,999&quot;, &quot;$90,000 - $109,999&quot;, &quot;&gt;$110,000&quot;)),
    educ = case_when(
      educ %in% c(&quot;n/a or no schooling&quot;, 
                  &quot;grade 5, 6, 7, or 8&quot;, 
                  &quot;grade 9&quot;, 
                  &quot;grade 10&quot;,
                  &quot;grade 11&quot;,
                  &quot;grade 12&quot;) ~ &quot;high school or less&quot;,
      educ == &quot;3 years of college&quot; ~ &quot;2 years of college&quot;,
      TRUE ~ educ # Retain other categories as they are
    ),
    female = sex == &quot;female&quot;,
    hispan = hispan != &quot;no, not of hispanic, latino, or spanish origin&quot;,
    marst = case_when(
      marst %in% c(&quot;divorced&quot;, &quot;separated&quot;, &quot;widowed&quot;) ~ &quot;separated, widowed, or divorced&quot;,
      TRUE ~ marst # Keep other categories as is
    ),
    race = case_when(
      race %in% c(&quot;chinese&quot;,
                  &quot;japanese&quot;,
                  &quot;other asian or pacific islander&quot;,
                  &quot;american indian or alaska native&quot;,
                  &quot;other race&quot;) ~ &quot;other&quot;,
      race %in% c(&quot;three or more major races&quot;,
                  &quot;two major races (e.g., white and japanese)&quot;) ~ &quot;two or more major races&quot;,
      TRUE ~ race # Keep other categories as is
    ),
    degfield_branch = case_when(
      degfield_category %in% c(&quot;formal sciences&quot;, &quot;interdisciplinary and multi-disciplinary studies (general)&quot;, &quot;natural sciences&quot;) ~ &quot;natural, formal, and other sciences&quot;,
      is.na(degfield_category) ~ &quot;n/a&quot;,
      TRUE ~ degfield_category
    ),
    occ_category = case_when(
      occ_category %in% c(&quot;Natural Resources, Construction, and Maintenance Occupations&quot;, &quot;Service Occupations&quot;) ~
        &quot;other&quot;,
      is.na(occ_category) ~ &quot;n/a: unemployed&quot;,
      TRUE ~ occ_category
    ),
         wordsum_1 =  if_else(wordsum_1 == 4, 1, 0),
         wordsum_2 =  if_else(wordsum_2 == 5, 1, 0),
         wordsum_3 =  if_else(wordsum_3 == 5, 1, 0),
         wordsum_4 =  if_else(wordsum_4 == 3, 1, 0),
         wordsum_5 =  if_else(wordsum_5 == 1, 1, 0),
         wordsum_6 =  if_else(wordsum_6 == 3, 1, 0),
         wordsum_7 =  if_else(wordsum_7 == 5, 1, 0),
         wordsum_8 =  if_else(wordsum_8 == 4, 1, 0),
         wordsum_9 =  if_else(wordsum_9 == 4, 1, 0),
         wordsum_10 = if_else(wordsum_10 == 1, 1, 0),
         wordsum = wordsum_1 + wordsum_2 + wordsum_3 + wordsum_4 + wordsum_5 + wordsum_6 + wordsum_7 + wordsum_8 + wordsum_9 + wordsum_10,
         wordsum_ordinal = as.ordered(wordsum),
         censoring = case_when(
           wordsum == 0 ~ &quot;left&quot;,
           wordsum == 10 ~ &quot;right&quot;,
           TRUE ~ &quot;none&quot;
           
         )
  ) %&gt;%
  select(CASE = case, age, female, educ, income_brackets, income = inctot, race, hispan, region_residence, state, region_birth, degfield_branch, marst, occ_category, starts_with(&quot;wordsum&quot;), censoring) %&gt;%
  filter(complete.cases(.)) %&gt;%
  left_join(sb_raw, by = &quot;CASE&quot;) %&gt;% 
    select(-ends_with(&quot;_R&quot;))


saveRDS(sb_data, &quot;data/preprocessed/wordsum/sb_data.rds&quot;)


ggplot(sb_data, aes(x = wordsum)) +
    geom_histogram(bins = 11, fill = &quot;blue&quot;, color = &quot;black&quot;) +  # Set bins to 11 for values 0 to 10
    scale_x_continuous(breaks = 0:10) +  # Set x-axis breaks for each possible value
    labs(x = &quot;Wordsum score&quot;, 
         y = &quot;Frequency&quot;) +  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.background = element_rect(fill = &quot;transparent&quot;, color = NA),
        # panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) + 
  geom_text(stat = &#39;count&#39;, aes(label = after_stat(count)), 
            vjust = -0.5,  # Adjust vertical position of labels
            color = &quot;black&quot;)  # Color of the labels</code></pre>
<p><img src="05_tutorial_files/figure-html/unnamed-chunk-1-1.svg" width="768" /></p>
</div>
<div id="census-data" class="section level2" number="1.2">
<h2><span class="header-section-number">1.2</span> Census data</h2>
<pre class="r"><code>census_sb_raw &lt;- setDT(read_dta(&quot;data/raw/us_census/usa_00015.dta.gz&quot;))

OCC_classification &lt;- readxl::read_xlsx(path = &quot;data/raw/sb/OCC_classification.xlsx&quot;, sheet = &quot;classification_table&quot; ) %&gt;% 
  mutate(occ = as.character(occ),
         occ_category = tolower(as.character(occ_category))) # change class to character

# Convert labelled columns to factors
census_sb_raw &lt;- census_sb_raw %&gt;%
  mutate_if(haven::is.labelled, as_factor)

# Convert to data.table
census_sb_raw &lt;- as.data.table(census_sb_raw)

# Define income brackets
income_breaks &lt;- c(-Inf, 1000, 6000, 12500, 22500, 35000, 50000, 60000, 75000, 90000, 110000, Inf)
income_labels &lt;- c(&quot;&lt; $1,000&quot;, &quot;$1,000 - $5,999&quot;, &quot;$6,000 - $12,499&quot;, &quot;$12,500 - $22,499&quot;, 
                   &quot;$22,500 - $34,999&quot;, &quot;$35,000 - $49,999&quot;, &quot;$50,000 - $59,999&quot;, 
                   &quot;$60,000 - $74,999&quot;, &quot;$75,000 - $89,999&quot;, &quot;$90,000 - $109,999&quot;, &quot;&gt;$110,000&quot;)

# Main processing
census_sb &lt;- census_sb_raw[, `:=`(
  income_brackets = cut(as.integer(inctot), breaks = income_breaks, labels = income_labels, ordered_result = TRUE)
)][, .(census_n = sum(perwt)), by = .(state = statefip, sex, age, marst, race, hispan, bpl, educ, degfield, occ, income_brackets)]

# Convert columns to factors and lowercase
factor_cols &lt;- c(&quot;state&quot;, &quot;sex&quot;, &quot;marst&quot;, &quot;race&quot;, &quot;hispan&quot;, &quot;bpl&quot;, &quot;educ&quot;, &quot;degfield&quot;, &quot;occ&quot;, &quot;income_brackets&quot;)
census_sb[, (factor_cols) := lapply(.SD, function(x) factor(tolower(as.character(x)))), .SDcols = factor_cols]

OCC_classification &lt;- as.data.table(OCC_classification)

degfield_hierarchy &lt;- as.data.table(degfield_hierarchy)
# Join with OCC_classification and degfield_hierarchy
census_sb &lt;- merge(census_sb, OCC_classification[, .(occ, occ_category)], by = &quot;occ&quot;, all.x = TRUE)
census_sb &lt;- merge(census_sb, degfield_hierarchy[, .(degfield_label, degfield_category)], by.x = &quot;degfield&quot;, by.y = &quot;degfield_label&quot;, all.x = TRUE)

# Apply transformations
census_sb[, `:=`(
region_birth = fcase(
  bpl %in% divisions$new_england, &quot;new england division&quot;,
  bpl %in% divisions$middle_atlantic, &quot;middle atlantic division&quot;,
  bpl %in% divisions$east_north_central, &quot;east north central division&quot;,
  bpl %in% divisions$west_north_central, &quot;west north central division&quot;,
  bpl %in% divisions$south_atlantic, &quot;south atlantic division&quot;,
  bpl %in% divisions$east_south_central, &quot;east south central division&quot;,
  bpl %in% divisions$west_south_central, &quot;west south central division&quot;,
  bpl %in% divisions$mountain, &quot;mountain division&quot;,
  bpl %in% divisions$pacific, &quot;pacific division&quot;,
  default = &quot;abroad&quot;
),
region_residence = fcase(
  state %in% divisions$new_england, &quot;new england division&quot;,
  state %in% divisions$middle_atlantic, &quot;middle atlantic division&quot;,
  state %in% divisions$east_north_central, &quot;east north central division&quot;,
  state %in% divisions$west_north_central, &quot;west north central division&quot;,
  state %in% divisions$south_atlantic, &quot;south atlantic division&quot;,
  state %in% divisions$east_south_central, &quot;east south central division&quot;,
  state %in% divisions$west_south_central, &quot;west south central division&quot;,
  state %in% divisions$mountain, &quot;mountain division&quot;,
  state %in% divisions$pacific, &quot;pacific division&quot;,
  default = &quot;abroad&quot;
),
  age = as.numeric(age),
  female = sex == &quot;female&quot;,
  marst = fcase(
    marst %in% c(&quot;married, spouse present&quot;, &quot;married, spouse absent&quot;), &quot;married&quot;,
    marst %in% c(&quot;divorced&quot;, &quot;separated&quot;, &quot;widowed&quot;), &quot;separated, widowed, or divorced&quot;,
    default = as.character(marst)
  ),
  educ = fcase(
    educ %in% c(&quot;nursery school to grade 4&quot;, &quot;n/a or no schooling&quot;, &quot;grade 5, 6, 7, or 8&quot;, &quot;grade 9&quot;, &quot;grade 10&quot;, &quot;grade 11&quot;, &quot;grade 12&quot;), &quot;high school or less&quot;,
    default = as.character(educ)
  ),
  hispan = hispan != &quot;not hispanic&quot;,
  race = fcase(
    race %in% c(&quot;chinese&quot;, &quot;japanese&quot;, &quot;other asian or pacific islander&quot;, &quot;american indian or alaska native&quot;, &quot;other race, nec&quot;), &quot;other&quot;,
    race %in% c(&quot;three or more major races&quot;, &quot;two major races&quot;), &quot;two or more major races&quot;,
    default = as.character(race)
  ),
  degfield_branch = fcase(
    degfield_category %in% c(&quot;formal sciences&quot;, &quot;interdisciplinary and multi-disciplinary studies (general)&quot;, &quot;natural sciences&quot;), &quot;natural, formal, and other sciences&quot;,
    is.na(degfield_category), &quot;n/a&quot;,
    default = as.character(degfield_category)
  ),
  occ_category = fcase(
    occ_category %in% c(&quot;Natural Resources, Construction, and Maintenance Occupations&quot;, &quot;Service Occupations&quot;), &quot;other&quot;,
    default = as.character(occ_category)
  )
)]

# Select and filter
census_sb &lt;- census_sb[, .SD, .SDcols = !c(&quot;degfield&quot;, &quot;bpl&quot;, &quot;state&quot;, &quot;occ&quot;, &quot;degfield_category&quot;, &quot;sex&quot;)]
census_sb &lt;- census_sb[between(age, 21, 67)]

# Convert remaining columns to factors
factor_cols &lt;- names(census_sb)[sapply(census_sb, is.character)]
census_sb[, (factor_cols) := lapply(.SD, as.factor), .SDcols = factor_cols]

census_sb &lt;- census_sb %&gt;% 
  relocate(census_n, .after = &quot;degfield_branch&quot;) %&gt;% 
  group_by(age, female, educ, income_brackets, race, hispan, region_residence, region_birth, degfield_branch, marst, occ_category) %&gt;% 
  summarise(census_n = sum(census_n)) %&gt;% 
  ungroup()

saveRDS(census_sb, &quot;data/preprocessed/us_census/census_sb.rds&quot;)</code></pre>
</div>
<div id="check-that-the-two-sources-have-the-same-variable-categories"
class="section level2" number="1.3">
<h2><span class="header-section-number">1.3</span> Check that the two
sources have the same variable categories</h2>
<pre class="r"><code>cat_sizes_census &lt;- census_sb %&gt;%
  select(-age, -census_n) %&gt;%
  map_dfr(~ count(tibble(Category = as.character(.x)), Category), 
          .id = &quot;Variable&quot;) %&gt;%
  arrange(Variable, Category)


cat_sizes_sb &lt;- sb_data %&gt;%
   select(-age, -wordsum, -CASE) %&gt;%
  map_dfr(~ count(tibble(Category = as.character(.x)), Category), 
          .id = &quot;Variable&quot;) %&gt;%
  arrange(Variable, Category)

anti_join(cat_sizes_census, cat_sizes_sb, by = &quot;Category&quot;)</code></pre>
<pre><code>## # A tibble: 0 × 3
## # ℹ 3 variables: Variable &lt;chr&gt;, Category &lt;chr&gt;, n &lt;int&gt;</code></pre>
</div>
</div>
<div id="distributional-disparities" class="section level1" number="2">
<h1><span class="header-section-number">2</span> Distributional
disparities</h1>
<p>Before applying MRP to correct estimates (be it for norming or other
purposes), it’s worthwhile to check if there are any differences between
the sample and the population (on which we have data from the census)
with respect to the variables we wish to use for the correction.</p>
<pre class="r"><code>aggregated_sample &lt;- sb_data %&gt;% 
               filter(between(age, 21, 67)) %&gt;% 
               mutate(across(-c(starts_with(&quot;wordsum&quot;), censoring, CASE, age, female, hispan, income_brackets), as.factor)) %&gt;% 
  group_by(age, female, educ, income_brackets, race, hispan, region_residence, region_birth, degfield_branch, marst, occ_category) %&gt;% 
  summarise(sample_n = n()) %&gt;% ungroup()

disparities_plot &lt;- census_sb %&gt;% 
  full_join(aggregated_sample, by = c(&quot;age&quot;, &quot;female&quot;, &quot;educ&quot;, &quot;income_brackets&quot;, &quot;race&quot;, &quot;hispan&quot;, &quot;region_residence&quot;, &quot;region_birth&quot;, &quot;degfield_branch&quot;, &quot;marst&quot;, &quot;occ_category&quot;)) %&gt;% 
  mutate(sample_n = replace_na(sample_n, 0),
         census_n = replace_na(census_n, 0),
         occ_category = case_when(
           occ_category == &quot;management, business, science, and arts occupations&quot; ~ &quot;MBSA&quot;,
           occ_category == &quot;sales and office occupations&quot; ~ &quot;SO&quot;,
           occ_category == &quot;production, transportation, and material moving occupations&quot; ~ &quot;PTMM&quot;,
           occ_category == &quot;service occupations&quot; ~ &quot;S&quot;,
           occ_category == &quot;natural resources, construction, and maintenance occupations&quot; ~ &quot;NRCM&quot;,
           TRUE ~ occ_category
         )) %&gt;%
  pivot_longer(cols = c(census_n:sample_n), names_to = &quot;source&quot;, values_to = &quot;n&quot;) %&gt;% 
  mutate(source = str_sub(source, 1, -3),
         n = replace_na(n, 0))  %&gt;%
  mutate(across(-c(n), as.factor)) %&gt;% 
pivot_longer(cols = -c(n, source), names_to = &quot;variable&quot;, values_to = &quot;category&quot;) %&gt;% 
  group_by(source, variable, category) %&gt;% 
  summarise(n = sum(n)) %&gt;% 
  mutate(percentage = n/sum(n)*100)

# plot age disparities
disparities_plot %&gt;%
  filter(variable == &quot;age&quot;) %&gt;% 
  ggplot(aes(x = category, y = percentage, group = source, colour = source, label = round(percentage, digits = 1))) +
  theme_minimal(base_size = 9, base_family = &quot;Times&quot;) +
  geom_line(linewidth = .5) +
  facet_grid(cols = vars(variable), scales = &quot;free&quot;, space = &#39;free&#39;, as.table = TRUE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = &quot;none&quot;, 
        # legend.justification = c(1, 1), 
        legend.background = element_rect(fill = &quot;transparent&quot;, color = NA),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(linetype = &quot;dashed&quot;, size = 0.3)) + 
  labs(x = &quot;&quot;, y = &quot;Percentage&quot;, colour = &quot;&quot;, label = &quot;Percentage&quot;) +
  scale_colour_manual(values = c(&quot;#0072B5FF&quot;, &quot;#BC3C29FF&quot;), labels = function(x) str_to_title(x)) +
  scale_x_discrete(breaks = seq(21, 67, by = 2))</code></pre>
<pre><code>## Warning: The `size` argument of `element_line()` is deprecated as of ggplot2 3.4.0.
## ℹ Please use the `linewidth` argument instead.
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_lifecycle_warnings()` to see where this warning was
## generated.</code></pre>
<p><img src="05_tutorial_files/figure-html/unnamed-chunk-4-1.svg" width="960" /></p>
<pre class="r"><code># ggsave(&quot;p.png&quot;, height = 2, width = 10)</code></pre>
<pre class="r"><code>disparities_plot %&gt;%
  mutate(category = case_when(
    variable == &quot;educ&quot; ~ factor(category, levels = c(&quot;high school or less&quot;, &quot;1 year of college&quot;, &quot;2 years of college&quot;, &quot;4 years of college&quot;, &quot;5+ years of college&quot;)),
    variable == &quot;income_brackets&quot; ~ factor(category, levels = c(&quot;&lt; $1,000&quot;, &quot;$1,000 - $5,999&quot;, &quot;$6,000 - $12,499&quot;, &quot;$12,500 - $22,499&quot;, &quot;$22,500 - $34,999&quot;, &quot;$35,000 - $49,999&quot;, &quot;$50,000 - $59,999&quot;, &quot;$60,000 - $74,999&quot;, &quot;$75,000 - $89,999&quot;, &quot;$90,000 - $109,999&quot;, &quot;&gt;$110,000&quot;)),
    variable == &quot;degfield_branch&quot; ~ factor(category, levels = c(&quot;n/a&quot;, &quot;humanities&quot;, &quot;social sciences&quot;, &quot;applied sciences and professions&quot;,   &quot;natural, formal, and other sciences&quot;)),
    variable == &quot;occ_category&quot; ~ factor(category, levels = c(&quot;n/a: unemployed&quot;, &quot;MBSA&quot;, &quot;SO&quot;, &quot;S&quot;, &quot;NRCM&quot;, &quot;PTMM&quot;)),
    variable == &quot;race&quot; ~ factor(category, levels = c(&quot;white&quot;, &quot;black/african american&quot;, &quot;two or more major races&quot;, &quot;other&quot;)),
    variable == &quot;region_birth&quot; ~ factor(category, levels = c(&quot;abroad&quot;, &quot;pacific division&quot;, &quot;middle atlantic division&quot;, &quot;new england division&quot;, &quot;mountain division&quot;, &quot;east south central division&quot;, &quot;south atlantic division&quot;, &quot;west south central division&quot;, &quot;east north central division&quot;, &quot;west north central division&quot;)),
    TRUE ~ category
  )) %&gt;% 
  filter(variable != &quot;age&quot;) %&gt;% 
  ggplot(aes(x = category, y = percentage, group = source, colour = source, label = round(percentage, digits = 1))) +
  theme_minimal(base_size = 9, base_family = &quot;Times&quot;) +
  geom_line(linewidth = .5) +
  facet_grid(cols = vars(variable), scales = &quot;free&quot;, space = &#39;free&#39;) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        legend.position = c(1, 1.08), 
        legend.justification = c(1, 1), 
        legend.background = element_rect(fill = &quot;transparent&quot;, color = NA),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_line(linetype = &quot;dashed&quot;, size = 0.3),
        plot.margin = margin(0, 0, 0, .05, &quot;cm&quot;)) + 
  labs(x = &quot;Category&quot;, y = &quot;Percentage&quot;, colour = &quot;&quot;, label = &quot;Percentage&quot;) +
  scale_colour_manual(values = c(&quot;#0072B5FF&quot;, &quot;#BC3C29FF&quot;), labels = function(x) str_to_title(x))</code></pre>
<pre><code>## Warning: A numeric `legend.position` argument in `theme()` was deprecated in ggplot2
## 3.5.0.
## ℹ Please use the `legend.position.inside` argument of `theme()` instead.
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_lifecycle_warnings()` to see where this warning was
## generated.</code></pre>
<p><img src="05_tutorial_files/figure-html/unnamed-chunk-5-1.svg" width="864" /></p>
<pre class="r"><code># ggsave(&quot;p.png&quot;, height = 3, width = 9)</code></pre>
</div>
<div id="regularised-prediction-model" class="section level1"
number="3">
<h1><span class="header-section-number">3</span> Regularised prediction
model</h1>
<p>This is the MR part of MRP.</p>
<div id="model-comparison" class="section level2" number="3.1">
<h2><span class="header-section-number">3.1</span> Model comparison</h2>
<p>Terms of this form <code>(1 | variable)</code> represent random
intercepts, <code>female</code> and <code>hispan</code> were included as
a fixed effect to avoid estimation problems due to the small number of
categories, <code>s(age)</code> is a thin plate spline of age.</p>
<div id="normal-with-interactions" class="section level3"
number="3.1.1">
<h3><span class="header-section-number">3.1.1</span> Normal with
interactions</h3>
<pre class="r"><code>brm_1 &lt;- brm(bf(wordsum ~ s(age, by = educ) + (1 | educ) + female + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth) + (1 | income_brackets) +
(1 | educ:race) +
(1 | educ:hispan) +
(1 | educ:region_residence) +
(1 | educ:marst) +
(1 | educ:degfield_branch) +
(1 | educ:occ_category) +
(1 | educ:region_birth) +
(1 | educ:income_brackets) +
(1 | race:hispan) +
(1 | race:region_residence) +
(1 | race:marst) +
(1 | race:degfield_branch) +
(1 | race:occ_category) +
(1 | race:region_birth) +
(1 | race:income_brackets) +
(1 | hispan:region_residence) +
(1 | hispan:marst) +
(1 | hispan:degfield_branch) +
(1 | hispan:occ_category) +
(1 | hispan:region_birth) +
(1 | hispan:income_brackets) +
(1 | region_residence:marst) +
(1 | region_residence:degfield_branch) +
(1 | region_residence:occ_category) +
(1 | region_residence:region_birth) +
(1 | region_residence:income_brackets) +
(1 | marst:degfield_branch) +
(1 | marst:occ_category) +
(1 | marst:region_birth) +
(1 | marst:income_brackets) +
(1 | degfield_branch:occ_category) +
(1 | degfield_branch:region_birth) +
(1 | degfield_branch:income_brackets) +
(1 | occ_category:region_birth) +
(1 | occ_category:income_brackets) +
(1 | region_birth:income_brackets) +
(1 | female:educ) +
(1 | female:race) +
(1 | female:hispan) +
(1 | female:region_residence) +
(1 | female:marst) +
(1 | female:degfield_branch) +
(1 | female:occ_category) +
(1 | female:region_birth) +
(1 | female:income_brackets),
                   sigma ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth)  + female + (1 | income_brackets)
                   ),
    seed = 14,
    chains = 4,
    file = &quot;data/brms/wordsum/sb/brm_1&quot;,
    data = sb_data) %&gt;%
  add_criterion(&quot;loo&quot;)

brm_1</code></pre>
<pre><code>## Warning: There were 76 divergent transitions after warmup. Increasing
## adapt_delta above 0.8 may help. See
## http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</code></pre>
<pre><code>##  Family: gaussian 
##   Links: mu = identity; sigma = log 
## Formula: wordsum ~ s(age, by = educ) + (1 | educ) + female + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth) + (1 | income_brackets) + (1 | educ:race) + (1 | educ:hispan) + (1 | educ:region_residence) + (1 | educ:marst) + (1 | educ:degfield_branch) + (1 | educ:occ_category) + (1 | educ:region_birth) + (1 | educ:income_brackets) + (1 | race:hispan) + (1 | race:region_residence) + (1 | race:marst) + (1 | race:degfield_branch) + (1 | race:occ_category) + (1 | race:region_birth) + (1 | race:income_brackets) + (1 | hispan:region_residence) + (1 | hispan:marst) + (1 | hispan:degfield_branch) + (1 | hispan:occ_category) + (1 | hispan:region_birth) + (1 | hispan:income_brackets) + (1 | region_residence:marst) + (1 | region_residence:degfield_branch) + (1 | region_residence:occ_category) + (1 | region_residence:region_birth) + (1 | region_residence:income_brackets) + (1 | marst:degfield_branch) + (1 | marst:occ_category) + (1 | marst:region_birth) + (1 | marst:income_brackets) + (1 | degfield_branch:occ_category) + (1 | degfield_branch:region_birth) + (1 | degfield_branch:income_brackets) + (1 | occ_category:region_birth) + (1 | occ_category:income_brackets) + (1 | region_birth:income_brackets) + (1 | female:educ) + (1 | female:race) + (1 | female:hispan) + (1 | female:region_residence) + (1 | female:marst) + (1 | female:degfield_branch) + (1 | female:occ_category) + (1 | female:region_birth) + (1 | female:income_brackets) 
##          sigma ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth) + female + (1 | income_brackets)
##    Data: sb_data (Number of observations: 478) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Smoothing Spline Hyperparameters:
##                                 Estimate Est.Error l-95% CI u-95% CI Rhat
## sds(sageeduc1yearofcollege_1)       1.73      1.63     0.06     6.02 1.00
## sds(sageeduc2yearsofcollege_1)      1.61      1.40     0.06     5.39 1.00
## sds(sageeduc4yearsofcollege_1)      1.62      1.65     0.05     6.15 1.00
## sds(sageeduc5Pyearsofcollege_1)     1.86      1.29     0.11     5.06 1.00
## sds(sageeduchighschoolorless_1)     1.29      1.16     0.06     4.19 1.00
## sds(sigma_sage_1)                   1.14      0.88     0.07     3.30 1.00
##                                 Bulk_ESS Tail_ESS
## sds(sageeduc1yearofcollege_1)       2623     2568
## sds(sageeduc2yearsofcollege_1)      2025     2283
## sds(sageeduc4yearsofcollege_1)      1583     2159
## sds(sageeduc5Pyearsofcollege_1)     1896     1219
## sds(sageeduchighschoolorless_1)     2372     2386
## sds(sigma_sage_1)                   1392     1883
## 
## Multilevel Hyperparameters:
## ~degfield_branch (Number of levels: 5) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.39      0.41     0.01     1.41 1.00     2495     2007
## sd(sigma_Intercept)     0.13      0.15     0.00     0.51 1.00     1812     2667
## 
## ~degfield_branch:income_brackets (Number of levels: 52) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.16      0.11     0.01     0.42 1.00     1682     1951
## 
## ~degfield_branch:occ_category (Number of levels: 24) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.36      0.20     0.04     0.81 1.00     1498     1385
## 
## ~degfield_branch:region_birth (Number of levels: 47) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.13      0.10     0.01     0.37 1.00     2055     2503
## 
## ~educ (Number of levels: 5) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.43      0.42     0.01     1.58 1.00     2863     2551
## sd(sigma_Intercept)     0.11      0.13     0.00     0.45 1.00     1866     2557
## 
## ~educ:degfield_branch (Number of levels: 17) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.28      0.22     0.01     0.80 1.00     1537     2010
## 
## ~educ:hispan (Number of levels: 10) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.33      0.26     0.01     1.00 1.00     1972     2508
## 
## ~educ:income_brackets (Number of levels: 53) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.14      0.10     0.01     0.37 1.00     1699     2007
## 
## ~educ:marst (Number of levels: 15) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.23      0.19     0.01     0.68 1.00     1368     2369
## 
## ~educ:occ_category (Number of levels: 28) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.28      0.17     0.02     0.67 1.00     1560     2061
## 
## ~educ:race (Number of levels: 20) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.31      0.20     0.02     0.75 1.00     1191     1967
## 
## ~educ:region_birth (Number of levels: 48) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.11      0.09     0.00     0.33 1.00     2069     1655
## 
## ~educ:region_residence (Number of levels: 43) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.13      0.10     0.00     0.37 1.00     1777     2289
## 
## ~female:degfield_branch (Number of levels: 10) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.23      0.20     0.01     0.72 1.00     2170     1890
## 
## ~female:educ (Number of levels: 10) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.26      0.20     0.01     0.78 1.00     1910     2132
## 
## ~female:hispan (Number of levels: 4) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.85      1.00     0.02     3.41 1.00     1631     1540
## 
## ~female:income_brackets (Number of levels: 22) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.19      0.13     0.01     0.51 1.00     1551     2248
## 
## ~female:marst (Number of levels: 6) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.37      0.40     0.01     1.45 1.00     1818     1726
## 
## ~female:occ_category (Number of levels: 12) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.27      0.25     0.01     0.94 1.00     2019     2098
## 
## ~female:race (Number of levels: 8) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.41      0.33     0.02     1.22 1.00     1407     1874
## 
## ~female:region_birth (Number of levels: 20) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.12      0.09     0.00     0.35 1.00     2523     2453
## 
## ~female:region_residence (Number of levels: 18) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.14      0.11     0.00     0.42 1.00     2679     2459
## 
## ~hispan:degfield_branch (Number of levels: 10) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.23      0.21     0.01     0.80 1.00     2628     1960
## 
## ~hispan:income_brackets (Number of levels: 22) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.15      0.11     0.01     0.43 1.00     2413     2571
## 
## ~hispan:marst (Number of levels: 6) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.47      0.46     0.02     1.64 1.00     2343     2559
## 
## ~hispan:occ_category (Number of levels: 12) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.32      0.27     0.01     0.96 1.00     1866     1821
## 
## ~hispan:region_birth (Number of levels: 19) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.14      0.11     0.01     0.42 1.00     2942     2314
## 
## ~hispan:region_residence (Number of levels: 18) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.26      0.18     0.01     0.68 1.00     1671     1833
## 
## ~income_brackets (Number of levels: 11) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.16      0.13     0.01     0.49 1.00     2596     2346
## sd(sigma_Intercept)     0.08      0.06     0.00     0.23 1.00     1850     2090
## 
## ~marst (Number of levels: 3) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.81      0.86     0.03     3.13 1.00     3015     2144
## sd(sigma_Intercept)     0.57      0.60     0.08     2.41 1.00     2125     1688
## 
## ~marst:degfield_branch (Number of levels: 15) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.17      0.14     0.01     0.52 1.00     2088     2167
## 
## ~marst:income_brackets (Number of levels: 33) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.15      0.11     0.01     0.41 1.00     1963     2235
## 
## ~marst:occ_category (Number of levels: 17) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.18      0.16     0.01     0.58 1.00     2181     2030
## 
## ~marst:region_birth (Number of levels: 30) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.13      0.10     0.01     0.37 1.00     1880     2035
## 
## ~occ_category (Number of levels: 6) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.40      0.37     0.01     1.34 1.00     2860     2434
## sd(sigma_Intercept)     0.20      0.19     0.01     0.69 1.01     1394     1796
## 
## ~occ_category:income_brackets (Number of levels: 48) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.16      0.12     0.01     0.43 1.00     1761     1907
## 
## ~occ_category:region_birth (Number of levels: 46) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.11      0.09     0.00     0.32 1.00     2029     1729
## 
## ~race (Number of levels: 4) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.50      0.53     0.01     2.04 1.00     2554     2168
## sd(sigma_Intercept)     0.17      0.24     0.01     0.79 1.00     1947     2370
## 
## ~race:degfield_branch (Number of levels: 20) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.17      0.13     0.01     0.51 1.00     2331     2453
## 
## ~race:hispan (Number of levels: 8) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.26      0.27     0.01     0.98 1.00     2428     2607
## 
## ~race:income_brackets (Number of levels: 44) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.20      0.14     0.01     0.53 1.00     1440     1826
## 
## ~race:marst (Number of levels: 12) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.33      0.26     0.01     0.97 1.00     1438     1849
## 
## ~race:occ_category (Number of levels: 20) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.31      0.23     0.02     0.87 1.00     1528     2533
## 
## ~race:region_birth (Number of levels: 34) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.14      0.10     0.01     0.37 1.00     2495     2492
## 
## ~race:region_residence (Number of levels: 33) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.16      0.11     0.01     0.42 1.00     2303     2563
## 
## ~region_birth (Number of levels: 10) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.16      0.14     0.01     0.53 1.00     2482     1973
## sd(sigma_Intercept)     0.10      0.08     0.00     0.28 1.00     1801     2580
## 
## ~region_birth:income_brackets (Number of levels: 104) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.31      0.16     0.02     0.62 1.00      752     1376
## 
## ~region_residence (Number of levels: 9) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.19      0.16     0.01     0.61 1.00     2868     2362
## sd(sigma_Intercept)     0.12      0.09     0.00     0.34 1.00     1436     1850
## 
## ~region_residence:degfield_branch (Number of levels: 43) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.20      0.14     0.01     0.51 1.00     1139     1648
## 
## ~region_residence:income_brackets (Number of levels: 96) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.25      0.15     0.01     0.56 1.00      801     1665
## 
## ~region_residence:marst (Number of levels: 27) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.17      0.12     0.01     0.46 1.00     1571     2026
## 
## ~region_residence:occ_category (Number of levels: 42) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.16      0.12     0.01     0.45 1.00     1835     1807
## 
## ~region_residence:region_birth (Number of levels: 66) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.22      0.15     0.01     0.55 1.00      936     1752
## 
## Regression Coefficients:
##                             Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
## Intercept                       7.24      1.34     4.57     9.96 1.00     1996
## sigma_Intercept                 0.35      0.51    -0.68     1.41 1.00     1567
## femaleTRUE                      0.06      1.34    -3.03     2.56 1.00     1818
## hispanTRUE                     -0.10      1.45    -3.18     2.77 1.00     1820
## sigma_hispanTRUE               -0.09      0.17    -0.44     0.24 1.00     2803
## sigma_femaleTRUE               -0.21      0.11    -0.43     0.00 1.00     2035
## sage:educ1yearofcollege_1       3.09      5.89    -9.10    15.33 1.00     2390
## sage:educ2yearsofcollege_1      0.26      4.83   -10.49     9.65 1.00     2201
## sage:educ4yearsofcollege_1      2.35      5.25    -9.67    11.55 1.01     1468
## sage:educ5Pyearsofcollege_1     2.74      4.68    -7.73    12.21 1.00     2654
## sage:educhighschoolorless_1    -0.18      3.90    -9.18     6.73 1.00     2214
## sigma_sage_1                    0.53      2.62    -4.32     6.49 1.00     1967
##                             Tail_ESS
## Intercept                       1393
## sigma_Intercept                 1254
## femaleTRUE                      1180
## hispanTRUE                      1308
## sigma_hispanTRUE                2277
## sigma_femaleTRUE                2636
## sage:educ1yearofcollege_1       2177
## sage:educ2yearsofcollege_1      1749
## sage:educ4yearsofcollege_1      1239
## sage:educ5Pyearsofcollege_1     2229
## sage:educhighschoolorless_1     1854
## sigma_sage_1                    2108
## 
## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<pre class="r"><code>pp_check(brm_1)</code></pre>
<p><img src="05_tutorial_files/figure-html/unnamed-chunk-6-1.svg" width="768" /></p>
<p>Many large sd estimates for the random intercepts but most CI bounds,
especially for interactions, either include 0 or approach it, indicating
that the data are not large enough to estimate interaction effects.</p>
</div>
<div id="without-interactions" class="section level3" number="3.1.2">
<h3><span class="header-section-number">3.1.2</span> Without
interactions</h3>
<pre class="r"><code>brm_2 &lt;- brm(bf(wordsum ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth)  + female + (1 | income_brackets),
                   sigma ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth)  + female + (1 | income_brackets)
                   ),
    seed = 14,
    chains = 4,
    file = &quot;data/brms/wordsum/sb/brm_2&quot;,
    data = sb_data) %&gt;%
  add_criterion(&quot;loo&quot;)




brm_2</code></pre>
<pre><code>## Warning: There were 47 divergent transitions after warmup. Increasing
## adapt_delta above 0.8 may help. See
## http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</code></pre>
<pre><code>##  Family: gaussian 
##   Links: mu = identity; sigma = log 
## Formula: wordsum ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth) + female + (1 | income_brackets) 
##          sigma ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth) + female + (1 | income_brackets)
##    Data: sb_data (Number of observations: 478) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Smoothing Spline Hyperparameters:
##                   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sds(sage_1)           1.22      1.01     0.05     3.71 1.00     1322     2045
## sds(sigma_sage_1)     0.63      0.58     0.02     2.13 1.00     1306     1634
## 
## Multilevel Hyperparameters:
## ~degfield_branch (Number of levels: 5) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.56      0.37     0.15     1.52 1.00     1497     1292
## sd(sigma_Intercept)     0.09      0.09     0.00     0.32 1.00     1985     2310
## 
## ~educ (Number of levels: 5) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.55      0.35     0.14     1.49 1.00     1449     1507
## sd(sigma_Intercept)     0.06      0.08     0.00     0.25 1.00     2382     2210
## 
## ~income_brackets (Number of levels: 11) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.18      0.13     0.01     0.48 1.00     1244     1641
## sd(sigma_Intercept)     0.06      0.05     0.00     0.19 1.00     1873     1847
## 
## ~marst (Number of levels: 3) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.74      0.69     0.12     2.67 1.00     1621     1993
## sd(sigma_Intercept)     0.51      0.49     0.10     1.90 1.00     1294     1234
## 
## ~occ_category (Number of levels: 6) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.39      0.33     0.01     1.23 1.01      858     1419
## sd(sigma_Intercept)     0.12      0.12     0.00     0.42 1.00     1583     1687
## 
## ~race (Number of levels: 4) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.35      0.35     0.02     1.27 1.00     1157     1486
## sd(sigma_Intercept)     0.13      0.16     0.00     0.56 1.00     1164     1778
## 
## ~region_birth (Number of levels: 10) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.12      0.10     0.00     0.36 1.00     1893     1829
## sd(sigma_Intercept)     0.08      0.06     0.00     0.23 1.00     1320     1922
## 
## ~region_residence (Number of levels: 9) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.13      0.10     0.00     0.39 1.00     1844     2167
## sd(sigma_Intercept)     0.08      0.06     0.00     0.24 1.00     1508     1894
## 
## Regression Coefficients:
##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept            7.41      0.72     5.87     8.81 1.00     1810     2104
## sigma_Intercept      0.50      0.39    -0.29     1.39 1.00     1174      957
## hispanTRUE          -0.29      0.21    -0.73     0.13 1.00     4984     2539
## femaleTRUE          -0.11      0.16    -0.43     0.21 1.00     5674     2963
## sigma_hispanTRUE     0.03      0.11    -0.18     0.24 1.00     5495     2900
## sigma_femaleTRUE    -0.11      0.08    -0.26     0.03 1.00     5576     2875
## sage_1               0.03      3.37    -8.40     4.94 1.00     1676     1315
## sigma_sage_1        -0.08      1.55    -3.04     3.58 1.00     2166     1738
## 
## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<pre class="r"><code>pp_check(brm_2)</code></pre>
<p><img src="05_tutorial_files/figure-html/unnamed-chunk-7-1.svg" width="768" /></p>
<pre class="r"><code>loo_compare(brm_1, brm_2)</code></pre>
<pre><code>##       elpd_diff se_diff
## brm_2   0.0       0.0  
## brm_1 -12.8       7.4</code></pre>
<p>The model without interactions fits slightly better, probably because
any predictions based on the interactions are way too uncertain to make
a difference in average prediction accuracy. The divergent transitions
are concerning, but most of them are gone when modelling the outcome as
ordinal or when boosting the adapt_delta parameter.</p>
<div id="boosted-n-of-iterations-and-adapt_delta" class="section level4"
number="3.1.2.1">
<h4><span class="header-section-number">3.1.2.1</span> Boosted n of
iterations and adapt_delta</h4>
<pre class="r"><code>brm_2_boosted &lt;- brm(bf(wordsum ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth)  + female + (1 | income_brackets),
                   sigma ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth)  + female + (1 | income_brackets)
                   ),
    seed = 14,
    chains = 4,
    iter = 5000,
    control = list(adapt_delta = 0.999),
    file = &quot;data/brms/wordsum/sb/brm_2_boosted&quot;,
    data = sb_data) %&gt;%
  add_criterion(&quot;loo&quot;)


brm_2_boosted</code></pre>
<pre><code>##  Family: gaussian 
##   Links: mu = identity; sigma = log 
## Formula: wordsum ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth) + female + (1 | income_brackets) 
##          sigma ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth) + female + (1 | income_brackets)
##    Data: sb_data (Number of observations: 478) 
##   Draws: 4 chains, each with iter = 5000; warmup = 2500; thin = 1;
##          total post-warmup draws = 10000
## 
## Smoothing Spline Hyperparameters:
##                   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sds(sage_1)           1.18      1.04     0.04     3.81 1.00     3265     4625
## sds(sigma_sage_1)     0.64      0.60     0.02     2.22 1.00     2566     3452
## 
## Multilevel Hyperparameters:
## ~degfield_branch (Number of levels: 5) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.54      0.35     0.13     1.49 1.00     3369     3707
## sd(sigma_Intercept)     0.09      0.10     0.00     0.32 1.00     4610     4868
## 
## ~educ (Number of levels: 5) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.55      0.36     0.13     1.48 1.00     3394     4123
## sd(sigma_Intercept)     0.06      0.08     0.00     0.26 1.00     5770     5598
## 
## ~income_brackets (Number of levels: 11) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.18      0.13     0.01     0.47 1.00     3440     4757
## sd(sigma_Intercept)     0.06      0.05     0.00     0.18 1.00     4593     4442
## 
## ~marst (Number of levels: 3) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.73      0.70     0.13     2.66 1.00     3859     5866
## sd(sigma_Intercept)     0.53      0.56     0.10     2.16 1.00     3222     5312
## 
## ~occ_category (Number of levels: 6) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.40      0.34     0.02     1.24 1.00     2297     3554
## sd(sigma_Intercept)     0.11      0.11     0.00     0.40 1.00     3996     4522
## 
## ~race (Number of levels: 4) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.34      0.34     0.02     1.22 1.00     3739     4318
## sd(sigma_Intercept)     0.13      0.17     0.00     0.57 1.00     4046     5610
## 
## ~region_birth (Number of levels: 10) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.11      0.09     0.00     0.35 1.00     4933     4409
## sd(sigma_Intercept)     0.08      0.06     0.00     0.23 1.00     3056     3916
## 
## ~region_residence (Number of levels: 9) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.13      0.11     0.00     0.39 1.00     4399     5168
## sd(sigma_Intercept)     0.08      0.06     0.00     0.24 1.00     2967     3920
## 
## Regression Coefficients:
##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept            7.43      0.73     5.97     8.93 1.00     4622     4784
## sigma_Intercept      0.49      0.42    -0.38     1.37 1.00     4041     3735
## hispanTRUE          -0.29      0.22    -0.72     0.14 1.00    12406     7673
## femaleTRUE          -0.11      0.16    -0.43     0.21 1.00    11217     7293
## sigma_hispanTRUE     0.03      0.11    -0.18     0.24 1.00    12968     7709
## sigma_femaleTRUE    -0.11      0.08    -0.26     0.04 1.00    11731     6726
## sage_1               0.13      3.44    -9.04     4.88 1.00     4346     4132
## sigma_sage_1        -0.10      1.66    -3.26     3.73 1.00     4384     4082
## 
## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<pre class="r"><code>pp_check(brm_2_boosted)</code></pre>
<p><img src="05_tutorial_files/figure-html/unnamed-chunk-8-1.svg" width="768" /></p>
<pre class="r"><code>loo_compare(brm_2, brm_2_boosted)</code></pre>
<pre><code>##               elpd_diff se_diff
## brm_2          0.0       0.0   
## brm_2_boosted -0.8       0.3</code></pre>
<p>No difference between the model with 47/4000 divergent transitions
and the same model with no divergent transitions.</p>
</div>
</div>
<div id="censored-normal-model" class="section level3" number="3.1.3">
<h3><span class="header-section-number">3.1.3</span> Censored normal
model</h3>
<pre class="r"><code>brm_3 &lt;- brm(bf(wordsum | cens(censoring)  ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth)  + female + (1 | income_brackets),
                sigma ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth)  + female + (1 | income_brackets)
                   ),
    seed = 14,
    chains = 4,
    file = &quot;data/brms/wordsum/sb/brm_3&quot;,
    data = sb_data) %&gt;%
  add_criterion(&quot;loo&quot;)

brm_3</code></pre>
<pre><code>## Warning: There were 38 divergent transitions after warmup. Increasing
## adapt_delta above 0.8 may help. See
## http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</code></pre>
<pre><code>##  Family: gaussian 
##   Links: mu = identity; sigma = log 
## Formula: wordsum | cens(censoring) ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth) + female + (1 | income_brackets) 
##          sigma ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth) + female + (1 | income_brackets)
##    Data: sb_data (Number of observations: 478) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Smoothing Spline Hyperparameters:
##                   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sds(sage_1)           1.04      0.91     0.04     3.34 1.00     2095     2201
## sds(sigma_sage_1)     0.86      0.72     0.03     2.68 1.00     1139     1981
## 
## Multilevel Hyperparameters:
## ~degfield_branch (Number of levels: 5) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.61      0.39     0.16     1.59 1.00     1644     1976
## sd(sigma_Intercept)     0.09      0.11     0.00     0.36 1.00     2054     2337
## 
## ~educ (Number of levels: 5) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.64      0.43     0.20     1.65 1.00     1419     2295
## sd(sigma_Intercept)     0.10      0.11     0.00     0.38 1.00     1639     2133
## 
## ~income_brackets (Number of levels: 11) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.21      0.14     0.01     0.55 1.00     1101     1947
## sd(sigma_Intercept)     0.09      0.06     0.00     0.23 1.00     1451     1824
## 
## ~marst (Number of levels: 3) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.71      0.68     0.09     2.62 1.00     1518     1568
## sd(sigma_Intercept)     0.55      0.51     0.11     2.02 1.00     1913     2206
## 
## ~occ_category (Number of levels: 6) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.50      0.39     0.03     1.46 1.00     1277     1623
## sd(sigma_Intercept)     0.17      0.15     0.01     0.55 1.00     1276     1705
## 
## ~race (Number of levels: 4) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.30      0.32     0.01     1.17 1.00     1377     1798
## sd(sigma_Intercept)     0.14      0.18     0.00     0.63 1.00     1650     1880
## 
## ~region_birth (Number of levels: 10) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.12      0.10     0.00     0.37 1.00     2083     2200
## sd(sigma_Intercept)     0.16      0.08     0.02     0.35 1.00     1281      952
## 
## ~region_residence (Number of levels: 9) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.15      0.12     0.01     0.44 1.00     1810     2395
## sd(sigma_Intercept)     0.18      0.10     0.03     0.42 1.00     1137     1310
## 
## Regression Coefficients:
##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept            7.48      0.74     5.96     8.95 1.00     2118     2214
## sigma_Intercept      0.60      0.42    -0.26     1.51 1.00     1770     1517
## hispanTRUE          -0.25      0.23    -0.69     0.20 1.00     5296     2988
## femaleTRUE          -0.16      0.17    -0.50     0.17 1.00     4249     2906
## sigma_hispanTRUE     0.01      0.12    -0.21     0.24 1.00     5020     2543
## sigma_femaleTRUE    -0.17      0.08    -0.32    -0.01 1.00     5658     3332
## sage_1               0.80      2.95    -6.59     5.29 1.00     2005     2327
## sigma_sage_1         0.31      1.95    -3.63     4.63 1.00     2139     1932
## 
## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<pre class="r"><code>pp_check(brm_3)</code></pre>
<pre><code>## Warning: Censored responses are not shown in &#39;pp_check&#39;.</code></pre>
<p><img src="05_tutorial_files/figure-html/unnamed-chunk-9-1.svg" width="768" /></p>
<pre class="r"><code>loo_compare(brm_1, brm_2, brm_3)</code></pre>
<pre><code>## Warning: Not all models have the same y variable. (&#39;yhash&#39; attributes do not
## match)</code></pre>
<pre><code>##       elpd_diff se_diff
## brm_2   0.0       0.0  
## brm_3  -0.3       4.2  
## brm_1 -12.8       7.4</code></pre>
<p>The censoring does not improve model fit. This model results in
slightly larger sds but they’re also associated with larger errors.</p>
</div>
<div id="ordinal-model" class="section level3" number="3.1.4">
<h3><span class="header-section-number">3.1.4</span> Ordinal model</h3>
<pre class="r"><code>brm_4 &lt;- brm(bf(wordsum_ordinal ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth)  + female + (1 | income_brackets),
                disc ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth)  + female + (1 | income_brackets)
                   ),
    seed = 14,
    chains = 4,
    family = cumulative(),
    file = &quot;data/brms/wordsum/sb/brm_4&quot;,
    data = sb_data) %&gt;%
  add_criterion(&quot;loo&quot;)

brm_4</code></pre>
<pre><code>## Warning: There were 3 divergent transitions after warmup. Increasing
## adapt_delta above 0.8 may help. See
## http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</code></pre>
<pre><code>##  Family: cumulative 
##   Links: mu = logit; disc = log 
## Formula: wordsum_ordinal ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth) + female + (1 | income_brackets) 
##          disc ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth) + female + (1 | income_brackets)
##    Data: sb_data (Number of observations: 478) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Smoothing Spline Hyperparameters:
##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sds(sage_1)          1.51      1.46     0.04     5.26 1.00     2077     2214
## sds(disc_sage_1)     0.78      0.67     0.03     2.53 1.00     1785     2559
## 
## Multilevel Hyperparameters:
## ~degfield_branch (Number of levels: 5) 
##                    Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)          1.14      0.77     0.27     3.07 1.00     1594     1964
## sd(disc_Intercept)     0.10      0.11     0.00     0.38 1.00     2324     2503
## 
## ~educ (Number of levels: 5) 
##                    Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)          1.24      0.85     0.33     3.44 1.00     1584     2237
## sd(disc_Intercept)     0.12      0.14     0.00     0.44 1.00     1742     2092
## 
## ~income_brackets (Number of levels: 11) 
##                    Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)          0.44      0.31     0.03     1.20 1.00     1217     1926
## sd(disc_Intercept)     0.09      0.07     0.00     0.25 1.01     1649     2407
## 
## ~marst (Number of levels: 3) 
##                    Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)          1.35      1.31     0.13     4.86 1.00     1783     1809
## sd(disc_Intercept)     0.60      0.57     0.12     2.18 1.00     2298     2636
## 
## ~occ_category (Number of levels: 6) 
##                    Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)          0.86      0.76     0.05     2.73 1.00     1269     1736
## sd(disc_Intercept)     0.18      0.17     0.01     0.61 1.00     1648     2201
## 
## ~race (Number of levels: 4) 
##                    Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)          0.52      0.60     0.02     2.10 1.00     1467     2016
## sd(disc_Intercept)     0.16      0.19     0.00     0.66 1.00     1831     2069
## 
## ~region_birth (Number of levels: 10) 
##                    Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)          0.24      0.21     0.01     0.78 1.00     1974     2386
## sd(disc_Intercept)     0.16      0.09     0.01     0.36 1.00     1242     1967
## 
## ~region_residence (Number of levels: 9) 
##                    Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)          0.26      0.23     0.01     0.85 1.00     1610     2369
## sd(disc_Intercept)     0.22      0.12     0.03     0.50 1.00     1257     1588
## 
## Regression Coefficients:
##                 Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept[1]      -12.49      4.52   -23.24    -5.92 1.00     1283     1338
## Intercept[2]       -9.88      3.36   -18.14    -4.73 1.00     1245     1692
## Intercept[3]       -7.74      2.67   -14.12    -3.60 1.00     1217     1474
## Intercept[4]       -6.58      2.35   -12.07    -2.79 1.00     1268     1603
## Intercept[5]       -4.39      1.87    -8.65    -1.17 1.00     1451     1636
## Intercept[6]       -1.89      1.45    -4.85     0.96 1.00     2015     2100
## Intercept[7]        0.05      1.32    -2.23     2.95 1.00     3029     2936
## Intercept[8]        1.54      1.35    -0.62     4.62 1.00     3408     3573
## Intercept[9]        3.42      1.54     1.02     7.00 1.00     2388     3286
## Intercept[10]       6.15      2.03     2.93    10.83 1.00     1616     2540
## disc_Intercept     -0.56      0.46    -1.44     0.37 1.00     2083     2536
## hispanTRUE         -0.46      0.45    -1.42     0.37 1.00     4027     2468
## femaleTRUE         -0.28      0.33    -1.00     0.35 1.00     3558     2383
## disc_hispanTRUE    -0.01      0.14    -0.28     0.25 1.00     7278     2903
## disc_femaleTRUE     0.19      0.10    -0.00     0.38 1.00     7570     2777
## sage_1              2.05      5.44   -12.13    10.34 1.00     1895     1792
## disc_sage_1        -0.01      1.91    -4.53     3.47 1.00     3143     2227
## 
## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<pre class="r"><code>pp_check(brm_4)</code></pre>
<p><img src="05_tutorial_files/figure-html/unnamed-chunk-10-1.svg" width="768" /></p>
<pre class="r"><code>loo_compare(brm_1, brm_2, brm_3, brm_4)</code></pre>
<pre><code>## Warning: Not all models have the same y variable. (&#39;yhash&#39; attributes do not
## match)</code></pre>
<pre><code>##       elpd_diff se_diff
## brm_4   0.0       0.0  
## brm_2 -19.0       5.8  
## brm_3 -19.3       3.9  
## brm_1 -31.8       8.8</code></pre>
<p>The ordinal model fits the data better and has only 3 divergent
transitions, probably because it accounts for the discrete and bounded
nature of the outcome, but we stick with normal because it does not
matter for the final MRP results (see below).</p>
</div>
<div id="negative-binomial-model" class="section level3" number="3.1.5">
<h3><span class="header-section-number">3.1.5</span> Negative binomial
model</h3>
<pre class="r"><code>brm_5 &lt;- brm(bf(wordsum ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth)  + female + (1 | income_brackets),
                   shape ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth)  + female + (1 | income_brackets)
                   ),
    seed = 14,
    chains = 4,
    family = negbinomial(),
    file = &quot;data/brms/wordsum/sb/brm_5&quot;,
    data = sb_data) %&gt;%
  add_criterion(&quot;loo&quot;)

brm_5</code></pre>
<pre><code>## Warning: Parts of the model have not converged (some Rhats are &gt; 1.05). Be
## careful when analysing the results! We recommend running more iterations and/or
## setting stronger priors.</code></pre>
<pre><code>##  Family: negbinomial 
##   Links: mu = log; shape = log 
## Formula: wordsum ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth) + female + (1 | income_brackets) 
##          shape ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth) + female + (1 | income_brackets)
##    Data: sb_data (Number of observations: 478) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Smoothing Spline Hyperparameters:
##                   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sds(sage_1)           0.08      0.07     0.01     0.21 3.33        4       11
## sds(shape_sage_1)     2.78      2.22     0.25     6.08 3.29        4       16
## 
## Multilevel Hyperparameters:
## ~degfield_branch (Number of levels: 5) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.05      0.03     0.01     0.10 2.77        5       39
## sd(shape_Intercept)     2.19      0.56     1.51     3.06 3.19        5       13
## 
## ~educ (Number of levels: 5) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.06      0.06     0.01     0.17 3.32        4       11
## sd(shape_Intercept)     1.72      0.98     0.27     3.20 2.88        5       12
## 
## ~income_brackets (Number of levels: 11) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.02      0.01     0.00     0.04 3.35        4       11
## sd(shape_Intercept)     0.67      0.50     0.17     1.49 3.21        4       12
## 
## ~marst (Number of levels: 3) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.08      0.02     0.04     0.12 3.25        4       16
## sd(shape_Intercept)     0.83      0.52     0.12     1.57 2.70        5       17
## 
## ~occ_category (Number of levels: 6) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.02      0.01     0.02     0.05 3.17        5       11
## sd(shape_Intercept)     1.82      1.03     0.55     3.46 2.92        5       19
## 
## ~race (Number of levels: 4) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.03      0.02     0.00     0.06 2.93        5       29
## sd(shape_Intercept)     2.42      0.91     1.17     3.77 3.12        5       15
## 
## ~region_birth (Number of levels: 10) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.02      0.01     0.00     0.05 3.11        5       13
## sd(shape_Intercept)     1.56      1.39     0.22     3.95 4.22        4       12
## 
## ~region_residence (Number of levels: 9) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.02      0.02     0.01     0.05 2.55        5       18
## sd(shape_Intercept)     1.39      1.16     0.19     3.42 4.09        4       11
## 
## Regression Coefficients:
##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept            2.02      0.05     1.95     2.11 3.24        4       11
## shape_Intercept     16.80      5.18     9.15    22.52 3.35        4       16
## hispanTRUE          -0.13      0.06    -0.24    -0.06 3.08        5       12
## femaleTRUE          -0.03      0.03    -0.11     0.00 3.26        4       11
## shape_hispanTRUE    -1.57      3.64    -6.27     4.68 3.17        4       23
## shape_femaleTRUE    -0.57      4.53    -5.19     7.55 3.09        5       18
## sage_1               0.43      0.24    -0.09     0.65 2.71        5       21
## shape_sage_1         2.87      8.74   -10.12    16.35 2.75        5       15
## 
## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>Does not converge.</p>
<pre class="r"><code>brm_5_v2 &lt;- brm(bf(wordsum ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth)  + female + (1 | income_brackets)),
    seed = 14,
    chains = 4,
    family = negbinomial(),
    file = &quot;data/brms/wordsum/sb/brm_5_v2&quot;,
    data = sb_data) %&gt;%
  add_criterion(&quot;loo&quot;)

brm_5_v2</code></pre>
<pre><code>## Warning: Parts of the model have not converged (some Rhats are &gt; 1.05). Be
## careful when analysing the results! We recommend running more iterations and/or
## setting stronger priors.</code></pre>
<pre><code>## Warning: There were 110 divergent transitions after warmup. Increasing
## adapt_delta above 0.8 may help. See
## http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</code></pre>
<pre><code>##  Family: negbinomial 
##   Links: mu = log; shape = identity 
## Formula: wordsum ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth) + female + (1 | income_brackets) 
##    Data: sb_data (Number of observations: 478) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Smoothing Spline Hyperparameters:
##             Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sds(sage_1)     0.22      0.05     0.17     0.30  Inf        4       NA
## 
## Multilevel Hyperparameters:
## ~degfield_branch (Number of levels: 5) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.06      0.05     0.00     0.14  Inf        4       NA
## 
## ~educ (Number of levels: 5) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.07      0.05     0.03     0.15  Inf        4       NA
## 
## ~income_brackets (Number of levels: 11) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.02      0.01     0.00     0.03  Inf        4       NA
## 
## ~marst (Number of levels: 3) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.06      0.03     0.04     0.11  Inf        4       NA
## 
## ~occ_category (Number of levels: 6) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.01      0.01     0.00     0.02  Inf        4       NA
## 
## ~race (Number of levels: 4) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.08      0.10     0.00     0.26  Inf        4       NA
## 
## ~region_birth (Number of levels: 10) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.02      0.02     0.01     0.04  Inf        4       NA
## 
## ~region_residence (Number of levels: 9) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.03      0.02     0.02     0.06  Inf        4       NA
## 
## Regression Coefficients:
##            Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept      1.99      0.11     1.83     2.12  Inf        4       NA
## hispanTRUE    -0.04      0.04    -0.09     0.00  Inf        4       NA
## femaleTRUE    -0.00      0.04    -0.05     0.04  Inf        4       NA
## sage_1        -0.27      0.44    -0.81     0.41  Inf        4       NA
## 
## Further Distributional Parameters:
##               Estimate        Est.Error        l-95% CI         u-95% CI Rhat
## shape 2927981250000.00 3338800168506.79 195235000000.00 8643200000000.00  Inf
##       Bulk_ESS Tail_ESS
## shape        4       NA
## 
## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<pre class="r"><code>brm_5_more_iters &lt;- brm(bf(wordsum ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth)  + female + (1 | income_brackets),
                   shape ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth)  + female + (1 | income_brackets)
                   ),
    seed = 14,
    chains = 4,
    iter = 5000,
    family = negbinomial(),
    file = &quot;data/brms/wordsum/sb/brm_5_more_iters&quot;,
    data = sb_data) %&gt;%
  add_criterion(&quot;loo&quot;)


brm_5_more_iters</code></pre>
<pre><code>## Warning: Parts of the model have not converged (some Rhats are &gt; 1.05). Be
## careful when analysing the results! We recommend running more iterations and/or
## setting stronger priors.</code></pre>
<pre><code>##  Family: negbinomial 
##   Links: mu = log; shape = log 
## Formula: wordsum ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth) + female + (1 | income_brackets) 
##          shape ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth) + female + (1 | income_brackets)
##    Data: sb_data (Number of observations: 478) 
##   Draws: 4 chains, each with iter = 5000; warmup = 2500; thin = 1;
##          total post-warmup draws = 10000
## 
## Smoothing Spline Hyperparameters:
##                   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sds(sage_1)           0.12      0.11     0.01     0.32 2.59        5       11
## sds(shape_sage_1)     3.06      2.26     0.25     7.20 2.44        5       14
## 
## Multilevel Hyperparameters:
## ~degfield_branch (Number of levels: 5) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.03      0.02     0.00     0.06 3.57        4       18
## sd(shape_Intercept)     1.70      0.93     0.07     3.05 2.42        5       14
## 
## ~educ (Number of levels: 5) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.06      0.06     0.01     0.19 3.56        4       14
## sd(shape_Intercept)     1.43      0.85     0.28     3.06 4.14        4       13
## 
## ~income_brackets (Number of levels: 11) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.02      0.01     0.00     0.03 2.81        5       26
## sd(shape_Intercept)     0.82      0.90     0.08     3.63 2.61        5       11
## 
## ~marst (Number of levels: 3) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.10      0.07     0.04     0.24 4.05        4       11
## sd(shape_Intercept)     1.25      0.85     0.11     3.28 2.39        5       11
## 
## ~occ_category (Number of levels: 6) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.03      0.01     0.02     0.05 2.65        5       11
## sd(shape_Intercept)     1.62      1.13     0.42     3.53 3.08        5       19
## 
## ~race (Number of levels: 4) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.04      0.02     0.00     0.07 2.91        5       11
## sd(shape_Intercept)     2.55      1.93     0.38     6.84 3.73        4       11
## 
## ~region_birth (Number of levels: 10) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.02      0.02     0.00     0.05 3.67        4       11
## sd(shape_Intercept)     1.14      1.20     0.20     3.32 2.45        5       12
## 
## ~region_residence (Number of levels: 9) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.03      0.01     0.01     0.05 3.09        5       11
## sd(shape_Intercept)     1.57      1.34     0.17     3.38 2.94        5       11
## 
## Regression Coefficients:
##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept            2.01      0.07     1.91     2.10 2.59        5       12
## shape_Intercept     16.14      4.50     9.17    21.75 2.92        5       11
## hispanTRUE          -0.05      0.05    -0.14     0.01 2.03        5       13
## femaleTRUE          -0.00      0.03    -0.07     0.05 2.59        5       19
## shape_hispanTRUE    -0.99      4.74    -6.48     7.03 2.91        5       41
## shape_femaleTRUE     2.58      5.22    -4.50    10.04 2.72        5       15
## sage_1               0.45      0.28    -0.12     0.80 3.44        4       11
## shape_sage_1         1.06      6.86   -10.47    10.38 2.88        5       13
## 
## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>Failed to converge even with more iterations.</p>
</div>
<div id="poisson-model" class="section level3" number="3.1.6">
<h3><span class="header-section-number">3.1.6</span> Poisson model</h3>
<pre class="r"><code>brm_6 &lt;- brm(bf(wordsum ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth)  + female + (1 | income_brackets)),
    seed = 14,
    chains = 4,
    iter = 2000,
    family = poisson(),
    file = &quot;data/brms/wordsum/sb/brm_6&quot;,
    data = sb_data) %&gt;%
  add_criterion(&quot;loo&quot;)

brm_6</code></pre>
<pre><code>## Warning: There were 77 divergent transitions after warmup. Increasing
## adapt_delta above 0.8 may help. See
## http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</code></pre>
<pre><code>##  Family: poisson 
##   Links: mu = log 
## Formula: wordsum ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth) + female + (1 | income_brackets) 
##    Data: sb_data (Number of observations: 478) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Smoothing Spline Hyperparameters:
##             Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sds(sage_1)     0.22      0.21     0.01     0.83 1.00      907      825
## 
## Multilevel Hyperparameters:
## ~degfield_branch (Number of levels: 5) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.06      0.06     0.00     0.21 1.00     1169     1487
## 
## ~educ (Number of levels: 5) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.05      0.06     0.00     0.22 1.00      999     1648
## 
## ~income_brackets (Number of levels: 11) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.02      0.02     0.00     0.07 1.00     1485     1912
## 
## ~marst (Number of levels: 3) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.15      0.19     0.01     0.79 1.00      532      259
## 
## ~occ_category (Number of levels: 6) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.04      0.04     0.00     0.16 1.00      830     1333
## 
## ~race (Number of levels: 4) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.05      0.06     0.00     0.22 1.01     1329     2293
## 
## ~region_birth (Number of levels: 10) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.02      0.02     0.00     0.07 1.00     1127      720
## 
## ~region_residence (Number of levels: 9) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.02      0.02     0.00     0.08 1.00     1944     1915
## 
## Regression Coefficients:
##            Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept      2.00      0.13     1.71     2.27 1.01      666      263
## hispanTRUE    -0.04      0.05    -0.14     0.07 1.00      864      334
## femaleTRUE    -0.01      0.03    -0.08     0.06 1.00     4606     2820
## sage_1         0.16      0.58    -1.25     1.24 1.00     1100      712
## 
## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<pre class="r"><code>loo_compare(brm_2, brm_4, brm_6)</code></pre>
<pre><code>## Warning: Not all models have the same y variable. (&#39;yhash&#39; attributes do not
## match)</code></pre>
<pre><code>##       elpd_diff se_diff
## brm_4    0.0       0.0 
## brm_2  -19.0       5.8 
## brm_6 -124.8      10.9</code></pre>
<p>Bad fit compared to normal and ordinal models.</p>
</div>
</div>
<div id="some-model-exploration" class="section level2" number="3.2">
<h2><span class="header-section-number">3.2</span> Some model
exploration</h2>
<div id="summary" class="section level3" number="3.2.1">
<h3><span class="header-section-number">3.2.1</span> Summary</h3>
<pre class="r"><code>brm_2</code></pre>
<pre><code>## Warning: There were 47 divergent transitions after warmup. Increasing
## adapt_delta above 0.8 may help. See
## http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</code></pre>
<pre><code>##  Family: gaussian 
##   Links: mu = identity; sigma = log 
## Formula: wordsum ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth) + female + (1 | income_brackets) 
##          sigma ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth) + female + (1 | income_brackets)
##    Data: sb_data (Number of observations: 478) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Smoothing Spline Hyperparameters:
##                   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sds(sage_1)           1.22      1.01     0.05     3.71 1.00     1322     2045
## sds(sigma_sage_1)     0.63      0.58     0.02     2.13 1.00     1306     1634
## 
## Multilevel Hyperparameters:
## ~degfield_branch (Number of levels: 5) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.56      0.37     0.15     1.52 1.00     1497     1292
## sd(sigma_Intercept)     0.09      0.09     0.00     0.32 1.00     1985     2310
## 
## ~educ (Number of levels: 5) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.55      0.35     0.14     1.49 1.00     1449     1507
## sd(sigma_Intercept)     0.06      0.08     0.00     0.25 1.00     2382     2210
## 
## ~income_brackets (Number of levels: 11) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.18      0.13     0.01     0.48 1.00     1244     1641
## sd(sigma_Intercept)     0.06      0.05     0.00     0.19 1.00     1873     1847
## 
## ~marst (Number of levels: 3) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.74      0.69     0.12     2.67 1.00     1621     1993
## sd(sigma_Intercept)     0.51      0.49     0.10     1.90 1.00     1294     1234
## 
## ~occ_category (Number of levels: 6) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.39      0.33     0.01     1.23 1.01      858     1419
## sd(sigma_Intercept)     0.12      0.12     0.00     0.42 1.00     1583     1687
## 
## ~race (Number of levels: 4) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.35      0.35     0.02     1.27 1.00     1157     1486
## sd(sigma_Intercept)     0.13      0.16     0.00     0.56 1.00     1164     1778
## 
## ~region_birth (Number of levels: 10) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.12      0.10     0.00     0.36 1.00     1893     1829
## sd(sigma_Intercept)     0.08      0.06     0.00     0.23 1.00     1320     1922
## 
## ~region_residence (Number of levels: 9) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.13      0.10     0.00     0.39 1.00     1844     2167
## sd(sigma_Intercept)     0.08      0.06     0.00     0.24 1.00     1508     1894
## 
## Regression Coefficients:
##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept            7.41      0.72     5.87     8.81 1.00     1810     2104
## sigma_Intercept      0.50      0.39    -0.29     1.39 1.00     1174      957
## hispanTRUE          -0.29      0.21    -0.73     0.13 1.00     4984     2539
## femaleTRUE          -0.11      0.16    -0.43     0.21 1.00     5674     2963
## sigma_hispanTRUE     0.03      0.11    -0.18     0.24 1.00     5495     2900
## sigma_femaleTRUE    -0.11      0.08    -0.26     0.03 1.00     5576     2875
## sage_1               0.03      3.37    -8.40     4.94 1.00     1676     1315
## sigma_sage_1        -0.08      1.55    -3.04     3.58 1.00     2166     1738
## 
## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>We can conclude that the 4 chains converged since the
<code>Rhat</code>s are consistently <span
class="math inline">\(&lt;=1.01\)</span>. We see that the sd
<code>Estimate</code>s of the random intercepts for <span
class="math inline">\(\sigma\)</span> are pretty small so we don’t
expect large variations in the residual variance depending on the
predictors. Larger sds can be observed for predicting <code>\mu</code>
(i.e., the actual Wordsum Scores). Males scored on average 0.11 higher
on Wordsum than females.</p>
</div>
<div id="check-model-fit" class="section level3" number="3.2.2">
<h3><span class="header-section-number">3.2.2</span> Check model
fit</h3>
<pre class="r"><code>pp_check(brm_2) </code></pre>
<p><img src="05_tutorial_files/figure-html/unnamed-chunk-16-1.svg" width="768" /></p>
<pre class="r"><code>y &lt;- sb_data$wordsum
yrep &lt;- posterior_predict(brm_2, newdata = sb_data)
ppc_pit_ecdf(y, yrep, prob = 0.99, plot_diff = FALSE)</code></pre>
<p><img src="05_tutorial_files/figure-html/unnamed-chunk-17-1.svg" width="768" /></p>
<pre class="r"><code>ppc_pit_ecdf(y, yrep, prob = 0.99, plot_diff = TRUE)</code></pre>
<p><img src="05_tutorial_files/figure-html/unnamed-chunk-17-2.svg" width="768" /></p>
<p>Some deviations at the right tail but not too bad.</p>
</div>
<div id="r2" class="section level3" number="3.2.3">
<h3><span class="header-section-number">3.2.3</span> R2</h3>
<pre class="r"><code>loo_R2(brm_2)</code></pre>
<pre><code>## Warning: Some Pareto k diagnostic values are too high. See help(&#39;pareto-k-diagnostic&#39;) for details.</code></pre>
<pre><code>##    Estimate Est.Error     Q2.5  Q97.5
## R2   0.0696   0.02918 0.009481 0.1256</code></pre>
<p>The included predictors do not explain a lot of variance (~7%), so
not a lot of adjustment can happen even if there are differences between
the sample and the population.</p>
</div>
</div>
</div>
<div id="poststratifcation" class="section level1" number="4">
<h1><span class="header-section-number">4</span> Poststratifcation</h1>
<p>This is the P part of MRP.</p>
<div
id="simulate-a-sample-with-the-same-joint-distribution-as-the-census"
class="section level2" number="4.1">
<h2><span class="header-section-number">4.1</span> Simulate a sample
with the same joint distribution as the census</h2>
<pre class="r"><code>set.seed(810)
sim_pop_sample &lt;- census_sb %&gt;% 
  sample_n(size = 100000, 
           weight = census_n, 
           replace = TRUE)</code></pre>
</div>
<div id="estimate-cft-20-r-for-those-simulated-participants"
class="section level2" number="4.2">
<h2><span class="header-section-number">4.2</span> Estimate CFT 20-R for
those simulated participants</h2>
<p>Now that we have a post-stratified sample, we can use
<em>tidybayes</em>’s <code>add_predicted_draws()</code> function to draw
1000 samples (i.e., Wordsum Scores) from the posterior for each one of
the 100000 simulated participants in <code>sim_pop_sample</code>:</p>
<pre class="r"><code>sim_pop_sample_with_draws &lt;- sim_pop_sample %&gt;%
  add_predicted_draws(brm_2, 
                      ndraws = 1000, 
                      seed = 810, 
                      allow_new_levels = TRUE) %&gt;% 
  mutate(.prediction = round(pmax(0, pmin(10, .prediction))))

data.table::fwrite(sim_pop_sample_with_draws, &quot;data/results/wordsum/sim_pop_sample_with_draws.csv.gz&quot;)</code></pre>
<p>This yields a dataframe in long format with 100000 (number of
simulated participants) * 1000 (number of draws from the posterior) =
100 million rows. <code>allow_new_levels = TRUE</code> is necessary for
estimating the outcome for combinations of the 11 predictors which do
not occur in the actual TL sample. This is inevitable in detailed enough
poststratification tables and was the case here as the
poststratification table we used had over 3 million subcategories/rows.
The <code>mutate()</code> call serves to set all predicted CFT 20-R 20-R
score scores which go below or above the scale limits (0 and 10,
respectively), to those scale limits.</p>
</div>
</div>
<div id="produce-norms" class="section level1" number="5">
<h1><span class="header-section-number">5</span> Produce norms</h1>
<div id="age-group-means-and-sds" class="section level2" number="5.1">
<h2><span class="header-section-number">5.1</span> Age group means and
SDs</h2>
<p>Here we aggregate the intelligence scores by age and compute the MRP
corrected means and SDs (+ their SEs) for each age group:</p>
<pre class="r"><code>sim_pop_sample_with_draws &lt;- data.table::fread(&quot;data/results/wordsum/sim_pop_sample_with_draws.csv.gz&quot;)

means_sds_and_ses_MRP &lt;- sim_pop_sample_with_draws %&gt;% 
  group_by(age, .draw) %&gt;% 
  summarise(mean_prediction = mean(.prediction), 
            sd_prediction = sd(.prediction)) %&gt;%
  group_by(age) %&gt;% 
  summarise(MRP_mean = mean(mean_prediction), 
            MRP_se_of_mean = sd(mean_prediction), 
            MRP_sd = sqrt(mean(sd_prediction^2)), 
            MRP_se_of_sd = sd(sd_prediction))
means_sds_and_ses_MRP %&gt;% head(14) %&gt;% kable(digits = 2) %&gt;% kable_styling(full_width = FALSE)</code></pre>
<table class="table" style="color: black; width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:right;">
age
</th>
<th style="text-align:right;">
MRP_mean
</th>
<th style="text-align:right;">
MRP_se_of_mean
</th>
<th style="text-align:right;">
MRP_sd
</th>
<th style="text-align:right;">
MRP_se_of_sd
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
6.62
</td>
<td style="text-align:right;">
0.21
</td>
<td style="text-align:right;">
1.66
</td>
<td style="text-align:right;">
0.15
</td>
</tr>
<tr>
<td style="text-align:right;">
22
</td>
<td style="text-align:right;">
6.66
</td>
<td style="text-align:right;">
0.20
</td>
<td style="text-align:right;">
1.68
</td>
<td style="text-align:right;">
0.14
</td>
</tr>
<tr>
<td style="text-align:right;">
23
</td>
<td style="text-align:right;">
6.70
</td>
<td style="text-align:right;">
0.18
</td>
<td style="text-align:right;">
1.70
</td>
<td style="text-align:right;">
0.13
</td>
</tr>
<tr>
<td style="text-align:right;">
24
</td>
<td style="text-align:right;">
6.74
</td>
<td style="text-align:right;">
0.17
</td>
<td style="text-align:right;">
1.71
</td>
<td style="text-align:right;">
0.12
</td>
</tr>
<tr>
<td style="text-align:right;">
25
</td>
<td style="text-align:right;">
6.76
</td>
<td style="text-align:right;">
0.16
</td>
<td style="text-align:right;">
1.73
</td>
<td style="text-align:right;">
0.11
</td>
</tr>
<tr>
<td style="text-align:right;">
26
</td>
<td style="text-align:right;">
6.76
</td>
<td style="text-align:right;">
0.16
</td>
<td style="text-align:right;">
1.76
</td>
<td style="text-align:right;">
0.11
</td>
</tr>
<tr>
<td style="text-align:right;">
27
</td>
<td style="text-align:right;">
6.75
</td>
<td style="text-align:right;">
0.15
</td>
<td style="text-align:right;">
1.78
</td>
<td style="text-align:right;">
0.11
</td>
</tr>
<tr>
<td style="text-align:right;">
28
</td>
<td style="text-align:right;">
6.78
</td>
<td style="text-align:right;">
0.15
</td>
<td style="text-align:right;">
1.78
</td>
<td style="text-align:right;">
0.10
</td>
</tr>
<tr>
<td style="text-align:right;">
29
</td>
<td style="text-align:right;">
6.77
</td>
<td style="text-align:right;">
0.15
</td>
<td style="text-align:right;">
1.82
</td>
<td style="text-align:right;">
0.11
</td>
</tr>
<tr>
<td style="text-align:right;">
30
</td>
<td style="text-align:right;">
6.79
</td>
<td style="text-align:right;">
0.14
</td>
<td style="text-align:right;">
1.83
</td>
<td style="text-align:right;">
0.11
</td>
</tr>
<tr>
<td style="text-align:right;">
31
</td>
<td style="text-align:right;">
6.79
</td>
<td style="text-align:right;">
0.14
</td>
<td style="text-align:right;">
1.84
</td>
<td style="text-align:right;">
0.10
</td>
</tr>
<tr>
<td style="text-align:right;">
32
</td>
<td style="text-align:right;">
6.81
</td>
<td style="text-align:right;">
0.14
</td>
<td style="text-align:right;">
1.85
</td>
<td style="text-align:right;">
0.10
</td>
</tr>
<tr>
<td style="text-align:right;">
33
</td>
<td style="text-align:right;">
6.80
</td>
<td style="text-align:right;">
0.15
</td>
<td style="text-align:right;">
1.85
</td>
<td style="text-align:right;">
0.10
</td>
</tr>
<tr>
<td style="text-align:right;">
34
</td>
<td style="text-align:right;">
6.83
</td>
<td style="text-align:right;">
0.14
</td>
<td style="text-align:right;">
1.84
</td>
<td style="text-align:right;">
0.10
</td>
</tr>
</tbody>
</table>
<p>This code chunk first aggregates by age and posterior draw (1000) to
compute the mean and SD of Wordsum estimates across the 100000 simulated
participants. Then it computes the means and SDs across the draws (which
form the MRP means and SDs for each age group) and the SDs of the means
and SDs calculated in the previous step, hence yielding the Bayesian SEs
of the MRP means and SDs, respectively.</p>
</div>
<div id="age-norm-tables" class="section level2" number="5.2">
<h2><span class="header-section-number">5.2</span> Age norm tables</h2>
<div id="linearly-transformed-iqs-t-scores" class="section level3"
number="5.2.1">
<h3><span class="header-section-number">5.2.1</span> Linearly
transformed IQs / T-scores</h3>
<p>Here we calculate linearly transformed IQs for all cft scores that
occur in the poststratified sample.</p>
<pre class="r"><code>iq &lt;- function(cft_score, mean, sd) {
  iq_score &lt;- ((cft_score - mean) / sd) * 15 + 100
  return(iq_score)
}

t &lt;- function(raw_score, mean, sd) {
  t_score_value &lt;- ((raw_score - mean) / sd) * 10 + 50
  return(t_score_value)
}

iqs_linear &lt;- sim_pop_sample_with_draws %&gt;% 
  left_join(select(means_sds_and_ses_MRP, c(MRP_mean, MRP_sd, age)), by = &quot;age&quot;) %&gt;%
  group_by(age) %&gt;% 
  mutate(wordsum_score = .prediction,
         MRP_IQ = iq(wordsum_score, MRP_mean, MRP_sd),
         MRP_T = t(wordsum_score, MRP_mean, MRP_sd)) %&gt;% 
  group_by(age, wordsum_score) %&gt;% 
  summarise(MRP_IQ = round(mean(MRP_IQ)))

iqs_linear %&gt;% head(14) %&gt;% kable %&gt;% kable_styling(full_width = FALSE)</code></pre>
<table class="table" style="color: black; width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:right;">
age
</th>
<th style="text-align:right;">
wordsum_score
</th>
<th style="text-align:right;">
MRP_IQ
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
40
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
49
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
58
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
67
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
76
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
85
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
94
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
103
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
113
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
122
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
131
</td>
</tr>
<tr>
<td style="text-align:right;">
22
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
41
</td>
</tr>
<tr>
<td style="text-align:right;">
22
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
49
</td>
</tr>
<tr>
<td style="text-align:right;">
22
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
58
</td>
</tr>
</tbody>
</table>
<p>Due to the left skewed distributions linear transformation probably
underestimates IQs at the lower tail.</p>
</div>
<div id="normalised-area-transformed-normal-rank-transformed-iqs"
class="section level3" number="5.2.2">
<h3><span class="header-section-number">5.2.2</span> Normalised (area
transformed / normal rank transformed) IQs</h3>
<pre class="r"><code>iqs_normalised &lt;- sim_pop_sample_with_draws  %&gt;% 
  mutate(wordsum_score = as.numeric(as.character(.prediction))) %&gt;%
  group_by(age, .draw) %&gt;%
  mutate(n = n(),
         normal_transformed_score = qnorm((rank(wordsum_score) - 0.5) / n)) %&gt;%
  mutate(iq_score = normal_transformed_score * 15 + 100,
         T_score = normal_transformed_score * 10 + 50) %&gt;%
  group_by(age, wordsum_score) %&gt;%
  summarise(MRP_IQ = round(mean(iq_score)),
            MRP_T = round(mean(T_score)))

iqs_normalised %&gt;% head(14) %&gt;% kable %&gt;% kable_styling(full_width = FALSE)</code></pre>
<table class="table" style="color: black; width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:right;">
age
</th>
<th style="text-align:right;">
wordsum_score
</th>
<th style="text-align:right;">
MRP_IQ
</th>
<th style="text-align:right;">
MRP_T
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
53
</td>
<td style="text-align:right;">
19
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
58
</td>
<td style="text-align:right;">
22
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
64
</td>
<td style="text-align:right;">
26
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
70
</td>
<td style="text-align:right;">
30
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
78
</td>
<td style="text-align:right;">
35
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
86
</td>
<td style="text-align:right;">
40
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
94
</td>
<td style="text-align:right;">
46
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
103
</td>
<td style="text-align:right;">
52
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
112
</td>
<td style="text-align:right;">
58
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
120
</td>
<td style="text-align:right;">
64
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
130
</td>
<td style="text-align:right;">
70
</td>
</tr>
<tr>
<td style="text-align:right;">
22
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
54
</td>
<td style="text-align:right;">
19
</td>
</tr>
<tr>
<td style="text-align:right;">
22
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
59
</td>
<td style="text-align:right;">
22
</td>
</tr>
<tr>
<td style="text-align:right;">
22
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
64
</td>
<td style="text-align:right;">
26
</td>
</tr>
</tbody>
</table>
</div>
<div id="percentile-based-scores" class="section level3" number="5.2.3">
<h3><span class="header-section-number">5.2.3</span> Percentile based
scores</h3>
<p>Like above but without converting the cumulative distribution
function values to standard Gaussian quantiles and then to IQs/Ts.</p>
<pre class="r"><code>percentiles &lt;- sim_pop_sample_with_draws  %&gt;% 
  mutate(wordsum_score = .prediction) %&gt;%
  group_by(age, .draw) %&gt;%
  mutate(n = n(),
         percentile = (rank(wordsum_score) - 0.5) / n) %&gt;%
  group_by(age, wordsum_score) %&gt;%
  summarise(MRP_percentile = mean(percentile))

percentiles %&gt;% head(14) %&gt;% kable %&gt;% kable_styling(full_width = FALSE)</code></pre>
<table class="table" style="color: black; width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:right;">
age
</th>
<th style="text-align:right;">
wordsum_score
</th>
<th style="text-align:right;">
MRP_percentile
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0012
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.0035
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0.0096
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
0.0265
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
0.0712
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
0.1728
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
0.3528
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
0.5822
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
0.7847
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
0.9104
</td>
</tr>
<tr>
<td style="text-align:right;">
21
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.9747
</td>
</tr>
<tr>
<td style="text-align:right;">
22
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0013
</td>
</tr>
<tr>
<td style="text-align:right;">
22
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.0038
</td>
</tr>
<tr>
<td style="text-align:right;">
22
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0.0099
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="additional-analyses-and-comparisons" class="section level1"
number="6">
<h1><span class="header-section-number">6</span> Additional analyses and
comparisons</h1>
<p>Here we use the home-made <code>age_norm_comparisons</code> function
to do some robustness checks and other analyses.</p>
<div id="mrp-vs-raw-vs-mr" class="section level2" number="6.1">
<h2><span class="header-section-number">6.1</span> MRP vs Raw vs MR</h2>
<pre class="r"><code>prediction_transform = list(
  function(x) round(pmax(0, pmin(10, x))) # for handling normal predictons (that go out of wordsum bounds)
)


sb_raw_vs_rpp_rp &lt;- age_norm_comparisons(
  brm_2,
  ps_table = census_sb, 
  RP = c(&quot;census&quot;, &quot;norming_sample&quot;),
  ps_variables = c(&quot;age&quot;, &quot;female&quot;, &quot;educ&quot;, &quot;income_brackets&quot;, &quot;race&quot;, &quot;hispan&quot;, &quot;region_residence&quot;, &quot;region_birth&quot;, &quot;degfield_branch&quot;, &quot;marst&quot;, &quot;occ_category&quot;), 
  sim_size = 100000,
  labels = c(labels = c(&quot;Raw&quot;, &quot;MRP&quot;, &quot;MR&quot;)),
   palette = c(
  &quot;#BC3C29FF&quot;,
  &quot;#0072B5FF&quot;,
  # &quot;#20854EFF&quot;,
  # &quot;#7876B1FF&quot;,
  # &quot;#6F99ADFF&quot;,
  &quot;#E18727FF&quot;
  # &quot;#FFDC91FF&quot;,
  # &quot;#EE4C97FF&quot;
),
  output_file = &quot;data/results/wordsum/sb_raw_vs_mrp_mr.rds&quot;
  )


sb_raw_vs_rpp_rp[-1]</code></pre>
<pre><code>## $overall_estimates
## # A tibble: 2 × 5
##    Mean SE_of_Mean    SD SE_of_SD Model    
##   &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;    
## 1  7.04     0.118   1.81   0.0878 RPP_brm_2
## 2  7.31     0.0760  1.78   0.0634 RP_brm_2 
## 
## $means_plot</code></pre>
<pre><code>## Warning: Removed 1 row containing missing values or values outside the scale range
## (`geom_segment()`).</code></pre>
<p><img src="05_tutorial_files/figure-html/unnamed-chunk-25-1.svg" width="768" /></p>
<pre><code>## 
## $SDs_plot</code></pre>
<pre><code>## Warning: Removed 1 row containing missing values or values outside the scale range
## (`geom_pointrange()`).</code></pre>
<pre><code>## Warning: Removed 46 rows containing missing values or values outside the scale range
## (`geom_segment()`).</code></pre>
<p><img src="05_tutorial_files/figure-html/unnamed-chunk-25-2.svg" width="768" /></p>
<pre><code>## 
## $SEs_plot</code></pre>
<pre><code>## Warning: Removed 1 row containing missing values or values outside the scale range
## (`geom_point()`).</code></pre>
<p><img src="05_tutorial_files/figure-html/unnamed-chunk-25-3.svg" width="768" /></p>
<p>As can be expected given the small associations between the
adjustment variables and the outcome, most of the adjustment to the age
group means were the result of the regularisation rather than the
poststratification. Nevertheless, poststratification led to a downward
adjustment of ~.3 points, indicating that Wordsum scores in this
Prolific sample are higher than in the broader US population.</p>
<div id="differences-in-iqs" class="section level3" number="6.1.1">
<h3><span class="header-section-number">6.1.1</span> Differences in
IQs</h3>
<pre class="r"><code>set.seed(810)

sim_norming_sample &lt;- sb_data %&gt;% 
  group_by(age, female, educ, income_brackets, race, hispan, region_residence, region_birth, degfield_branch, marst, occ_category) %&gt;% 
  summarise(sample_n = n()) %&gt;% 
  ungroup() %&gt;% 
  sample_n(size = 100000, 
           weight = sample_n, 
           replace = TRUE)


sim_norming_sample_with_draws &lt;- sim_norming_sample %&gt;%
  add_predicted_draws(brm_2, 
                      ndraws = 1000, 
                      seed = 810, 
                      allow_new_levels = TRUE) %&gt;% 
  mutate(.prediction = round(pmax(0, pmin(10, .prediction))))


RP_iqs_normalised &lt;- sim_norming_sample_with_draws  %&gt;% 
  group_by(age, .draw) %&gt;%
  mutate(n = n(),
         normal_transformed_score = qnorm((rank(.prediction) - 0.5) / n)) %&gt;%
  mutate(iq_score = normal_transformed_score * 15 + 100,
         T_score = normal_transformed_score * 10 + 50) %&gt;%
  group_by(age, wordsum_score = .prediction) %&gt;%
  summarise(MR_IQ = round(mean(iq_score)),
            MR_T = round(mean(T_score)))




raw_iqs_normalised &lt;- sb_data %&gt;% 
  group_by(age) %&gt;% 
  mutate(n = n(),
         normal_transformed_score = qnorm((rank(wordsum) - 0.5) / n)) %&gt;%
  mutate(iq_score = normal_transformed_score * 15 + 100,
         T_score = normal_transformed_score * 10 + 50) %&gt;%
  group_by(age, wordsum_score = wordsum) %&gt;%
  summarise(Raw_IQ = round(mean(iq_score)),
            Raw_T = round(mean(T_score)))

iqs &lt;- iqs_normalised %&gt;% 
  left_join(RP_iqs_normalised, by = c(&quot;age&quot;, &quot;wordsum_score&quot;)) %&gt;% 
  left_join(raw_iqs_normalised, by = c(&quot;age&quot;, &quot;wordsum_score&quot;)) 


mean(iqs$MRP_IQ-iqs$MR_IQ)</code></pre>
<pre><code>## [1] 1.969</code></pre>
<pre class="r"><code>mean(abs(iqs$MRP_IQ-iqs$MR_IQ))</code></pre>
<pre><code>## [1] 2.364</code></pre>
<pre class="r"><code>max(iqs$MRP_IQ-iqs$MR_IQ)</code></pre>
<pre><code>## [1] 12</code></pre>
<pre class="r"><code>mean(iqs$MRP_IQ-iqs$Raw_IQ, na.rm = T)</code></pre>
<pre><code>## [1] 1.606</code></pre>
<pre class="r"><code>mean(abs(iqs$MRP_IQ-iqs$Raw_IQ), na.rm = T)</code></pre>
<pre><code>## [1] 4.901</code></pre>
<pre class="r"><code>max(iqs$MRP_IQ-iqs$Raw_IQ, na.rm = T)</code></pre>
<pre><code>## [1] 20</code></pre>
<p>MRP IQs were on average 1.6 IQ points larger than raw ones (absolute
difference 4.9, max difference 20). Again illustrating that
poststratification made an incremental difference beyond the
regularisation, MRP IQs were almost 2 points larger than MR ones (max =
12).</p>
</div>
</div>
<div id="normal-vs.-ordinal" class="section level2" number="6.2">
<h2><span class="header-section-number">6.2</span> Normal
vs. ordinal</h2>
<pre class="r"><code>prediction_transform = list(
  function(x) round(pmax(0, pmin(10, x))), # for handling normal predictons
  function(x) as.numeric(as.character(x))  # for handling ordinal predictions
)


sb_ord_nor &lt;- age_norm_comparisons(
  brm_2, brm_4, 
  ps_table = census_sb, 
  # RP = c(&quot;census&quot;, &quot;norming_sample&quot;),
  ps_variables = c(&quot;age&quot;, &quot;female&quot;, &quot;educ&quot;, &quot;income_brackets&quot;, &quot;race&quot;, &quot;hispan&quot;, &quot;region_residence&quot;, &quot;region_birth&quot;, &quot;degfield_branch&quot;, &quot;marst&quot;, &quot;occ_category&quot;), 
  prediction_transform  = prediction_transform,
  sim_size = 100000,
  labels = c(labels = c(&quot;Raw&quot;, &quot;MRP, normal&quot;, &quot;MRP, ordinal&quot;)),
   palette = c(
  &quot;#BC3C29FF&quot;,
  &quot;#0072B5FF&quot;,
  &quot;#20854EFF&quot;
  # &quot;#7876B1FF&quot;,
  # &quot;#6F99ADFF&quot;
  # &quot;#E18727FF&quot;
  # &quot;#FFDC91FF&quot;,
  # &quot;#EE4C97FF&quot;
),
  output_file = &quot;data/results/wordsum/sb_ord_nor.rds&quot;
  )


sb_ord_nor[-1]</code></pre>
<pre><code>## $overall_estimates
## # A tibble: 2 × 5
##    Mean SE_of_Mean    SD SE_of_SD Model    
##   &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;    
## 1  7.01      0.112  1.75   0.0721 RPP_brm_2
## 2  6.97      0.126  1.83   0.0959 RPP_brm_4
## 
## $means_plot</code></pre>
<pre><code>## Warning: Removed 1 row containing missing values or values outside the scale range
## (`geom_segment()`).</code></pre>
<p><img src="05_tutorial_files/figure-html/unnamed-chunk-27-1.svg" width="768" /></p>
<pre><code>## 
## $SDs_plot</code></pre>
<pre><code>## Warning: Removed 1 row containing missing values or values outside the scale range
## (`geom_pointrange()`).</code></pre>
<pre><code>## Warning: Removed 46 rows containing missing values or values outside the scale range
## (`geom_segment()`).</code></pre>
<p><img src="05_tutorial_files/figure-html/unnamed-chunk-27-2.svg" width="768" /></p>
<pre><code>## 
## $SEs_plot</code></pre>
<pre><code>## Warning: Removed 1 row containing missing values or values outside the scale range
## (`geom_point()`).</code></pre>
<p><img src="05_tutorial_files/figure-html/unnamed-chunk-27-3.svg" width="768" /></p>
<p>Barely any difference in means, although ordinal predictions are
somewhat more dispersed.</p>
</div>
<div id="with-vs.-without-interactions" class="section level2"
number="6.3">
<h2><span class="header-section-number">6.3</span> With vs. without
interactions</h2>
<pre class="r"><code>prediction_transform = list(
  function(x) round(pmax(0, pmin(10, x))), # for handling normal predictons
  function(x) round(pmax(0, pmin(10, x)))  # for handling ordinal predictions
)


sb_with_vs_without_ints &lt;- age_norm_comparisons(
  brm_2, brm_1, 
  ps_table = census_sb, 
  # RP = c(&quot;census&quot;, &quot;norming_sample&quot;),
  ps_variables = c(&quot;age&quot;, &quot;female&quot;, &quot;educ&quot;, &quot;income_brackets&quot;, &quot;race&quot;, &quot;hispan&quot;, &quot;region_residence&quot;, &quot;region_birth&quot;, &quot;degfield_branch&quot;, &quot;marst&quot;, &quot;occ_category&quot;), 
  prediction_transform  = prediction_transform,
  sim_size = 100000,
  labels = c(labels = c(&quot;Raw&quot;, &quot;MRP, without ints&quot;, &quot;MRP, with ints&quot;)),
   palette = c(
  &quot;#BC3C29FF&quot;,
  &quot;#0072B5FF&quot;,
  &quot;#20854EFF&quot;
  # &quot;#7876B1FF&quot;,
  # &quot;#6F99ADFF&quot;
  # &quot;#E18727FF&quot;
  # &quot;#FFDC91FF&quot;,
  # &quot;#EE4C97FF&quot;
),
  output_file = &quot;data/results/wordsum/sb_with_vs_without_ints.rds&quot;
  )


sb_with_vs_without_ints[-1]</code></pre>
<pre><code>## $overall_estimates
## # A tibble: 2 × 5
##    Mean SE_of_Mean    SD SE_of_SD Model    
##   &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;    
## 1  7.01      0.113  1.75   0.0722 RPP_brm_2
## 2  7.01      0.131  1.88   0.0839 RPP_brm_1
## 
## $means_plot</code></pre>
<pre><code>## Warning: Removed 1 row containing missing values or values outside the scale range
## (`geom_segment()`).</code></pre>
<p><img src="05_tutorial_files/figure-html/unnamed-chunk-28-1.svg" width="768" /></p>
<pre><code>## 
## $SDs_plot</code></pre>
<pre><code>## Warning: Removed 1 row containing missing values or values outside the scale range
## (`geom_pointrange()`).</code></pre>
<pre><code>## Warning: Removed 46 rows containing missing values or values outside the scale range
## (`geom_segment()`).</code></pre>
<p><img src="05_tutorial_files/figure-html/unnamed-chunk-28-2.svg" width="768" /></p>
<pre><code>## 
## $SEs_plot</code></pre>
<pre><code>## Warning: Removed 1 row containing missing values or values outside the scale range
## (`geom_point()`).</code></pre>
<p><img src="05_tutorial_files/figure-html/unnamed-chunk-28-3.svg" width="768" /></p>
<p>Same here.</p>
</div>
<div id="effect-of-removing-careless-respondents" class="section level2"
number="6.4">
<h2><span class="header-section-number">6.4</span> Effect of removing
careless respondents?</h2>
<div id="exclude-participants-based-on-various-indicators"
class="section level3" number="6.4.1">
<h3><span class="header-section-number">6.4.1</span> Exclude
participants based on various indicators</h3>
<pre class="r"><code>library(careless)

main_qs &lt;- c(&quot;AAID&quot;, &quot;PANAS&quot;, &quot;PAQ&quot;, &quot;PSS&quot;, &quot;NEPS&quot;, &quot;ULS&quot;, &quot;FCV&quot;, &quot;DAQ&quot;, &quot;CESD&quot;, &quot;HEXACO&quot;, &quot;OCIR&quot;, &quot;PTQ&quot;, &quot;RAAS&quot;, &quot;KSA&quot;, &quot;SAS&quot;, &quot;MFQ&quot;, &quot;CQ&quot;)



sb_data_CR_cleaned &lt;-  sb_data %&gt;% 
  filter(if_all(starts_with(main_qs), ~ !is.na(.x))) %&gt;% 
  mutate(psychsyn = psychsyn(select(., starts_with(main_qs))),
         psychant = psychant(select(., starts_with(main_qs))),
                 CR_psychsyn_outlier = psychsyn &lt; 0.22,
                 CR_psychant_outlier = psychant &gt; -0.03,
                 CR_mahal_outlier = mahad(select(., starts_with(main_qs)), flag = TRUE, confidence = .999, plot = F)$flagged,
                 CR_not_serious = ZY02 == &quot;No, my responses should not be used.&quot;,
                 CR_knows_wordsum = MS04 == &quot;Yes&quot;) %&gt;% 
         filter(!if_any(starts_with(&quot;CR_&quot;), ~ .x == TRUE))</code></pre>
<p>Dropped 85 potentially careless respondents.</p>
</div>
<div
id="refit-model-and-compare-mrp-results-to-the-one-based-on-the-entire-data"
class="section level3" number="6.4.2">
<h3><span class="header-section-number">6.4.2</span> Refit model and
compare MRP results to the one based on the entire data</h3>
<pre class="r"><code>brm_2_non_CR &lt;- brm(bf(wordsum ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth)  + female + (1 | income_brackets),
                   sigma ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth)  + female + (1 | income_brackets)
                   ),
    seed = 14,
    chains = 4,
    file = &quot;data/brms/wordsum/sb/brm_4_non_CR&quot;,
    data = sb_data_CR_cleaned) %&gt;%
  add_criterion(&quot;loo&quot;)

brm_2_non_CR</code></pre>
<pre><code>## Warning: There were 95 divergent transitions after warmup. Increasing
## adapt_delta above 0.8 may help. See
## http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</code></pre>
<pre><code>##  Family: gaussian 
##   Links: mu = identity; sigma = log 
## Formula: wordsum ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth) + female + (1 | income_brackets) 
##          sigma ~ s(age) + (1 | educ) + (1 | race) + hispan + (1 | region_residence) + (1 | marst) + (1 | degfield_branch) + (1 | occ_category) + (1 | region_birth) + female + (1 | income_brackets)
##    Data: sb_data_CR_cleaned (Number of observations: 393) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Smoothing Spline Hyperparameters:
##                   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sds(sage_1)           1.07      0.96     0.04     3.62 1.00     1323     1685
## sds(sigma_sage_1)     0.81      0.76     0.04     2.96 1.01      790      460
## 
## Multilevel Hyperparameters:
## ~degfield_branch (Number of levels: 5) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.61      0.38     0.19     1.66 1.00     1675     2303
## sd(sigma_Intercept)     0.12      0.13     0.00     0.45 1.00     1409     2223
## 
## ~educ (Number of levels: 5) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.64      0.40     0.16     1.66 1.00     1139     1083
## sd(sigma_Intercept)     0.08      0.10     0.00     0.31 1.00     1529     1921
## 
## ~income_brackets (Number of levels: 11) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.18      0.13     0.00     0.49 1.00      831      600
## sd(sigma_Intercept)     0.06      0.05     0.00     0.17 1.00     1775     1875
## 
## ~marst (Number of levels: 3) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.57      0.60     0.04     2.22 1.00     1493     2010
## sd(sigma_Intercept)     0.51      0.57     0.09     2.15 1.00      786      496
## 
## ~occ_category (Number of levels: 6) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.48      0.33     0.05     1.33 1.01     1043     1485
## sd(sigma_Intercept)     0.18      0.16     0.01     0.58 1.00     1070     1734
## 
## ~race (Number of levels: 4) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.26      0.29     0.01     1.04 1.00     1422     1841
## sd(sigma_Intercept)     0.15      0.18     0.01     0.66 1.00     1511     1824
## 
## ~region_birth (Number of levels: 10) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.10      0.08     0.00     0.31 1.00     1792     1964
## sd(sigma_Intercept)     0.07      0.06     0.00     0.21 1.00     1801     2227
## 
## ~region_residence (Number of levels: 9) 
##                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)           0.14      0.11     0.00     0.41 1.00     1429     1018
## sd(sigma_Intercept)     0.15      0.10     0.01     0.37 1.00      959     1222
## 
## Regression Coefficients:
##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept            7.44      0.70     6.00     8.86 1.00     1843     2065
## sigma_Intercept      0.38      0.38    -0.40     1.21 1.00     1309     1106
## hispanTRUE          -0.10      0.23    -0.57     0.35 1.00     3969     3044
## femaleTRUE          -0.08      0.17    -0.41     0.25 1.00     3815     2700
## sigma_hispanTRUE    -0.07      0.13    -0.32     0.19 1.00     3261     2870
## sigma_femaleTRUE    -0.02      0.09    -0.20     0.16 1.00     3721     2342
## sage_1               0.66      2.97    -7.10     5.17 1.00     1511     1292
## sigma_sage_1         0.13      1.98    -3.89     5.06 1.01      755      498
## 
## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<pre class="r"><code>prediction_transform = list(
  function(x) round(pmax(0, pmin(10, x))), 
  function(x) round(pmax(0, pmin(10, x)))  
)


sb_vs_non_CR &lt;- age_norm_comparisons(
  brm_2, brm_2_non_CR,
  ps_table = census_sb, 
  # RP = c(&quot;census&quot;, &quot;norming_sample&quot;),
  ps_variables = c(&quot;age&quot;, &quot;female&quot;, &quot;educ&quot;, &quot;income_brackets&quot;, &quot;race&quot;, &quot;hispan&quot;, &quot;region_residence&quot;, &quot;region_birth&quot;, &quot;degfield_branch&quot;, &quot;marst&quot;, &quot;occ_category&quot;), 
  prediction_transform  = prediction_transform,
  sim_size = 100000,
  labels = c(labels = c(&quot;Raw&quot;, &quot;MRP, full data&quot;, &quot;MRP, CR cleaned data&quot;)),
   palette = c(
  &quot;#BC3C29FF&quot;,
  &quot;#0072B5FF&quot;,
  # &quot;#20854EFF&quot;
  # &quot;#7876B1FF&quot;,
  # &quot;#6F99ADFF&quot;
  # &quot;#E18727FF&quot;
  # &quot;#FFDC91FF&quot;,
  &quot;#EE4C97FF&quot;
),
  output_file = &quot;data/results/wordsum/sb_vs_non_CR.rds&quot;
  )


sb_vs_non_CR[-1]</code></pre>
<pre><code>## $overall_estimates
## # A tibble: 2 × 5
##    Mean SE_of_Mean    SD SE_of_SD Model           
##   &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;           
## 1  7.01      0.113  1.75   0.0724 RPP_brm_2       
## 2  7.06      0.126  1.69   0.0886 RPP_brm_2_non_CR
## 
## $means_plot</code></pre>
<pre><code>## Warning: Removed 1 row containing missing values or values outside the scale range
## (`geom_segment()`).</code></pre>
<p><img src="05_tutorial_files/figure-html/unnamed-chunk-31-1.svg" width="768" /></p>
<pre><code>## 
## $SDs_plot</code></pre>
<pre><code>## Warning: Removed 1 row containing missing values or values outside the scale range
## (`geom_pointrange()`).</code></pre>
<pre><code>## Warning: Removed 46 rows containing missing values or values outside the scale range
## (`geom_segment()`).</code></pre>
<p><img src="05_tutorial_files/figure-html/unnamed-chunk-31-2.svg" width="768" /></p>
<pre><code>## 
## $SEs_plot</code></pre>
<pre><code>## Warning: Removed 1 row containing missing values or values outside the scale range
## (`geom_point()`).</code></pre>
<p><img src="05_tutorial_files/figure-html/unnamed-chunk-31-3.svg" width="768" /></p>
<p>Negligible differences despite dropping 85/478 datapoints.</p>
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>## R version 4.4.1 (2024-06-14)
## Platform: x86_64-pc-linux-gnu
## Running under: Rocky Linux 8.10 (Green Obsidian)
## 
## Matrix products: default
## BLAS/LAPACK: FlexiBLAS OPENBLAS;  LAPACK version 3.11.0
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## time zone: Europe/Berlin
## tzcode source: system (glibc)
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] careless_1.2.2         rstan_2.32.6           StanHeaders_2.32.10   
##  [4] bayesplot_1.11.1       marginaleffects_0.24.0 tidybayes_3.0.7       
##  [7] brms_2.22.0            Rcpp_1.0.12            kableExtra_1.4.0      
## [10] ggrepel_0.9.6          data.table_1.16.4      haven_2.5.4           
## [13] lubridate_1.9.4        forcats_1.0.0          stringr_1.5.1         
## [16] dplyr_1.1.4            purrr_1.0.2            readr_2.1.5           
## [19] tidyr_1.3.1            tibble_3.2.1           ggplot2_3.5.1         
## [22] tidyverse_2.0.0       
## 
## loaded via a namespace (and not attached):
##  [1] mnormt_2.1.1         gridExtra_2.3        inline_0.3.20       
##  [4] sandwich_3.1-1       readxl_1.4.3         rlang_1.1.4         
##  [7] magrittr_2.0.3       multcomp_1.4-26      matrixStats_1.5.0   
## [10] compiler_4.4.1       mgcv_1.9-1           loo_2.8.0           
## [13] reshape2_1.4.4       systemfonts_1.1.0    vctrs_0.6.5         
## [16] pkgconfig_2.0.3      arrayhelpers_1.1-0   crayon_1.5.3        
## [19] fastmap_1.2.0        backports_1.5.0      labeling_0.4.3      
## [22] utf8_1.2.4           cmdstanr_0.8.0       rmarkdown_2.27      
## [25] tzdb_0.4.0           ps_1.7.6             xfun_0.45           
## [28] cachem_1.1.0         jsonlite_1.8.8       highr_0.11          
## [31] psych_2.4.12         parallel_4.4.1       R6_2.5.1            
## [34] bslib_0.7.0          stringi_1.8.4        jquerylib_0.1.4     
## [37] cellranger_1.1.0     estimability_1.5.1   knitr_1.47          
## [40] zoo_1.8-12           R.utils_2.12.3       Matrix_1.7-1        
## [43] splines_4.4.1        timechange_0.3.0     tidyselect_1.2.1    
## [46] rstudioapi_0.16.0    abind_1.4-8          yaml_2.3.8          
## [49] codetools_0.2-20     processx_3.8.4       pkgbuild_1.4.4      
## [52] plyr_1.8.9           lattice_0.22-6       withr_3.0.0         
## [55] bridgesampling_1.1-2 posterior_1.6.0      coda_0.19-4.1       
## [58] evaluate_0.24.0      survival_3.8-3       RcppParallel_5.1.9  
## [61] ggdist_3.3.2         xml2_1.3.6           pillar_1.9.0        
## [64] tensorA_0.36.2.1     checkmate_2.3.2      stats4_4.4.1        
## [67] distributional_0.5.0 generics_0.1.3       hms_1.1.3           
## [70] rstantools_2.4.0     munsell_0.5.1        scales_1.3.0        
## [73] xtable_1.8-4         glue_1.7.0           emmeans_1.10.6      
## [76] tools_4.4.1          mvtnorm_1.3-2        grid_4.4.1          
## [79] QuickJSR_1.5.1       colorspace_2.1-1     nlme_3.1-166        
## [82] cli_3.6.3            fansi_1.0.6          svUnit_1.0.6        
## [85] viridisLite_0.4.2    svglite_2.1.3        Brobdingnag_1.2-9   
## [88] gtable_0.3.6         R.methodsS3_1.8.2    sass_0.4.9          
## [91] digest_0.6.36        TH.data_1.1-2        farver_2.1.2        
## [94] R.oo_1.27.0          htmltools_0.5.8.1    lifecycle_1.0.4     
## [97] MASS_7.3-64</code></pre>
</div>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3,h4",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
