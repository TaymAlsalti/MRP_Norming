<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />



<meta name="date" content="2025-03-29" />

<title>Data preprocessing code</title>

<script src="site_libs/header-attrs-2.27/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="site_libs/font-awesome-6.4.2/css/all.min.css" rel="stylesheet" />
<link href="site_libs/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="01_data_cleaning.html">Data preprocessing</a>
</li>
<li>
  <a href="02_model_selection.html">Model selection</a>
</li>
<li>
  <a href="03_norm_comparisons.html">Norm comparisons</a>
</li>
<li>
  <a href="04_supplements.html">Additional analyses</a>
</li>
<li>
  <a href="05_tutorial.html">MRP Norming Tutorial</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/TaymAlsalti/MRP_Norming">
    <span class="fa fa-github"></span>
     
    
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Data preprocessing code</h1>
<h4 class="date">2025-03-29</h4>

</div>


<style>
.main-container {
  max-width: 1400px !important;  /* Adjust the width as needed */
}

pre, code {
  white-space: pre-wrap;  /* Ensures that long lines wrap */
  word-wrap: break-word;  /* Breaks long words if necessary */
}

pre {
  max-width: 100% !important;
  width: 100% !important;
  overflow-x: auto !important; /* Add horizontal scrollbar if content overflows */
  white-space: pre-line !important; /* Convert line breaks to spaces */
  word-wrap: break-word !important; /* Break long words if necessary */
  word-break: break-all !important; /* Break words to fit the container */
  font-size: 14px !important; /* Adjust font size if needed */
}

</style>
<pre class="r"><code>knitr::opts_chunk$set(
    message = FALSE,
    warning = FALSE,
    include = TRUE,
    error = TRUE
)

knitr::opts_chunk$set(fig.ext = &#39;svg&#39;)


options(scipen = 999,
        digits = 4,
        width = 120)


library(tidyverse)
library(haven)
library(codebook)
library(kableExtra)</code></pre>
<div id="twinlife-sample" class="section level1" number="1">
<h1><span class="header-section-number">1</span> TwinLife sample</h1>
<p>Note that you cannot run the code here unless you have requested and
obtained the TwinLife data. You do not need to do this however, to
reproduce the tutorial code in the RMarkdown document 02_tutorial.Rmd.
The synthetic dataset we produce here is available on our OSF project
and can be used for that purpose. The comparisons to the Raw estimates
(Figures 3 and 4 in the manuscript, see document 03_norm_comparisons)
can also be reproduced based on the synthetic dataset. The comparisons
to the Manual norms cannot be made reproducible as we failed to obtain
permission to share those values.</p>
<div id="preprocessing" class="section level2" number="1.1">
<h2><span class="header-section-number">1.1</span> Preprocessing</h2>
<pre class="r"><code>tl_prelim &lt;- 
  haven::read_dta(&quot;../unshareable_data/raw/ZA6701_person_wid1_v8-0-0.dta&quot;) %&gt;% 
  select(c(&quot;wid&quot;, &quot;fid&quot;, &quot;pid&quot;, &quot;ptyp&quot;, &quot;age0100&quot;, &quot;age0101&quot;, &quot;sex&quot;, &quot;mig0520&quot;, &quot;mig2000&quot;, &quot;mig3100&quot;, &quot;mig3200&quot;, &quot;edu0100&quot;, &quot;edu0400&quot;, &quot;eca0108&quot;, &quot;igf0182&quot;, &quot;igf0282&quot;, &quot;igf0382&quot;, &quot;igf0482&quot;, &quot;eca0105&quot;, &quot;inc0401&quot;, &quot;eca0230&quot;)) %&gt;%
  codebook::detect_missing(ninety_nine_problems = T) %&gt;%
  filter(complete.cases(igf0182, igf0282, igf0382, igf0482)) %&gt;%
  # total sum scores of the sum scores of all 4 subtests, automatically excludes invalid and NA on subtests
  mutate(cft = igf0182 + igf0282 + igf0382 + igf0482,
  # divide age in months variable by 12 for easier interpretablility
         age = age0101/12,
  # create logical sex variable
         male = sex == 1, 
  # create age groups corresponding to those in the manual
  age_group = case_when(
                         age0100 == 11 ~ &#39;11&#39;,
                         age0100 == 12 ~ &#39;12&#39;,
                         age0100 == 13 ~ &#39;13&#39;,
                         age0100 == 14 ~ &#39;14&#39;,
                         age0100 == 15 ~ &#39;15&#39;,
                         age0100 == 16 ~ &#39;16&#39;,
                         age0100 &gt;= 17 &amp; age0100 &lt;= 19 ~ &#39;17-19&#39;,
                         age0100 &gt;= 20 &amp; age0100 &lt;= 24 ~ &#39;20-24&#39;,
                         age0100 &gt;= 25 &amp; age0100 &lt;= 29 ~ &#39;25-29&#39;,
                         age0100 &gt;= 30 &amp; age0100 &lt;= 34 ~ &#39;30-34&#39;,
                         age0100 &gt;= 35 &amp; age0100 &lt;= 39 ~ &#39;35-39&#39;,
                         age0100 &gt;= 40 &amp; age0100 &lt;= 44 ~ &#39;40-44&#39;,
                         age0100 &gt;= 45 &amp; age0100 &lt;= 49 ~ &#39;45-49&#39;,
                         age0100 &gt;= 50 &amp; age0100 &lt;= 54 ~ &#39;50-54&#39;,
                         age0100 &gt;= 55 &amp; age0100 &lt;= 59 ~ &#39;55-59&#39;,
                         age0100 &gt;= 60 &amp; age0100 &lt;= 64 ~ &#39;60-64&#39;,
                         TRUE ~ NA_character_)) 

tl_w_mig &lt;- tl_prelim %&gt;%
  # since the migration variable in the census encodes information about both one&#39;s own and the parent&#39;s migration background and experience (&quot;Migrationshintergrund und -erfahrung&quot;), we start by creating a variable indicating whether the person and/or their parents is/are born abroad
  # assume German citizenship lacking information about citizenship
  mutate(mig0520 = coalesce(mig0520, 1), 
         born_abroad = case_when(
           # if the person themselves is not born in germany, then born_abroad = &quot;self&quot;
            mig2000 != 1 ~ &#39;self&#39;,
           # if the person and both their parents are born in germany, then born_abroad = &quot;none&quot;
            mig2000 == 1 &amp; mig3100 == 1 &amp; mig3200 == 1 ~ &#39;none&#39;,
           # etc..
            mig3100 != 1 &amp; mig3200 != 1 ~ &#39;both_parents&#39;,
            mig3100 != 1 ~ &#39;one_parent&#39;,
            mig3200 != 1 ~ &#39;one_parent&#39;,
           # if no information is available, assume both the person and their parents are born in germany
            TRUE ~ &quot;none&quot;), 
         mig = case_when(
           # if the person is born abroad and is a Citizen... 
            born_abroad == &quot;self&quot; &amp; mig0520 == 1 ~ &quot;Citizen: Own mig experience&quot;,
           # etc..
            born_abroad == &quot;self&quot; &amp; mig0520 != 1 ~ &quot;Non-citizen: Own mig experience&quot;,
            born_abroad != &quot;self&quot; &amp; mig0520 != 1 ~ &quot;Non-citizen: No own mig experience&quot;,
            born_abroad == &quot;one_parent&quot; &amp; mig0520 == 1 ~ &quot;Citizen: Mig background from one parent&quot;,
            born_abroad == &quot;both_parents&quot; &amp; mig0520 == 1 ~ &quot;Citizen: Mig background from both parents&quot;,
            born_abroad == &quot;none&quot; &amp; mig0520 == 1 ~ &quot;Citizen: No mig background&quot;)) </code></pre>
<pre class="r"><code># create an education variable corresponding to the census tables
tl &lt;- tl_w_mig %&gt;% 
  mutate(eca0108 = str_sub(as.character(as_factor(eca0108)), 4, -1),
         school_type = case_when(
           # we had to collapse some categories unto one another in order to ensure correspondance to census categories while attempting to minimise data loss. school types in the comments on the right are what the numerical codes refer to
            edu0400 == 1 ~ &quot;ST1: Primary&quot;, # Grundschule
            edu0400 == 2 ~ &quot;ST6: Other school&quot;, # Orientierungsschule
            edu0400 == 3 ~ &quot;ST2: Lower secondary&quot;, # Hauptschule
            edu0400 == 4 ~ &quot;ST3: Intermediate secondary&quot;, # Realschule
            edu0400 == 5 ~ &quot;ST6: Other school&quot;, # Verbundene Haupt- und Realschule (auch Sekundar-, Real-, Regel-, Mittel-, Ober- und Wirtschaftsschule, regionale Schule, erweiterte Realschule)
            edu0400 == 6 ~ &quot;ST5: Comprehensive school&quot;, # Gesamtschule
            edu0400 == 7 ~ &quot;ST6: Other school&quot;, # Waldorfschule
            edu0400 == 8 ~ &quot;ST4: Upper secondary&quot;, # Gymnasium (auch Kolleg)
            edu0400 == 9 ~ &quot;ST6: Other school&quot;, # Sonderschule/Förderschule
            edu0400 == 10 ~ &quot;ST6: Other school&quot;, # Andere Schule
            # &quot;Entfällt, da kein/e Schüler/-innen&quot; is a category in the census so we gave kids who don&#39;t have a school type category and who specified as an answer to another question that they no longer go to school this category
            edu0100 == 3 ~ &quot;ST7: No longer at school&quot;),  # &quot;ich gehe nicht mehr in die Schule&quot;
         isced = as.factor(case_when(
           # in TwinLife, isced code is coded starting with age 15 but we use it starting with 19 (see code further below). if the person is still at school at age 19 or older, we assume they  have a primary school certificate (&quot;ISCED 1: Primary&quot;)
            eca0108 == &quot;3] -83: in school or training/not in school yet&quot; ~ &quot;ISCED 1: Primary&quot;,
           # Exclude not codable 
            eca0108 == &quot;9] -89: not codable&quot; ~ NA_character_,
           # Those are kids younger than 15
            eca0108 == &quot;5] -95: doesn&#39;t apply (screened out)&quot; ~ NA_character_,
           # we don&#39;t change any coding here, only translation/explanation
            eca0108 == &quot;level 1&quot; ~   &quot;ISCED 1: Primary&quot;,
            eca0108 == &quot;level 2a&quot; ~  &quot;ISCED 2: Lower secondary&quot;,
            eca0108 == &quot;level 3a&quot; ~  &quot;ISCED 3a: Upper secondary, general&quot;,
            eca0108 == &quot;level 3b&quot; ~  &quot;ISCED 3b: Upper secondary, vocational&quot;,
            eca0108 == &quot;level 3c&quot; ~  &quot;ISCED 3b: Upper secondary, vocational&quot;,
            eca0108 == &quot;level 4a&quot; ~  &quot;ISCED 4: Post-secondary&quot;,
            eca0108 == &quot;level 5a&quot; ~  &quot;ISCED 5a: Tertiary, e.g., college&quot;,
            eca0108 == &quot; level 5b&quot; ~ &quot;ISCED 5b: Tertiary, e.g., co-op program&quot;,
            eca0108 == &quot; level 6&quot; ~  &quot;ISCED 6: PhD&quot;)),
           # the final education variable combines the variable school type (age &lt;19) and isced (age &gt; 18)
         educ = as.factor(case_when(
           age0100 &lt;= 18 ~ school_type, 
           age0100 &gt;= 19 ~ isced)),
           # set a large category (upper secondary, vocational) as the reference category of the educ factor
         educ = relevel(educ, 4),
           # same for isced
         isced = relevel(isced, 4)) %&gt;%
 filter(# filter out kids aged &lt;11 who have school type information (because most don&#39;t), &lt;= 65 because n per age group &lt; 15 from 66 and older
         between(age0100, 11, 65) &amp;
         !is.na(educ) &amp;
         # remove half the twins to reduce dependency between observations
         ptyp != 1
        )

# save dataset
save(tl, file=&quot;../unshareable_data/preprocessed/tl.Rda&quot;)

tl %&gt;% group_by(ptyp) %&gt;% as_factor() %&gt;% count()</code></pre>
<pre><code>## # A tibble: 6 × 2
## # Groups:   ptyp [6]
##   ptyp                           n
##   &lt;fct&gt;                      &lt;int&gt;
## 1 2: secondborn twin - u      2884
## 2 200: sibling - s            1032
## 3 300: mother - m             3585
## 4 400: father - f             2329
## 5 500: partner of mother - g   135
## 6 600: partner of father - n    15</code></pre>
</div>
<div id="plots" class="section level2" number="1.2">
<h2><span class="header-section-number">1.2</span> plots</h2>
<pre class="r"><code>ggplot(tl, aes(x = cft)) +
  geom_histogram(binwidth = 1, fill = &quot;blue&quot;, color = &quot;black&quot;, alpha = 0.7) +
  labs(x = &quot;CFT&quot;,
       y = &quot;Frequency&quot;) +
  theme_minimal()</code></pre>
<p><img src="01_data_cleaning_files/figure-html/cft%20plot-1.svg" width="672" /></p>
<pre class="r"><code>ggplot(tl, aes(x = age0100)) +
  geom_histogram(binwidth = 1, fill = &quot;blue&quot;, color = &quot;black&quot;, alpha = 0.7) +
  labs(x = &quot;age&quot;,
       y = &quot;Frequency&quot;) +
  theme_minimal()</code></pre>
<p><img src="01_data_cleaning_files/figure-html/age%20plot-1.svg" width="672" /></p>
</div>
</div>
<div id="cft-manual-norms" class="section level1" number="2">
<h1><span class="header-section-number">2</span> CFT manual norms</h1>
<p>The raw means and SDs manually extracted from the CFT-20R manual had
to be redacted since Hogrefe (publisher of the manual) did not allow us
to share them.</p>
<pre class="r"><code># manual_norms &lt;- tibble(
#          age_group = c(&#39;11:1-11:6&#39;, &#39;11:7-12&#39;, &#39;12:1-12:6&#39;, &#39;12:7-13&#39;, &#39;13:1-13:6&#39;, &#39;13:7-14&#39;, &#39;14:1-14:6&#39;, &#39;14:7-15&#39;, &#39;15:1-16&#39;, &#39;16:1-17&#39;, &#39;17:1-19:11&#39;, &#39;20-24&#39;, &#39;25-29&#39;, &#39;30-34&#39;, &#39;35-39&#39;, &#39;40-44&#39;, &#39;45-49&#39;, &#39;50-54&#39;, &#39;55-59&#39; ,&#39;60-64&#39;),
#          n_manual =    c(               R E D A C T E D             ),
#          mean_manual = c(               R E D A C T E D             ),
#          sd_manual =   c(               R E D A C T E D             )) %&gt;%
#   filter(!is.na(age_group)) %&gt;%
#   mutate(age_group = case_when(
#                          age_group == &quot;10:1-10:6&quot; | age_group == &quot;10:7-11&quot; ~ &#39;10&#39;,
#                          age_group == &quot;11:1-11:6&quot; | age_group == &quot;11:7-12&quot; ~ &#39;11&#39;,
#                          age_group == &quot;12:1-12:6&quot; | age_group == &quot;12:7-13&quot; ~ &#39;12&#39;,
#                          age_group == &quot;13:1-13:6&quot; | age_group == &quot;13:7-14&quot; ~ &#39;13&#39;,
#                          age_group == &quot;14:1-14:6&quot; | age_group == &quot;14:7-15&quot; ~ &#39;14&#39;,
#                          age_group == &quot;15:1-16&quot;                            ~ &#39;15&#39;,
#                          age_group == &quot;16:1-17&quot;                            ~ &#39;16&#39;,
#                          age_group == &quot;17:1-19:11&quot;                         ~ &#39;17-19&#39;,
#                          TRUE ~ age_group)) %&gt;%
#   group_by(age_group) %&gt;%
#   summarise(Manual_n = sum(n_manual),
#             Manual_mean = mean(mean_manual),
#             Manual_sd = sqrt(mean(sd_manual^2)),
#             Manual_se_of_mean = Manual_sd/sqrt(Manual_n))

# save(manual_norms, file=&quot;../unshareable_data/preprocessed/manual_norms.Rda&quot;)
# write.csv(manual_norms, file = &quot;../unshareable_data/preprocessed/manual_norms.csv&quot;)</code></pre>
</div>
<div id="census-tables" class="section level1" number="3">
<h1><span class="header-section-number">3</span> Census tables</h1>
<div id="main-poststratification-table" class="section level2"
number="3.1">
<h2><span class="header-section-number">3.1</span> Main
poststratification table</h2>
<pre class="r"><code>census_school_type_raw &lt;- readxl::read_excel(&quot;data/raw/de_census/729305_Zensus2011_Bildung_Schulform.xlsx&quot;, 
    sheet = &quot;Migration und Schulform&quot;) 

census_school_type &lt;- census_school_type_raw %&gt;% 
  # remove redundant columns of higher order categories (e.g., Deutsche mit Migrationshintergrund)
  select(1:2, 21:28, 45:60, 69:76, 85:100) %&gt;%
  # exclude sex and age columns
  select(3:50) %&gt;%
  # before iteratively naming the 48 columns, 8 (school types) * 6 (migration background) 
  set_names(map(c(&quot;Citizen: No mig background&quot;, # Personen ohne Migrationshintergrund
                  &quot;Non-citizen: Own mig experience&quot;, # Ausländer/-innen mit eigener Migrationserfahrung
                  &quot;Non-citizen: No own mig experience&quot;, # Ausländer/-innen ohne eigene Migrationserfahrung
                  &quot;Citizen: Own mig experience&quot;, # Deutsche mit eigener Migrationserfahrung
                  &quot;Citizen: Mig background from both parents&quot;, # Deutsche mit beidseitigem Migrationshintergrund
                  &quot;Citizen: Mig background from one parent&quot;), # Deutsche mit einseitigem Migrationshintergrund
                ~ paste0(.x, &quot;_&quot;, c(&quot;total&quot;, 
                                    &quot;ST7: No longer at school&quot;, # Entfällt, da kein/e Schüler/-innen
                                    &quot;ST1: Primary&quot;, # Grundschule
                                    &quot;ST2: Lower secondary&quot;, # Hauptschule
                                    &quot;ST3: Intermediate secondary&quot;, # Realschule
                                    &quot;ST4: Upper secondary&quot;, # Gymnasium
                                    &quot;ST5: Comprehensive school&quot;, # Gesamtschule
                                    &quot;ST6: Other school&quot;))) %&gt;% # Sonstige Schule
            unlist()) %&gt;%
  # recover sex and age columns
  mutate(age = as.numeric(parse_number(census_school_type_raw[[2]])),
         male = census_school_type_raw[[1]],
         ) %&gt;% 
  relocate(c(age,male)) %&gt;% 
  mutate(male = ifelse(row_number() &gt;= 115 &amp; row_number() &lt;= 215, TRUE, FALSE)) %&gt;% 
  slice(-(1:113), -215) %&gt;% 
  # disentangle mig and educ variables from one another
  pivot_longer(cols = 3:50,
               names_to = c(&quot;mig&quot;, &quot;school_type&quot;),
               names_sep = &quot;_&quot;,
               values_to = &quot;census_n&quot;) %&gt;%
 # filter(census_n != &quot;/&quot;) %&gt;% 
  # set censored cells to 0
  mutate(census_n = ifelse(census_n == &quot;/&quot;, 0, as.numeric(census_n)))



census_ISCED_raw &lt;- readxl::read_excel(&quot;data/raw/de_census/729305_Zensus2011_Bildung_ISCED.xlsx&quot;, sheet = &quot;Migration und ISCED&quot;)

census_ISCED &lt;- census_ISCED_raw %&gt;% 
  set_names(paste0(&quot;var&quot;, 1:133)) %&gt;% 
  select(-(
    census_ISCED_raw %&gt;% 
    summarise(across(everything(), ~ any(str_detect(., &quot;ISCED-Ebene&quot;)) &amp; any(str_detect(., &quot;Insgesamt&quot;)))) %&gt;% 
    unlist() %&gt;% 
    which()
  )) %&gt;% 
  select(1:2, var24:var34, var57:var78, var90:var100, var112:var133) %&gt;% 
  select(3:56) %&gt;%
  set_names(map(c(&quot;Citizen: No mig background&quot;, # Personen ohne Migrationshintergrund
                  &quot;Non-citizen: Own mig experience&quot;, # Ausländer/-innen mit eigener Migrationserfahrung
                  &quot;Non-citizen: No own mig experience&quot;, # Ausländer/-innen ohne eigene Migrationserfahrung
                  &quot;Citizen: Own mig experience&quot;, # Deutsche mit eigener Migrationserfahrung
                  &quot;Citizen: Mig background from both parents&quot;, # Deutsche mit beidseitigem Migrationshintergrun,
                  &quot;Citizen: Mig background from one parent&quot;), # Deutsche mit einseitigem Migrationshintergrund
         ~ paste0(.x, &quot;_&quot;, c(&quot;total&quot;,
                             &quot;ISCED 1: Primary&quot;, # ISCED-Ebene 1 = Primärbereich
                             &quot;ISCED 2: Lower secondary&quot;, # ISCED-Ebene 2 = Sekundarbereich I
                             &quot;ISCED 3a: Upper secondary, general&quot;, # Sekundarbereich II A, allgemein bildend
                             &quot;ISCED 3b: Upper secondary, vocational&quot;, # Sekundarbereich II B, beruflich
                             &quot;ISCED 4: Post-secondary&quot;, # ISCED-Ebene 4 = Postsekundäre nichttertiäre Bildung
                             &quot;ISCED 5a: Tertiary, e.g., college&quot;, # ISCED-Ebene 5 = Erste Stufe der tertiären Bildung, Tertiärbereich A
                             &quot;ISCED 5b: Tertiary, e.g., co-op program&quot;, # ISCED-Ebene 5 = Erste Stufe der tertiären Bildung, Tertiärbereich B
                             &quot;ISCED 6: PhD&quot; # ISCED-Ebene 6 = Zweite Stufe der tertiären Bildung
                             ))) %&gt;% 
            unlist()) %&gt;% 
  mutate(age = as.numeric(parse_number(census_ISCED_raw[[2]])),
         male = census_ISCED_raw[[1]]) %&gt;% 
  relocate(c(age,male)) %&gt;% 
  mutate(male = ifelse(row_number() &gt;= 99 &amp; row_number() &lt;= 186, TRUE, FALSE)) %&gt;% 
  slice(-(1:99), -186) %&gt;% 
  pivot_longer(cols = 3:56,
               names_to = c(&quot;mig&quot;, &quot;isced&quot;),
               names_sep = &quot;_&quot;,
               values_to = &quot;census_n&quot;) %&gt;%
 # filter(census_n != &quot;/&quot;) %&gt;% 
  mutate(census_n = ifelse(census_n == &quot;/&quot;, 0, as.numeric(census_n)))


# 11 because that&#39;s the minimum age for the educ and mig variables we used in the TL sample
census_school_type_11_18 &lt;- census_school_type %&gt;% 
  filter((age &gt;= 11 &amp; age &lt;= 18) &amp; school_type != &quot;total&quot;) %&gt;% 
  rename(educ = &quot;school_type&quot;) %&gt;% 
  relocate(educ, .after = &quot;mig&quot;)

# 65 
census_ISCED_19_65 &lt;- census_ISCED %&gt;% 
  filter((age &gt;= 19 &amp; age &lt;= 65) &amp; isced != &quot;total&quot;) %&gt;% 
  rename(educ = &quot;isced&quot;)

census &lt;- census_school_type_11_18 %&gt;% 
  bind_rows(census_ISCED_19_65) 

save(census, file=&quot;data/preprocessed/de_census/census.Rda&quot;)

# print random 14 rows/cells/subgroups/combinations out of the total 6528 in the poststratification table
census %&gt;% slice_sample(n = 14) %&gt;% kable %&gt;% kable_styling(full_width = FALSE)</code></pre>
<table class="table" style="color: black; width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:right;">
age
</th>
<th style="text-align:left;">
male
</th>
<th style="text-align:left;">
mig
</th>
<th style="text-align:left;">
educ
</th>
<th style="text-align:right;">
census_n
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
57
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
Citizen: Own mig experience
</td>
<td style="text-align:left;">
ISCED 3b: Upper secondary, vocational
</td>
<td style="text-align:right;">
19380
</td>
</tr>
<tr>
<td style="text-align:right;">
41
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
Non-citizen: Own mig experience
</td>
<td style="text-align:left;">
ISCED 5a: Tertiary, e.g., college
</td>
<td style="text-align:right;">
7190
</td>
</tr>
<tr>
<td style="text-align:right;">
11
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
Citizen: Mig background from both parents
</td>
<td style="text-align:left;">
ST6: Other school
</td>
<td style="text-align:right;">
1450
</td>
</tr>
<tr>
<td style="text-align:right;">
64
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:left;">
Citizen: Mig background from both parents
</td>
<td style="text-align:left;">
ISCED 1: Primary
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
35
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:left;">
Citizen: No mig background
</td>
<td style="text-align:left;">
ISCED 5a: Tertiary, e.g., college
</td>
<td style="text-align:right;">
58550
</td>
</tr>
<tr>
<td style="text-align:right;">
62
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:left;">
Citizen: Mig background from both parents
</td>
<td style="text-align:left;">
ISCED 5b: Tertiary, e.g., co-op program
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
50
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
Non-citizen: No own mig experience
</td>
<td style="text-align:left;">
ISCED 1: Primary
</td>
<td style="text-align:right;">
300
</td>
</tr>
<tr>
<td style="text-align:right;">
48
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
Non-citizen: No own mig experience
</td>
<td style="text-align:left;">
ISCED 2: Lower secondary
</td>
<td style="text-align:right;">
830
</td>
</tr>
<tr>
<td style="text-align:right;">
27
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
Non-citizen: No own mig experience
</td>
<td style="text-align:left;">
ISCED 5b: Tertiary, e.g., co-op program
</td>
<td style="text-align:right;">
500
</td>
</tr>
<tr>
<td style="text-align:right;">
28
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
Citizen: Mig background from one parent
</td>
<td style="text-align:left;">
ISCED 5a: Tertiary, e.g., college
</td>
<td style="text-align:right;">
3480
</td>
</tr>
<tr>
<td style="text-align:right;">
24
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
Citizen: No mig background
</td>
<td style="text-align:left;">
ISCED 1: Primary
</td>
<td style="text-align:right;">
9330
</td>
</tr>
<tr>
<td style="text-align:right;">
61
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
Citizen: No mig background
</td>
<td style="text-align:left;">
ISCED 4: Post-secondary
</td>
<td style="text-align:right;">
10340
</td>
</tr>
<tr>
<td style="text-align:right;">
39
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:left;">
Citizen: No mig background
</td>
<td style="text-align:left;">
ISCED 5a: Tertiary, e.g., college
</td>
<td style="text-align:right;">
64090
</td>
</tr>
<tr>
<td style="text-align:right;">
14
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
Citizen: Mig background from both parents
</td>
<td style="text-align:left;">
ST4: Upper secondary
</td>
<td style="text-align:right;">
8290
</td>
</tr>
</tbody>
</table>
</div>
<div id="totals-for-the-disparities-plot" class="section level2"
number="3.2">
<h2><span class="header-section-number">3.2</span> Totals for the
disparities plot</h2>
<pre class="r"><code>age_margins &lt;- census_school_type_raw %&gt;%
  # total column, rows for ages 11 through 65
  select(3) %&gt;% 
  slice(23:77) %&gt;% 
  mutate(n = as.numeric(`...3`),
         category = as.character(11:65),
         percentage = n/sum(n)*100,
         source = &quot;census&quot;,
         variable = &quot;age&quot;) %&gt;% 
  select(-1)

sex_margins &lt;- census_school_type_raw %&gt;%
  # total column, rows for ages 11 through 65
  select(3) %&gt;% 
  slice((125:179), (227:281)) %&gt;% 
  mutate(category = as.character(ifelse(row_number() &lt; 56, T, F)),
         n = as.numeric(`...3`)) %&gt;% 
  group_by(category) %&gt;% 
  summarize(n = sum(n)) %&gt;% 
  mutate(source = &quot;census&quot;,
         variable = &quot;male&quot;,
         percentage = n/sum(n)*100)

school_type_margins &lt;- census_school_type_raw %&gt;% 
  select(14:20) %&gt;% 
  slice(23:30) %&gt;% 
  set_names(paste0(c(&quot;ST7: No longer at school&quot;, # Entfällt, da kein/e Schüler/-innen
                     &quot;ST1: Primary&quot;, # Grundschule
                     &quot;ST2: Lower secondary&quot;, # Hauptschule
                     &quot;ST3: Intermediate secondary&quot;, # Realschule
                     &quot;ST4: Upper secondary&quot;, # Gymnasium
                     &quot;ST5: Comprehensive school&quot;, # Gesamtschule
                     &quot;ST6: Other school&quot;))) %&gt;% # Sonstige Schule  
  mutate_all(as.numeric) %&gt;% 
  summarise(across(everything(), ~sum(., na.rm = TRUE))) %&gt;% 
  pivot_longer(cols = everything(), names_to = &quot;category&quot;, values_to = &quot;n&quot;)



educ_margins &lt;- census_ISCED_raw %&gt;% 
  select(14, 15, 17:19, 21, 22, 23) %&gt;% 
    slice(17:63) %&gt;% 
  set_names(paste0(c(&quot;ISCED 1: Primary&quot;,                 
                     &quot;ISCED 2: Lower secondary&quot;,          
                     &quot;ISCED 3a: Upper secondary, general&quot;, 
                     &quot;ISCED 3b: Upper secondary, vocational&quot;,
                     &quot;ISCED 4: Post-secondary&quot;,           
                     &quot;ISCED 5a: Tertiary, e.g., college&quot;,   
                     &quot;ISCED 5b: Tertiary, e.g., co-op program&quot;,
                     &quot;ISCED 6: PhD&quot;))) %&gt;% 
  mutate_all(as.numeric) %&gt;% 
  summarise(across(everything(), ~sum(., na.rm = TRUE))) %&gt;% 
  pivot_longer(cols = everything(), names_to = &quot;category&quot;, values_to = &quot;n&quot;) %&gt;% 
  full_join(school_type_margins, by = &quot;category&quot;) %&gt;% 
  mutate(n = ifelse((is.na(n.x) | is.na(n.y)), coalesce(n.x, n.y), n.x + n.y),
         source = &quot;census&quot;,
         variable = &quot;educ&quot;,
         percentage = n/sum(n)*100) %&gt;% 
  select(-c(n.x,n.y))

mig_margins &lt;- census_school_type_raw %&gt;% 
  select(4, 7, 8, 10, 12, 13) %&gt;% 
  slice(23:77) %&gt;% 
  set_names(paste0(c(&quot;Citizen: No mig background&quot;, 
                     &quot;Non-citizen: Own mig experience&quot;, 
                     &quot;Non-citizen: No own mig experience&quot;, 
                     &quot;Citizen: Own mig experience&quot;,
                     &quot;Citizen: Mig background from both parents&quot;,
                     &quot;Citizen: Mig background from one parent&quot;))) %&gt;% 
  mutate_all(as.numeric) %&gt;% 
  summarise(across(everything(), ~sum(., na.rm = TRUE))) %&gt;% 
  pivot_longer(cols = everything(), names_to = &quot;category&quot;, values_to = &quot;n&quot;) %&gt;% 
  mutate(source = &quot;census&quot;,
         variable = &quot;mig&quot;,
         percentage = n/sum(n)*100)
                     
census_margins &lt;- bind_rows(age_margins, educ_margins, sex_margins, mig_margins)

save(census_margins, file=&quot;data/preprocessed/de_census/census_margins.Rda&quot;)</code></pre>
</div>
</div>
<div id="session-info" class="section level1" number="4">
<h1><span class="header-section-number">4</span> Session info</h1>
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>## R version 4.4.1 (2024-06-14)
## Platform: x86_64-pc-linux-gnu
## Running under: Rocky Linux 9.5 (Blue Onyx)
## 
## Matrix products: default
## BLAS/LAPACK: FlexiBLAS OPENBLAS;  LAPACK version 3.11.0
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C               LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8    LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C             LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## time zone: Europe/Berlin
## tzcode source: system (glibc)
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] kableExtra_1.4.0 codebook_0.9.6   haven_2.5.4      lubridate_1.9.4  forcats_1.0.0    stringr_1.5.1   
##  [7] dplyr_1.1.4      purrr_1.0.2      readr_2.1.5      tidyr_1.3.1      tibble_3.2.1     ggplot2_3.5.1   
## [13] tidyverse_2.0.0 
## 
## loaded via a namespace (and not attached):
##  [1] sass_0.4.9        utf8_1.2.4        generics_0.1.3    xml2_1.3.6        stringi_1.8.4     hms_1.1.3        
##  [7] digest_0.6.36     magrittr_2.0.3    evaluate_0.24.0   grid_4.4.1        timechange_0.3.0  fastmap_1.2.0    
## [13] cellranger_1.1.0  jsonlite_1.8.8    fansi_1.0.6       viridisLite_0.4.2 scales_1.3.0      jquerylib_0.1.4  
## [19] cli_3.6.3         labelled_2.14.0   rlang_1.1.4       munsell_0.5.1     withr_3.0.0       cachem_1.1.0     
## [25] yaml_2.3.8        tools_4.4.1       tzdb_0.4.0        colorspace_2.1-1  vctrs_0.6.5       R6_2.5.1         
## [31] lifecycle_1.0.4   pkgconfig_2.0.3   pillar_1.9.0      bslib_0.7.0       gtable_0.3.6      glue_1.7.0       
## [37] systemfonts_1.1.0 highr_0.11        xfun_0.45         tidyselect_1.2.1  rstudioapi_0.16.0 knitr_1.47       
## [43] farver_2.1.2      htmltools_0.5.8.1 labeling_0.4.3    rmarkdown_2.27    svglite_2.1.3     compiler_4.4.1   
## [49] readxl_1.4.3</code></pre>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
