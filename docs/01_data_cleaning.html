<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />



<meta name="date" content="2023-10-20" />

<title>Data preprocessing code</title>

<script src="site_libs/header-attrs-2.21/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="site_libs/font-awesome-6.4.0/css/all.min.css" rel="stylesheet" />
<link href="site_libs/font-awesome-6.4.0/css/v4-shims.min.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>






<link rel="stylesheet" href="styles.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="01_data_cleaning.html">Data preprocessing</a>
</li>
<li>
  <a href="02_tutorial.html">Tutorial</a>
</li>
<li>
  <a href="03_supplements.html">Supplementary analyses</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/TaymAlsalti/MRP_Norming">
    <span class="fa fa-github"></span>
     
    
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Data preprocessing code</h1>
<h4 class="date">2023-10-20</h4>

</div>


<pre class="r"><code>knitr::opts_chunk$set(
    message = FALSE,
    warning = FALSE,
    include = TRUE,
    error = FALSE
)

options(scipen = 999, digits = 7)

library(tidyverse)
library(kableExtra)</code></pre>
<div id="twinlife-sample" class="section level1" number="1">
<h1><span class="header-section-number">1</span> TwinLife sample</h1>
<div id="preprocessing" class="section level2" number="1.1">
<h2><span class="header-section-number">1.1</span> preprocessing</h2>
<pre class="r"><code># Load dataset and define missing values as NA without losing the different types of missing values in the dataset
tl_1 &lt;- haven::read_dta(&quot;../unshareable_data/raw/ZA6701_person_wid1_v6-0-0.dta&quot;) %&gt;% 
  # get variables specifying own, mother&#39;s, and father&#39;s birthplace, respectively, from an older version of the TL sample
  left_join(haven::read_sav(&quot;../unshareable_data/raw/ZA6701_de_person_v2-0-0.sav&quot;) %&gt;% 
                              select(pid, mig0100, mig0300, mig0400), by = &quot;pid&quot;) %&gt;% 
  codebook::detect_missing(ninety_nine_problems = T) %&gt;% 
  # total sum scores of the sum scores of all 4 subtests
  mutate(cft = igf0182 + igf0282 + igf0382 + igf0482,
  # divide age in months variable by 12 for easier interpretablility
         age = age0101/12,
  # create logical sex variable
         male = sex == 1)


# create a migration variable whose categories correspond to the migration variable in the census
tl_2 &lt;- tl_1 %&gt;%
  # wrangle the birthplace variable in the current version of the dataset to get the birthplace of the father and mother of the twins in case mig0300 and mig0400 (which have a lot of NAs) fail
  filter(ptyp == 300 | ptyp == 400) %&gt;% 
  pivot_wider(id_cols = fid, names_from = ptyp, values_from = mig2000) %&gt;% 
  right_join(tl_1, by = &quot;fid&quot;) %&gt;% 
  rename(mig2000_dad = `400`, mig2000_mom = `300`) %&gt;% 
  # set mig2000 to NA if the person is themselves a mother or a father
  mutate(mig2000_dad = as.numeric(ifelse(ptyp == 300 | ptyp == 400, NA_character_, mig2000_dad)),
         mig2000_mom = as.numeric(ifelse(ptyp == 300 | ptyp == 400, NA_character_, mig2000_mom)),
  # collapse the east germany into one germany category
         mig0300 = recode(as.numeric(mig0300), `2` = 1),
         mig0400 = recode(as.numeric(mig0400), `2` = 1),
  # if no information on citzenship is available, assume the person is a citizen
         mig0520 = coalesce(mig0520, 1),
  # since the migration variable in the census encodes information about both one&#39;s own and the parent&#39;s migration background and experience (&quot;Migrationshintergrund und -erfahrung&quot;), we start with creating a variable indicating with the person and/or parents is/are born abroad
         born_abroad = case_when(
           # if the person themselves is not born in germany, then born_abroad = &quot;self&quot;
            mig2000 != 1 ~ &#39;self&#39;,
           # if the person and both their parents are born in germany, then born_abroad = &quot;none&quot;
            mig2000 == 1 &amp; ((coalesce(mig2000_dad, mig0400) == 1 &amp; coalesce(mig2000_mom, mig0300) == 1)) ~ &#39;none&#39;,
           # etc..
            coalesce(mig2000_dad, mig0400) != 1 &amp; coalesce(mig2000_mom, mig0300) != 1 ~ &#39;both_parents&#39;,
            mig2000_mom != 1 ~ &#39;one_parent&#39;,
            mig2000_dad != 1 ~ &#39;one_parent&#39;,  
            mig0300 != 1 ~ &#39;one_parent&#39;,
            mig0400 != 1 ~ &#39;one_parent&#39;,
            mig2000 == 1 ~ &#39;none&#39;,
           # if no information is available, assume both the person and their parents are born in germany
            TRUE ~ &quot;none&quot;), 
         mig = case_when(
           # if the person is born abroad and is a citizen... 
            born_abroad == &quot;self&quot; &amp; mig0520 == 1 ~ &quot;citizen, own mig background&quot;,
            born_abroad == &quot;self&quot; &amp; mig0520 != 1 ~ &quot;foreigner, own mig background&quot;,
            born_abroad != &quot;self&quot; &amp; mig0520 != 1 ~ &quot;foreigner, no own mig background&quot;,
            born_abroad == &quot;one_parent&quot; &amp; mig0520 == 1 ~ &quot;citizen, mig background from one parent&quot;,
            born_abroad == &quot;both_parents&quot; &amp; mig0520 == 1 ~ &quot;citizen, mig background from both parents&quot;,
            born_abroad == &quot;none&quot; &amp; mig0520 == 1 ~ &quot;no mig background&quot;))




# create an education variable corresponding to the census tables
tl &lt;- tl_2 %&gt;% 
  mutate(eca0108 = str_sub(as.character(as_factor(eca0108)), 4, -1),
         school_type = case_when(
           # we had to collapse some categories unto one another in order to ensure correspondance to census categories while attempting to minimise data loss. school types in the comments on the right are what the numerical codes refer to
            edu0400 == 1 ~ &quot;at school: primary&quot;, # Grundschule
            edu0400 == 2 ~ &quot;at school: primary&quot;, # Orientierungsschule
            edu0400 == 3 ~ &quot;at school: lower secondary&quot;, # Hauptschule
            edu0400 == 4 ~ &quot;at school: intermediate secondary&quot;, # Realschule
            edu0400 == 5 ~ &quot;at school: comprehensive school&quot;, # Verbundene Haupt- und Realschule (auch Sekundar-, Real-, Regel-, Mittel-, Ober- und Wirtschaftsschule, regionale Schule, erweiterte Realschule)
            edu0400 == 6 ~ &quot;at school: comprehensive school&quot;, # Gesamtschule
            edu0400 == 7 ~ &quot;at school: comprehensive school&quot;, # Waldorfschule
            edu0400 == 8 ~ &quot;at school: upper secondary&quot;, # Gymnasium (auch Kolleg)
            edu0400 == 9 ~ &quot;at school: other school&quot;, # Sonderschule/Förderschule
            edu0400 == 10 ~ &quot;at school: other school&quot;, # Andere Schule
            # &quot;Entfällt, da kein/e Schüler/-innen&quot; is a category in the census so we gave kids who don&#39;t have a school type category and who specified as an answer to another question that they no longer go to school this category
            edu0100 == 3 ~ &quot;no longer at school&quot;),  # &quot;ich gehe nicht mehr in die Schule&quot;
         isced = as.factor(case_when(
           # isced is coded starting with age 15, if the person is still at school, assume they will have a primary school certificate to be conservative
            eca0108 == &quot;3] -83: in school or training/not in school yet&quot; ~ &quot;isced 1: primary&quot;,
            eca0108 == &quot;9] -89: not codable&quot; ~ NA_character_,
            eca0108 == &quot;5] -95: doesn&#39;t apply (screened out)&quot; ~ NA_character_,
           # we don&#39;t change any coding here, only translation/explanation
            eca0108 == &quot;level 1&quot; ~   &quot;isced 1: primary&quot;,
            eca0108 == &quot;level 2a&quot; ~  &quot;isced 2a: lower secondary&quot;,
            eca0108 == &quot;level 3a&quot; ~  &quot;isced 3a: upper secondary, general&quot;,
            eca0108 == &quot;level 3b&quot; ~  &quot;isced 3b: upper secondary, vocational&quot;,
            eca0108 == &quot;level 3c&quot; ~  &quot;isced 3b: upper secondary, vocational&quot;,
            eca0108 == &quot;level 4a&quot; ~  &quot;isced 4a: post-secondary&quot;,
            eca0108 == &quot;level 5a&quot; ~  &quot;isced 5a: tertiary, college etc.&quot;,
            eca0108 == &quot; level 5b&quot; ~ &quot;isced 5b: tertiary, tech school etc.&quot;,
            eca0108 == &quot; level 6&quot; ~  &quot;isced 6: PhD&quot;)),
           # the final education variable combines the variable school type (age &lt;19) and isced (age &gt; 18)
         educ = as.factor(case_when(
           age0100 &lt;= 18 ~ school_type, 
           age0100 &gt;= 19 ~ isced)),
           # set a large category (upper secondary, vocational) as the reference category of the educ factor
         educ = relevel(educ, 10),
           # same for isced
         isced = relevel(isced, 4)) %&gt;%
 filter(!is.na(cft)
        # unfortunately, 227 participants aged &lt;19 don&#39;t have school type information and 42 aged &gt;18 don&#39;t have isced information
        &amp; !is.na(educ) 
        )

# save dataset
save(tl, file=&quot;../unshareable_data/preprocessed/tl.Rda&quot;)</code></pre>
</div>
<div
id="synthetic-tl-sample-for-the-sake-of-reproducing-the-tutorial-code"
class="section level2" number="1.2">
<h2><span class="header-section-number">1.2</span> synthetic TL sample
for the sake of reproducing the tutorial code</h2>
<pre class="r"><code># reduced_tl &lt;- tl %&gt;% 
#  filter(ptyp != 1) %&gt;%  
#  select(cft, age0100, age, male, mig, educ) %&gt;% 
#  mutate(age0100 = as.double(age0100))

# synthetic_tl &lt;- synthpop::syn(reduced_tl)
# 
# summary(synthetic_tl)
# 
# synthpop::compare(synthetic_tl, reduced_tl, stat = &quot;counts&quot;)

# synthetic_tl &lt;- synthetic_tl$syn

# save synthetic dataset
# save(synthetic_tl, file=&quot;data/simulated/synthetic_tl.Rda&quot;)</code></pre>
</div>
</div>
<div id="cft-manual-norms" class="section level1" number="2">
<h1><span class="header-section-number">2</span> CFT manual norms</h1>
<p>The raw means and SDs manually extracted from the CFT-20R manual had
to be redacted since Hogrefe (publisher of the manual) did not allow us
to share them.</p>
<pre class="r"><code># manual_norms &lt;- tibble(
#          age_group = c(&#39;11:1-11:6&#39;, &#39;11:7-12&#39;, &#39;12:1-12:6&#39;, &#39;12:7-13&#39;, &#39;13:1-13:6&#39;, &#39;13:7-14&#39;, &#39;14:1-14:6&#39;, &#39;14:7-15&#39;, &#39;15:1-16&#39;, &#39;16:1-17&#39;, &#39;17:1-19:11&#39;, &#39;20-24&#39;, &#39;25-29&#39;, &#39;30-34&#39;, &#39;35-39&#39;, &#39;40-44&#39;, &#39;45-49&#39;, &#39;50-54&#39;, &#39;55-59&#39; ,&#39;60-64&#39;),
#          n_manual =    c(               R E D A C T E D             ),
#          mean_manual = c(               R E D A C T E D             ),
#          sd_manual =   c(               R E D A C T E D             )) %&gt;%
#   filter(!is.na(age_group)) %&gt;%
#   mutate(age_group = case_when(
#                          age_group == &quot;10:1-10:6&quot; | age_group == &quot;10:7-11&quot; ~ &#39;10&#39;,
#                          age_group == &quot;11:1-11:6&quot; | age_group == &quot;11:7-12&quot; ~ &#39;11&#39;,
#                          age_group == &quot;12:1-12:6&quot; | age_group == &quot;12:7-13&quot; ~ &#39;12&#39;,
#                          age_group == &quot;13:1-13:6&quot; | age_group == &quot;13:7-14&quot; ~ &#39;13&#39;,
#                          age_group == &quot;14:1-14:6&quot; | age_group == &quot;14:7-15&quot; ~ &#39;14&#39;,
#                          age_group == &quot;15:1-16&quot;                            ~ &#39;15&#39;,
#                          age_group == &quot;16:1-17&quot;                            ~ &#39;16&#39;,
#                          age_group == &quot;17:1-19:11&quot;                         ~ &#39;17-19&#39;,
#                          TRUE ~ age_group)) %&gt;%
#   group_by(age_group) %&gt;%
#   summarise(Manual_n = sum(n_manual),
#             Manual_mean = mean(mean_manual),
#             Manual_sd = sqrt(mean(sd_manual^2)),
#             Manual_se_of_mean = Manual_sd/sqrt(Manual_n))

#save(manual_norms, file=&quot;../unshareable_data/preprocessed/manual_norms.Rda&quot;)
#write.csv(manual_norms, file = &quot;../unshareable_data/preprocessed/manual_norms.csv&quot;)</code></pre>
</div>
<div id="census-tables" class="section level1" number="3">
<h1><span class="header-section-number">3</span> Census tables</h1>
<div id="main-poststratification-table" class="section level2"
number="3.1">
<h2><span class="header-section-number">3.1</span> main
poststratification table</h2>
<pre class="r"><code>census_school_type_raw &lt;- readxl::read_excel(&quot;data/raw/729305_Zensus2011_Bildung_Schulform.xlsx&quot;, 
    sheet = &quot;Migration und Schulform&quot;) 

census_school_type &lt;- census_school_type_raw %&gt;% 
  # remove redundant columns of higher order categories (e.g., Deutsche mit Migrationshintergrund)
  select(1:2, 21:28, 45:60, 69:76, 85:100) %&gt;%
  # exclude sex and age columns
  select(3:50) %&gt;%
  # before iteratively naming the 48 columns, 8 (school types) * 6 (migration background) 
  set_names(map(c(&quot;no mig background&quot;, # Personen ohne Migrationshintergrund
                  &quot;foreigner, own mig background&quot;, # Ausländer/-innen mit eigener Migrationserfahrung
                  &quot;foreigner, no own mig background&quot;, # Ausländer/-innen ohne eigene Migrationserfahrung
                  &quot;citizen, own mig background&quot;, # Deutsche mit eigener Migrationserfahrung
                  &quot;citizen, mig background from both parents&quot;, # Deutsche mit beidseitigem Migrationshintergrund
                  &quot;citizen, mig background from one parent&quot;), # Deutsche mit einseitigem Migrationshintergrund
                ~ paste0(.x, &quot;_&quot;, c(&quot;total&quot;, 
                                    &quot;no longer at school&quot;, # Entfällt, da kein/e Schüler/-innen
                                    &quot;at school: primary&quot;, # Grundschule
                                    &quot;at school: lower secondary&quot;, # Hauptschule
                                    &quot;at school: intermediate secondary&quot;, # Realschule
                                    &quot;at school: upper secondary&quot;, # Gymnasium
                                    &quot;at school: comprehensive school&quot;, # Gesamtschule
                                    &quot;at school: other school&quot;))) %&gt;% # Sonstige Schule
            unlist()) %&gt;%
  # recover sex and age columns
  mutate(age = as.numeric(parse_number(census_school_type_raw[[2]])),
         male = census_school_type_raw[[1]],
         ) %&gt;% 
  relocate(c(age,male)) %&gt;% 
  mutate(male = ifelse(row_number() &gt;= 115 &amp; row_number() &lt;= 215, TRUE, FALSE)) %&gt;% 
  slice(-(1:113), -215) %&gt;% 
  # disentangle mig and educ variables from one another
  pivot_longer(cols = 3:50,
               names_to = c(&quot;mig&quot;, &quot;school_type&quot;),
               names_sep = &quot;_&quot;,
               values_to = &quot;census_n&quot;) %&gt;%
 # filter(census_n != &quot;/&quot;) %&gt;% 
  # set censored cells to 0
  mutate(census_n = ifelse(census_n == &quot;/&quot;, 0, as.numeric(census_n)))



census_ISCED_raw &lt;- readxl::read_excel(&quot;data/raw/729305_Zensus2011_Bildung_ISCED.xlsx&quot;, sheet = &quot;Migration und ISCED&quot;)

census_ISCED &lt;- census_ISCED_raw %&gt;% 
  set_names(paste0(&quot;var&quot;, 1:133)) %&gt;% 
  select(-(
    census_ISCED_raw %&gt;% 
    summarise(across(everything(), ~ any(str_detect(., &quot;ISCED-Ebene&quot;)) &amp; any(str_detect(., &quot;Insgesamt&quot;)))) %&gt;% 
    unlist() %&gt;% 
    which()
  )) %&gt;% 
  select(1:2, var24:var34, var57:var78, var90:var100, var112:var133) %&gt;% 
  select(3:56) %&gt;%
  set_names(map(c(&quot;no mig background&quot;, # Personen ohne Migrationshintergrund
                  &quot;foreigner, own mig background&quot;, # Ausländer/-innen mit eigener Migrationserfahrung
                  &quot;foreigner, no own mig background&quot;, # Ausländer/-innen ohne eigene Migrationserfahrung
                  &quot;citizen, own mig background&quot;, # Deutsche mit eigener Migrationserfahrung
                  &quot;citizen, mig background from both parents&quot;, # Deutsche mit beidseitigem Migrationshintergrun,
                  &quot;citizen, mig background from one parent&quot;), # Deutsche mit einseitigem Migrationshintergrund
         ~ paste0(.x, &quot;_&quot;, c(&quot;total&quot;,
                             &quot;isced 1: primary&quot;, # ISCED-Ebene 1 = Primärbereich
                             &quot;isced 2a: lower secondary&quot;, # ISCED-Ebene 2 = Sekundarbereich I
                             &quot;isced 3a: upper secondary, general&quot;, # Sekundarbereich II A, allgemein bildend
                             &quot;isced 3b: upper secondary, vocational&quot;, # Sekundarbereich II B, beruflich
                             &quot;isced 4a: post-secondary&quot;, # ISCED-Ebene 4 = Postsekundäre nichttertiäre Bildung
                             &quot;isced 5a: tertiary, college etc.&quot;, # ISCED-Ebene 5 = Erste Stufe der tertiären Bildung, Tertiärbereich A
                             &quot;isced 5b: tertiary, tech school etc.&quot;, # ISCED-Ebene 5 = Erste Stufe der tertiären Bildung, Tertiärbereich B
                             &quot;isced 6: PhD&quot; # ISCED-Ebene 6 = Zweite Stufe der tertiären Bildung
                             ))) %&gt;% 
            unlist()) %&gt;% 
  mutate(age = as.numeric(parse_number(census_ISCED_raw[[2]])),
         male = census_ISCED_raw[[1]]) %&gt;% 
  relocate(c(age,male)) %&gt;% 
  mutate(male = ifelse(row_number() &gt;= 99 &amp; row_number() &lt;= 186, TRUE, FALSE)) %&gt;% 
  slice(-(1:99), -186) %&gt;% 
  pivot_longer(cols = 3:56,
               names_to = c(&quot;mig&quot;, &quot;isced&quot;),
               names_sep = &quot;_&quot;,
               values_to = &quot;census_n&quot;) %&gt;%
 # filter(census_n != &quot;/&quot;) %&gt;% 
  mutate(census_n = ifelse(census_n == &quot;/&quot;, 0, as.numeric(census_n)))


# 11 because that&#39;s the minimum age for the educ and mig variables we used in the TL sample
census_school_type_11_18 &lt;- census_school_type %&gt;% 
  filter((age &gt;= 11 &amp; age &lt;= 18) &amp; school_type != &quot;total&quot;) %&gt;% 
  rename(educ = &quot;school_type&quot;) %&gt;% 
  relocate(educ, .after = &quot;mig&quot;)


census_ISCED_19_79 &lt;- census_ISCED %&gt;% 
  filter((age &gt;= 19 &amp; age &lt;= 79) &amp; isced != &quot;total&quot;) %&gt;% 
  rename(educ = &quot;isced&quot;)

census &lt;- census_school_type_11_18 %&gt;% 
  bind_rows(census_ISCED_19_79) 

save(census, file=&quot;data/preprocessed/census.Rda&quot;)

# print random 14 rows/cells/subgroups/combinations out of the total 6528 in the poststratification table
census %&gt;% slice_sample(n = 14) %&gt;% kable %&gt;% kable_styling(full_width = FALSE)</code></pre>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:right;">
age
</th>
<th style="text-align:left;">
male
</th>
<th style="text-align:left;">
mig
</th>
<th style="text-align:left;">
educ
</th>
<th style="text-align:right;">
census_n
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
64
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
citizen, mig background from both parents
</td>
<td style="text-align:left;">
isced 6: PhD
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
59
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
citizen, own mig background
</td>
<td style="text-align:left;">
isced 5b: tertiary, tech school etc.
</td>
<td style="text-align:right;">
5030
</td>
</tr>
<tr>
<td style="text-align:right;">
59
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:left;">
citizen, own mig background
</td>
<td style="text-align:left;">
isced 1: primary
</td>
<td style="text-align:right;">
3740
</td>
</tr>
<tr>
<td style="text-align:right;">
59
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
no mig background
</td>
<td style="text-align:left;">
isced 5a: tertiary, college etc.
</td>
<td style="text-align:right;">
87020
</td>
</tr>
<tr>
<td style="text-align:right;">
29
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
no mig background
</td>
<td style="text-align:left;">
isced 4a: post-secondary
</td>
<td style="text-align:right;">
37130
</td>
</tr>
<tr>
<td style="text-align:right;">
23
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
no mig background
</td>
<td style="text-align:left;">
isced 3a: upper secondary, general
</td>
<td style="text-align:right;">
98820
</td>
</tr>
<tr>
<td style="text-align:right;">
24
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:left;">
foreigner, own mig background
</td>
<td style="text-align:left;">
isced 3a: upper secondary, general
</td>
<td style="text-align:right;">
7190
</td>
</tr>
<tr>
<td style="text-align:right;">
15
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
citizen, own mig background
</td>
<td style="text-align:left;">
at school: lower secondary
</td>
<td style="text-align:right;">
3230
</td>
</tr>
<tr>
<td style="text-align:right;">
44
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
foreigner, own mig background
</td>
<td style="text-align:left;">
isced 3b: upper secondary, vocational
</td>
<td style="text-align:right;">
14250
</td>
</tr>
<tr>
<td style="text-align:right;">
48
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:left;">
no mig background
</td>
<td style="text-align:left;">
isced 5b: tertiary, tech school etc.
</td>
<td style="text-align:right;">
82390
</td>
</tr>
<tr>
<td style="text-align:right;">
25
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
foreigner, no own mig background
</td>
<td style="text-align:left;">
isced 4a: post-secondary
</td>
<td style="text-align:right;">
960
</td>
</tr>
<tr>
<td style="text-align:right;">
23
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
foreigner, no own mig background
</td>
<td style="text-align:left;">
isced 5b: tertiary, tech school etc.
</td>
<td style="text-align:right;">
410
</td>
</tr>
<tr>
<td style="text-align:right;">
77
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:left;">
citizen, mig background from both parents
</td>
<td style="text-align:left;">
isced 5b: tertiary, tech school etc.
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
17
</td>
<td style="text-align:left;">
FALSE
</td>
<td style="text-align:left;">
citizen, own mig background
</td>
<td style="text-align:left;">
no longer at school
</td>
<td style="text-align:right;">
2590
</td>
</tr>
</tbody>
</table>
</div>
<div id="totals-for-the-disparities-plot" class="section level2"
number="3.2">
<h2><span class="header-section-number">3.2</span> totals for the
disparities plot</h2>
<pre class="r"><code>age_marginals &lt;- census_school_type_raw %&gt;%
  # total column, rows for ages 11 through 79
  select(3) %&gt;% 
  slice(23:91) %&gt;% 
  mutate(n = as.numeric(`...3`),
         category = as.character(11:79),
         percentage = n/sum(n)*100,
         source = &quot;census&quot;,
         variable = &quot;age&quot;) %&gt;% 
  select(-1)

sex_marginals &lt;- census_school_type_raw %&gt;%
  # total column, rows for ages 11 through 79
  select(3) %&gt;% 
  slice((125:193), (227:295)) %&gt;% 
  mutate(category = as.character(ifelse(row_number() &lt; 70, T, F)),
         n = as.numeric(`...3`)) %&gt;% 
  group_by(category) %&gt;% 
  summarize(n = sum(n)) %&gt;% 
  mutate(source = &quot;census&quot;,
         variable = &quot;male&quot;,
         percentage = n/sum(n)*100)

school_type_marginals &lt;- census_school_type_raw %&gt;% 
  select(14:20) %&gt;% 
  slice(23:30) %&gt;% 
  set_names(paste0(c(&quot;A7: no longer at school&quot;, # Entfällt, da kein/e Schüler/-innen
                     &quot;A1: primary&quot;, # Grundschule
                     &quot;A2: lower secondary&quot;, # Hauptschule
                     &quot;A3: intermediate secondary&quot;, # Realschule
                     &quot;A6: upper secondary&quot;, # Gymnasium
                     &quot;A5: comprehensive school&quot;, # Gesamtschule
                     &quot;A4: other school&quot;))) %&gt;% # Sonstige Schule  
  mutate_all(as.numeric) %&gt;% 
  summarise(across(everything(), ~sum(., na.rm = TRUE))) %&gt;% 
  pivot_longer(cols = everything(), names_to = &quot;category&quot;, values_to = &quot;n&quot;)
  
  
educ_marginals &lt;- census_ISCED_raw %&gt;% 
  select(14, 15, 17:19, 21, 22, 23) %&gt;% 
    slice(17:77) %&gt;% 
  set_names(paste0(c(&quot;B1: primary&quot;,                 
                     &quot;B2: lower secondary&quot;,          
                     &quot;B4: upper secondary, general&quot;, 
                     &quot;B3: upper secondary, vocational&quot;,
                     &quot;B5: post-secondary&quot;,           
                     &quot;B7: tertiary, college etc.&quot;,   
                     &quot;B6: tertiary, tech school etc.&quot;,
                     &quot;B8: PhD&quot;))) %&gt;% 
  mutate_all(as.numeric) %&gt;% 
  summarise(across(everything(), ~sum(., na.rm = TRUE))) %&gt;% 
  pivot_longer(cols = everything(), names_to = &quot;category&quot;, values_to = &quot;n&quot;) %&gt;% 
  full_join(school_type_marginals, by = &quot;category&quot;) %&gt;% 
  mutate(n = ifelse((is.na(n.x) | is.na(n.y)), coalesce(n.x, n.y), n.x + n.y),
         source = &quot;census&quot;,
         variable = &quot;educ&quot;,
         percentage = n/sum(n)*100) %&gt;% 
  select(-c(n.x,n.y))

mig_marginals &lt;- census_school_type_raw %&gt;% 
  select(4, 7, 8, 10, 12, 13) %&gt;% 
  slice(23:91) %&gt;% 
  set_names(paste0(c(&quot;Citizen: no mig background&quot;, 
                     &quot;Non-citizen: own mig experience&quot;, 
                     &quot;Non-citizen: no own mig experience&quot;, 
                     &quot;Citizen: own mig experience&quot;,
                     &quot;Citizen: mig background from both parents&quot;,
                     &quot;Citizen: mig background from one parent&quot;))) %&gt;% 
  mutate_all(as.numeric) %&gt;% 
  summarise(across(everything(), ~sum(., na.rm = TRUE))) %&gt;% 
  pivot_longer(cols = everything(), names_to = &quot;category&quot;, values_to = &quot;n&quot;) %&gt;% 
  mutate(source = &quot;census&quot;,
         variable = &quot;mig&quot;,
         percentage = n/sum(n)*100)
                     
census_marginals &lt;- bind_rows(age_marginals, educ_marginals, sex_marginals, mig_marginals)

save(census_marginals, file=&quot;data/preprocessed/census_marginals.Rda&quot;)</code></pre>
</div>
</div>
<div id="session-info" class="section level1" number="4">
<h1><span class="header-section-number">4</span> Session info</h1>
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>## R version 4.3.0 (2023-04-21 ucrt)
## Platform: x86_64-w64-mingw32/x64 (64-bit)
## Running under: Windows 10 x64 (build 19045)
## 
## Matrix products: default
## 
## 
## locale:
## [1] LC_COLLATE=English_United Kingdom.utf8 
## [2] LC_CTYPE=English_United Kingdom.utf8   
## [3] LC_MONETARY=English_United Kingdom.utf8
## [4] LC_NUMERIC=C                           
## [5] LC_TIME=English_United Kingdom.utf8    
## 
## time zone: Europe/Berlin
## tzcode source: internal
## 
## attached base packages:
## [1] stats     graphics  grDevices datasets  utils     methods   base     
## 
## other attached packages:
##  [1] kableExtra_1.3.4 forcats_0.5.2    stringr_1.5.0    dplyr_1.1.2     
##  [5] purrr_1.0.1      readr_2.1.3      tidyr_1.2.1      tibble_3.2.1    
##  [9] ggplot2_3.4.2    tidyverse_1.3.2 
## 
## loaded via a namespace (and not attached):
##  [1] gtable_0.3.3        xfun_0.39           bslib_0.4.2        
##  [4] codebook_0.9.2      gargle_1.4.0        tzdb_0.3.0         
##  [7] vctrs_0.6.2         tools_4.3.0         generics_0.1.3     
## [10] fansi_1.0.4         highr_0.10          pkgconfig_2.0.3    
## [13] dbplyr_2.3.0        webshot_0.5.4       readxl_1.4.1       
## [16] assertthat_0.2.1    lifecycle_1.0.3     compiler_4.3.0     
## [19] munsell_0.5.0       htmltools_0.5.5     sass_0.4.6         
## [22] yaml_2.3.7          pillar_1.9.0        crayon_1.5.2       
## [25] jquerylib_0.1.4     ellipsis_0.3.2      googlesheets4_1.0.1
## [28] cachem_1.0.8        tidyselect_1.2.0    rvest_1.0.3        
## [31] digest_0.6.31       stringi_1.7.12      labelled_2.10.0    
## [34] fastmap_1.1.1       grid_4.3.0          colorspace_2.1-0   
## [37] cli_3.6.1           magrittr_2.0.3      utf8_1.2.3         
## [40] broom_1.0.4         withr_2.5.0         scales_1.2.1       
## [43] backports_1.4.1     lubridate_1.9.0     googledrive_2.0.0  
## [46] timechange_0.2.0    rmarkdown_2.21      modelr_0.1.11      
## [49] httr_1.4.5          cellranger_1.1.0    hms_1.1.2          
## [52] evaluate_0.21       knitr_1.42          haven_2.5.1        
## [55] viridisLite_0.4.2   rlang_1.1.1         glue_1.6.2         
## [58] DBI_1.1.3           xml2_1.3.3          renv_0.17.3        
## [61] reprex_2.0.2        svglite_2.1.1       rstudioapi_0.14    
## [64] jsonlite_1.8.4      R6_2.5.1            systemfonts_1.0.4  
## [67] fs_1.6.2</code></pre>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
