---
title: "04_analysis_CFT"
date: "`r Sys.Date()`"
output: 
  html_document: 
    number_sections: yes
    toc: yes
    toc_float: yes
    fig_width: 11
    fig_height: 7
---
# set up
```{r setup, message = FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	include = TRUE,
	error = FALSE
)


library(tidyverse)
library(brms)
library(tidybayes)
library(kableExtra)
library(ggrepel)
library(marginaleffects)

theme_set(theme_gray(base_size = 14))


options(mc.cores = 4, 
        brms.backend = "cmdstanr",
        brms.file_refit = "on_change",
        digits = 4,
        scipen = 999)
load("../data/tl_final.Rda")
load("../data/census_final.Rda")
load("../data/census_marginals.Rda")


tl_no_1st_twins <- tl %>% 
 filter(ptyp != 1)

tl_no_1st_twins_1_per_fid <- tl_no_1st_twins %>%
  group_by(fid) %>%
  sample_n(1)

tl_no_1st_twins_11_19 <- tl_sep_models %>% 
 filter((age >= 11 & age <= 19) & ptyp != 1 & !is.na(school_type)) %>% 
  rename(educ = "school_type")

census_11_19 <- cens %>% 
  filter((age >= 11 & age <= 19))

census_20_79 <- cens %>% 
  filter((age >= 20 & age <= 79))

tl_no_1st_twins_20_79 <- tl_sep_models %>% 
 filter((age >= 20 & age <= 79) & ptyp != 1 & !is.na(isced)) %>% 
  rename(educ = "isced")

tl_no_1st_twins_15_79 %>% group_by(isced) %>% summarise(n())

tl_no_1st_twins_11_21 %>% filter(!is.na(school_type) & (age >= 15 & age <= 21)) %>% nrow()
tl_no_1st_twins_15_79 %>% filter(!is.na(isced) & (age >= 15 & age <= 21)) %>% nrow()


```

# distributional differences between TL sample and population
## marginal
```{r, fig.height = 5, fig.width = 10}
tl_plot <- tl_no_1st_twins %>% 
  group_by(age0100, male, educ, mig) %>% 
  summarise(tl_n = n()) %>% 
  rename(age = "age0100") %>% 
  mutate(tl_n = as.numeric(tl_n))

cens_tl <- cens %>% 
  select(-over_19) %>% 
  full_join(tl_plot, by = c("age", "male", "educ", "mig")) %>% 
  mutate(tl_n = replace_na(tl_n, 0))

cens_tl_long <- cens_tl %>% 
  pivot_longer(cols = c(cens_n:tl_n), names_to = "source", values_to = "n") %>% 
  mutate(mig = as.character(mig),
         age = as.character(age),
         male = as.character(male),
         source = str_sub(source, 1, -3)) %>% 
pivot_longer(cols = -c(n, source), names_to = "variable", values_to = "category") %>% 
  group_by(source, variable, category) %>% 
  summarise(n = sum(n)) %>% 
  mutate(percentage = n/sum(n)*100) %>% 
  filter(source == "tl") %>% 
  bind_rows(cens_marginals)

cens_tl_long %>% 
  filter(variable == "age") %>% 
ggplot(aes(x = category, y = percentage, group = source, colour = source, label = round(percentage))) +
     geom_line(linewidth = 1) +
  theme_gray(base_size = 10) +
     facet_grid(cols = vars(variable), scales = "free", space='free', as.table = F) +
theme(axis.text.x = element_text(angle = 45, hjust = 1)) + geom_text_repel() 

cens_tl_long %>% 
  filter(variable != "age") %>% 
ggplot(aes(x = category, y = percentage, group = source, colour = source, label = round(percentage))) +
     geom_line(linewidth = 1) +
  theme_gray(base_size = 12) +
     facet_grid(cols = vars(variable), scales = "free", space='free', as.table = F) +
theme(axis.text.x = element_text(angle = 45, hjust = 1)) + geom_text_repel() 
```

## joint

```{r}
cens_tl  %>% 
  group_by(age, educ, mig, male) %>% 
  summarise(cens_n = sum(cens_n),
            tl_n = sum(tl_n)) %>% 
  group_by(age) %>% 
  mutate(cens_percentage = cens_n*100/sum(cens_n),
         tl_percentage = tl_n*100/sum(tl_n),
         dif_percentage = cens_percentage-tl_percentage,
         abs_dev = dif_percentage*cens_n/100) %>% 
  relocate(cens_percentage, .after = "cens_n") %>%
  arrange(-abs_dev) %>% DT::datatable() %>% DT::formatRound(c('dif_percentage', 'abs_dev', 'cens_percentage', 'tl_percentage'), digits = 1)
```





# MRP
## Mixed-effects model (MR)
### a_spline_educ
```{r, fig.width=9}
a_spline_educ <-
  brm(bf(cft_total ~ (1 | educ) + s(age)),
      chains = 4,
      iter = 2000,
      family = gaussian(),
      seed = 810,
      file = "../brms/final/a_spline_educ",
      file_refit = "never",
      data = tl_no_1st_twins) %>% 
  add_criterion("loo")
a_spline_educ
plot(conditional_effects(a_spline_educ), points = T)
conditional_smooths(a_spline_educ)
mcmc_plot(a_spline_educ, type = "intervals", variable = "r_educ")


```

### b_full_model
```{r}
b_full_model <-
  brm(bf(cft_total ~ (1 | mig) + (male) + (1 | educ) + (1 | educ:over_19) + (1 | mig:male) + (1 | mig:educ) + (1 | male:educ) + (1 | mig:educ:male) + s(age),
      sigma ~ (1 | mig) + (male) + (1 | educ)  + (1 | educ:over_19) + (1 | mig:male) + (1 | mig:educ) + (1 | male:educ) + (1 | mig:educ:male) + s(age)),
      chains = 4,
      iter = 2000,
      family = gaussian(),
      seed = 810,
      file = "../brms/final/b_full_model",
      file_refit = "never",
      data = tl_no_1st_twins) %>% 
  add_criterion("loo")
b_full_model
plot(conditional_effects(b_full_model), points = T)
conditional_smooths(b_full_model)

mcmc_plot(b_full_model, type = "intervals", variable = "r_educ")
mcmc_plot(b_full_model, type = "intervals", variable = "r_educ:over_19")
mcmc_plot(b_full_model, type = "intervals", variable = "r_mig")

mcmc_plot(b_full_model, type = "intervals", variable = "r_educ__sigma")
mcmc_plot(b_full_model, type = "intervals", variable = "r_educ:over_19__sigma")
```

### b_full_model_school_type
```{r}
b_full_model_school_type_11_21 <-
  brm(bf(cft_total ~ (1 | mig) + (male) + (1 | school_type) + (1 | mig:male) + (1 | mig:school_type) + (1 | male:school_type) + (1 | mig:school_type:male) + s(age),
      sigma ~ (1 | mig) + (male) + (1 | school_type) + (1 | mig:male) + (1 | mig:school_type) + (1 | male:school_type) + (1 | mig:school_type:male) + s(age)),
      chains = 4,
      iter = 2000,
      family = gaussian(),
      seed = 810,
      file = "../brms/final/b_full_model_school_type_new",
      file_refit = "never",
      data = tl_no_1st_twins_11_21) %>% 
  add_criterion("loo")
b_full_model_school_type_11_21
plot(conditional_effects(b_full_model_school_type_11_21), points = T)
conditional_smooths(b_full_model_school_type_11_21)

mcmc_plot(b_full_model_school_type_11_21, type = "intervals", variable = "r_school_type")
mcmc_plot(b_full_model_school_type_11_21, type = "intervals", variable = "r_mig")

mcmc_plot(b_full_model_school_type_11_21, type = "intervals", variable = "r_school_type__sigma")
```

### b_full_model_school_type_11_19
```{r}
b_full_model_school_type_11_19 <-
  brm(bf(cft_total ~ (1 | mig) + (male) + (1 | educ) + (1 | mig:male) + (1 | mig:educ) + (1 | male:educ) + (1 | mig:educ:male) + s(age),
      sigma ~ (1 | mig) + (male) + (1 | educ) + (1 | mig:male) + (1 | mig:educ) + (1 | male:educ) + (1 | mig:educ:male) + s(age)),
      chains = 4,
      iter = 2000,
      family = gaussian(),
      seed = 810,
      file = "../brms/final/b_full_model_school_type_as_educ_11_19",
      file_refit = "never",
      data = tl_no_1st_twins_11_19) %>% 
  add_criterion("loo")
b_full_model_school_type_11_19
plot(conditional_effects(b_full_model_school_type_11_19), points = T)
conditional_smooths(b_full_model_school_type_11_19)

mcmc_plot(b_full_model_school_type_11_19, type = "intervals", variable = "r_educ")
mcmc_plot(b_full_model_school_type_11_19, type = "intervals", variable = "r_mig")

mcmc_plot(b_full_model_school_type_11_19, type = "intervals", variable = "r_school_type__sigma")
```


### b_full_model_isced
```{r}
b_full_model_isced <-
  brm(bf(cft_total ~ (1 | mig) + (male) + (1 | isced)+ (1 | mig:male) + (1 | mig:isced) + (1 | male:isced) + (1 | mig:isced:male) + s(age),
      sigma ~ (1 | mig) + (male) + (1 | isced) + (1 | mig:male) + (1 | mig:isced) + (1 | male:isced) + (1 | mig:isced:male) + s(age)),
      chains = 4,
      iter = 2000,
      family = gaussian(),
      seed = 810,
      file = "../brms/final/b_full_model_isced2",
      file_refit = "never",
      data = tl_no_1st_twins_15_79) %>% 
  add_criterion("loo")
b_full_model_isced
plot(conditional_effects(b_full_model_isced), points = T)
conditional_smooths(b_full_model_isced)

mcmc_plot(b_full_model_isced, type = "intervals", variable = "r_isced")
mcmc_plot(b_full_model_isced, type = "intervals", variable = "r_mig")

mcmc_plot(b_full_model_isced, type = "intervals", variable = "r_isced__sigma")
```

### b_full_model_isced_20_79
```{r}
b_full_model_isced_20_79 <-
  brm(bf(cft_total ~ (1 | mig) + (male) + (1 | educ)+ (1 | mig:male) + (1 | mig:educ) + (1 | male:educ) + (1 | mig:educ:male) + s(age),
      sigma ~ (1 | mig) + (male) + (1 | educ) + (1 | mig:male) + (1 | mig:educ) + (1 | male:educ) + (1 | mig:educ:male) + s(age)),
      chains = 4,
      iter = 2000,
      family = gaussian(),
      seed = 810,
      file = "../brms/final/b_full_model_isced_20_79",
      file_refit = "never",
      data = tl_no_1st_twins_20_79) %>% 
  add_criterion("loo")
b_full_model_isced_20_79
plot(conditional_effects(b_full_model_isced_20_79), points = T)
conditional_smooths(b_full_model_isced_20_79)

mcmc_plot(b_full_model_isced_20_79, type = "intervals", variable = "r_educ")
mcmc_plot(b_full_model_isced_20_79, type = "intervals", variable = "r_mig")

mcmc_plot(b_full_model_isced_20_79, type = "intervals", variable = "r_isced__sigma")
```


### b_fuller_model
```{r}
b_fuller_model <-
  brm(bf(cft_total ~ (1 | mig) + (male) + (1 | educ) + (1 | educ:over_19) + (1 | mig:male) + (1 | mig:educ:over_19) + (1 | male:educ:over_19) + (1 | mig:educ:male:over_19) + s(age),
      sigma ~ (1 | mig) + (male) + (1 | educ)  + (1 | educ:over_19) + (1 | mig:male) + (1 | mig:educ:over_19) + (1 | male:educ:over_19) + (1 | mig:educ:male:over_19) + s(age)),
      chains = 4,
      iter = 2000,
      family = gaussian(),
      seed = 810,
      file = "../brms/final/b_fuller_model",
      file_refit = "never",
      data = tl_no_1st_twins) %>% 
  add_criterion("loo")
b_fuller_model
plot(conditional_effects(b_fuller_model), points = T)
conditional_smooths(b_fuller_model)

```

### b_fullest_model
```{r}
b_fullest_model <-
  brm(bf(
      cft_total ~ (1 | mig) + (1 + age | educ) + (male) + (1 | educ) + (1 | educ:over_19) + (1 | mig:male) + (1 | mig:educ) + (1 | male:educ) + (1 | mig:educ:male) + (1 | mig:educ:over_19) + (1 | male:educ:over_19) + (1 | mig:educ:male:over_19) + s(age),
      sigma ~ (1 | mig) + (male) + (1 | educ) + (1 | educ:over_19) + (1 | mig:male) + (1 | mig:educ) + (1 | male:educ) + (1 | mig:educ:male) + (1 | mig:educ:over_19) + (1 | male:educ:over_19) + (1 | mig:educ:male:over_19) + s(age)),
      chains = 4,
      iter = 2000,
      family = gaussian(),
      seed = 810,
      file = "../brms/final/b_fullest_model2",
      file_refit = "never",
      data = tl_no_1st_twins) %>% 
  add_criterion("loo")

b_fullest_model
plot(conditional_effects(b_fullest_model), points = T)
conditional_smooths(b_fullest_model)


mcmc_plot(b_fullest_model, type = "intervals", variable = "r_educ")
mcmc_plot(b_fullest_model, type = "intervals", variable = "r_educ:over_19")
mcmc_plot(b_fullest_model, type = "intervals", variable = "r_mig")

mcmc_plot(b_fullest_model, type = "intervals", variable = "r_educ__sigma")
mcmc_plot(b_fullest_model, type = "intervals", variable = "r_educ:over_19__sigma")
```

### b_fullest_model_main_over19
```{r}
b_fullest_model_main_over19 <-
  brm(bf(
      cft_total ~ (1 | mig) + (male) + (over_19) + (1 | educ) + (1 | educ:over_19) + (1 | mig:male) + (1 | mig:educ) + (1 | male:educ) + (1 | mig:educ:male) + (1 | mig:educ:over_19) + (1 | male:educ:over_19) + (1 | mig:educ:male:over_19) + s(age),
      sigma ~ (1 | mig) + (male) + (over_19) + (1 | educ) + (1 | educ:over_19) + (1 | mig:male) + (1 | mig:educ) + (1 | male:educ) + (1 | mig:educ:male) + (1 | mig:educ:over_19) + (1 | male:educ:over_19) + (1 | mig:educ:male:over_19) + s(age)),
      chains = 4,
      iter = 2000,
      family = gaussian(),
      seed = 810,
      file = "../brms/final/b_fullest_model_main_over19",
      file_refit = "never",
      data = tl_no_1st_twins) %>% 
  add_criterion("loo")
b_fullest_model_main_over19
plot(conditional_effects(b_fullest_model_main_over19), points = T)
conditional_smooths(b_fullest_model_main_over19)


mcmc_plot(b_fullest_model_main_over19, type = "intervals", variable = "r_educ")
mcmc_plot(b_fullest_model_main_over19, type = "intervals", variable = "r_educ:over_19")
mcmc_plot(b_fullest_model_main_over19, type = "intervals", variable = "r_mig")

mcmc_plot(b_fullest_model_main_over19, type = "intervals", variable = "r_educ__sigma")
mcmc_plot(b_fullest_model_main_over19, type = "intervals", variable = "r_educ:over_19__sigma")
```

### b_fullest_model_no_educ
```{r, fig.width=11}
b_fullest_model_no_educ <-
  brm(bf(
      cft_total ~ (1 | mig) + (male)  + (1 | educ:over_19) + (1 | mig:male) + (1 | mig:educ) + (1 | male:educ) + (1 | mig:educ:male) + (1 | mig:educ:over_19) + (1 | male:educ:over_19) + (1 | mig:educ:male:over_19) + s(age),
      sigma ~ (1 | mig) + (male)  + (1 | educ:over_19) + (1 | mig:male) + (1 | mig:educ) + (1 | male:educ) + (1 | mig:educ:male) + (1 | mig:educ:over_19) + (1 | male:educ:over_19) + (1 | mig:educ:male:over_19) + s(age)),
      chains = 4,
      iter = 2000,
      family = gaussian(),
      seed = 810,
      file = "../brms/final/b_fullest_model_no_educ",
      file_refit = "never",
      data = tl_no_1st_twins) %>% 
  add_criterion("loo")
b_fullest_model_no_educ
plot(conditional_effects(b_fullest_model_no_educ), points = T)
conditional_smooths(b_fullest_model_no_educ)

mcmc_plot(b_fullest_model_no_educ, type = "intervals", variable = "r_educ:over_19")
mcmc_plot(b_fullest_model_no_educ, type = "intervals", variable = "r_mig")
mcmc_plot(b_fullest_model_no_educ, type = "intervals", variable = "r_mig:male")
mcmc_plot(b_fullest_model_no_educ, type = "intervals", variable = "r_mig:educ")
mcmc_plot(b_fullest_model_no_educ, type = "intervals", variable = "r_male:educ")
#mcmc_plot(b_fullest_model_no_educ, type = "intervals", variable = "r_mig:educ:male")
#mcmc_plot(b_fullest_model_no_educ, type = "intervals", variable = "r_mig:educ:over_19")
#mcmc_plot(b_fullest_model_no_educ, type = "intervals", variable = "r_male:educ:over_19")
#mcmc_plot(b_fullest_model_no_educ, type = "intervals", variable = "r_mig:educ:male:over_19")

mcmc_plot(b_fullest_model_no_educ, type = "intervals", variable = "r_educ:over_19__sigma")
mcmc_plot(b_fullest_model_no_educ, type = "intervals", variable = "r_mig__sigma")
mcmc_plot(b_fullest_model_no_educ, type = "intervals", variable = "r_mig:male__sigma")
mcmc_plot(b_fullest_model_no_educ, type = "intervals", variable = "r_mig:educ__sigma")
mcmc_plot(b_fullest_model_no_educ, type = "intervals", variable = "r_male:educ__sigma")
mcmc_plot(b_fullest_model_no_educ, type = "intervals", variable = "r_mig:educ:male__sigma")
#mcmc_plot(b_fullest_model_no_educ, type = "intervals", variable = "r_mig:educ:over_19__sigma")
#mcmc_plot(b_fullest_model_no_educ, type = "intervals", variable = #"r_male:educ:over_19__sigma")
#mcmc_plot(b_fullest_model_no_educ, type = "intervals", variable = #"r_mig:educ:male:over_19__sigma")
```





### b_fullest_model_no_educ_fid
```{r}
b_fullest_model_no_educ_fid <-
  brm(bf(
      cft_total ~ (1 | mig) + (male) + (1 | fid) + (1 | educ:over_19) + (1 | mig:male) + (1 | mig:educ) + (1 | male:educ) + (1 | mig:educ:male) + (1 | mig:educ:over_19) + (1 | male:educ:over_19) + (1 | mig:educ:male:over_19) + s(age),
      sigma ~ (1 | mig) + (male)  + (1 | educ:over_19) + (1 | mig:male) + (1 | mig:educ) + (1 | male:educ) + (1 | mig:educ:male) + (1 | mig:educ:over_19) + (1 | male:educ:over_19) + (1 | mig:educ:male:over_19) + s(age)),
      chains = 4,
      iter = 2000,
      family = gaussian(),
      seed = 810,
      file = "../brms/final/b_fullest_model_no_educ_fid",
      file_refit = "never",
      data = tl_no_1st_twins) %>% 
  add_criterion("loo")
b_fullest_model_no_educ_fid
plot(conditional_effects(b_fullest_model_no_educ_fid), points = T)
conditional_smooths(b_fullest_model_no_educ_fid)

mcmc_plot(b_fullest_model_no_educ_fid, type = "intervals", variable = "r_educ:over_19")
mcmc_plot(b_fullest_model_no_educ_fid, type = "intervals", variable = "r_mig")

mcmc_plot(b_fullest_model_no_educ_fid, type = "intervals", variable = "r_educ:over_19__sigma")
```



### b_fullest_model_no_educ_1_per_fid
```{r}
b_fullest_model_no_educ_1_per_fid <-
  brm(bf(
      cft_total ~ (1 | mig) + (male) + (1 | educ:over_19) + (1 | mig:male) + (1 | mig:educ) + (1 | male:educ) + (1 | mig:educ:male) + (1 | mig:educ:over_19) + (1 | male:educ:over_19) + (1 | mig:educ:male:over_19) + s(age),
      sigma ~ (1 | mig) + (male)  + (1 | educ:over_19) + (1 | mig:male) + (1 | mig:educ) + (1 | male:educ) + (1 | mig:educ:male) + (1 | mig:educ:over_19) + (1 | male:educ:over_19) + (1 | mig:educ:male:over_19) + s(age)),
      chains = 4,
      iter = 2000,
      family = gaussian(),
      seed = 810,
      file = "../brms/final/b_fullest_model_no_educ_1_per_fid",
      file_refit = "never",
      data = tl_no_1st_twins_1_per_fid) %>% 
  add_criterion("loo")
b_fullest_model_no_educ_1_per_fid
plot(conditional_effects(b_fullest_model_no_educ_1_per_fid), points = T)
conditional_smooths(b_fullest_model_no_educ_1_per_fid)

mcmc_plot(b_fullest_model_no_educ_1_per_fid, type = "intervals", variable = "r_educ:over_19")
mcmc_plot(b_fullest_model_no_educ_1_per_fid, type = "intervals", variable = "r_mig")

mcmc_plot(b_fullest_model_no_educ_1_per_fid, type = "intervals", variable = "r_educ:over_19__sigma")
```

### b_fullest_model_no_educ_mu_only
```{r}
b_fullest_model_no_educ_mu_only <-
  brm(bf(
      cft_total ~ (1 | mig) + (male)  + (1 | educ:over_19) + (1 | mig:male) + (1 | mig:educ) + (1 | male:educ) + (1 | mig:educ:male) + (1 | mig:educ:over_19) + (1 | male:educ:over_19) + (1 | mig:educ:male:over_19) + s(age)),
      chains = 4,
      iter = 2000,
      family = gaussian(),
      seed = 810,
      file = "../brms/final/b_fullest_model_no_educ_mu_only",
      file_refit = "never",
      data = tl_no_1st_twins) %>% 
  add_criterion("loo")
b_fullest_model_no_educ_mu_only
plot(conditional_effects(b_fullest_model_no_educ_mu_only), points = T)
conditional_smooths(b_fullest_model_no_educ_mu_only)

mcmc_plot(b_fullest_model_no_educ_mu_only, type = "intervals", variable = "r_educ:over_19")
mcmc_plot(b_fullest_model_no_educ_mu_only, type = "intervals", variable = "r_mig")

```

### c_spline_main_only
```{r, fig.width=9}
c_spline_main_only <-
  brm(bf(cft_total ~ s(age) + (male) + (1 | educ) + (1 | mig) + (1 | educ:over_19)),
      chains = 4,
      iter = 2000,
      family = gaussian(),
      seed = 810,
      file = "../brms/final/c_spline_main_only",
      file_refit = "never", 
      data = tl_no_1st_twins) %>% 
  add_criterion("loo")
c_spline_main_only
plot(conditional_effects(c_spline_main_only), points = T)

mcmc_plot(c_spline_main_only, type = "intervals", variable = "r_educ")
mcmc_plot(c_spline_main_only, type = "intervals", variable = "r_educ:over_19")
mcmc_plot(c_spline_main_only, type = "intervals", variable = "r_mig")
```

### d_spline_fixed_main_only
```{r, fig.width=9}
d_spline_fixed_main_only <-
  brm(bf(cft_total ~ s(age) + (male) + (educ) + (mig) + (educ:over_19)),
      chains = 4,
      iter = 2000,
      family = gaussian(),
      seed = 810,
      file = "../brms/final/d_spline_fixed_main_only",
      file_refit = "never", 
      data = tl_no_1st_twins) %>% 
  add_criterion("loo")
d_spline_fixed_main_only
plot(conditional_effects(d_spline_fixed_main_only), points = T)
```


### e_spline_main_only_4_sd_prior
```{r, fig.width=9}
e_spline_main_only_4_sd_prior <-
  brm(bf(cft_total ~ s(age) + (male) + (1 | educ) + (1 | mig) + (1 | educ:over_19)),
      chains = 4,
      iter = 2000,
      family = gaussian(),
      prior = c(set_prior("normal(0,4)", class = "sd")),
      seed = 810,
      file = "../brms/final/e_spline_main_only_4_sd_prior",
      file_refit = "never", 
      data = tl_no_1st_twins) %>% 
  add_criterion("loo")
e_spline_main_only_4_sd_prior
plot(conditional_effects(e_spline_main_only_4_sd_prior), points = T)

loo_compare(e_spline_main_only_4_sd_prior, b_fullest_model_no_educ_mu_only, b_fullest_model_no_educ, b_fullest_model, b_fuller_model, b_full_model, d_spline_fixed_main_only, c_spline_main_only, a_spline_educ)


mcmc_plot(e_spline_main_only_4_sd_prior, type = "intervals", variable = "r_educ")
mcmc_plot(e_spline_main_only_4_sd_prior, type = "intervals", variable = "r_educ:over_19")
mcmc_plot(e_spline_main_only_4_sd_prior, type = "intervals", variable = "r_mig")
```



## Poststratification (P)

function for outputting MRP results
```{r}
mrp_age_norms <- function(ps_table, ps_variables, brm) {

  norming_sample <- brm$data
  sim_sample <- ps_table %>% 
    sample_n(size = 10000, weight = cens_n, replace = TRUE) %>% 
    select(all_of(ps_variables))
  
  sim_sample_with_draws <- sim_sample %>%
    add_predicted_draws(brm, ndraws = 1000, seed = 810, 
                        allow_new_levels = TRUE) %>% 
    mutate(.prediction = case_when(.prediction < 0 ~ 0,
                                   .prediction > 56 ~ 56,
                                   TRUE ~ .prediction))
  
  means_sds_and_ses <- sim_sample_with_draws %>%
    group_by(age, .draw) %>% 
    summarise(mean_prediction = mean(.prediction), sd_prediction = sd(.prediction)) %>%
    summarise(mrp_mean = mean(mean_prediction), 
              mrp_seOfmean = sd(mean_prediction), 
              mrp_sd = sqrt(mean(sd_prediction^2)), 
              mrp_seOfsd = sd(sd_prediction))
  
  norm_sample_with_draws <- norming_sample %>% 
    select(all_of(ps_variables)) %>% 
    add_predicted_draws(brm, ndraws = 1000, seed = 810, allow_new_levels = TRUE) %>%
    mutate(.prediction = case_when(.prediction < 0 ~ 0,
                                   .prediction > 56 ~ 56,
                                   TRUE ~ .prediction)) 
  
  means_sds_and_ses_no_ps <- norm_sample_with_draws %>%
    group_by(age, .draw) %>% 
    summarise(mean_prediction = mean(.prediction), sd_prediction = sd(.prediction)) %>%
    summarise(mr_mean = mean(mean_prediction), mr_seOfmean = sd(mean_prediction), mr_sd = sqrt(mean(sd_prediction^2)), mr_seOfsd = sd(sd_prediction))
  
  tl_summary <- norming_sample %>% 
    mutate(age = round(age)) %>% 
    group_by(age) %>% 
    summarise(tl_n = n(), tl_mean = mean(cft_total, na.rm = TRUE), tl_sd = sd(cft_total, na.rm = TRUE), tl_seOfmean = tl_sd/sqrt(tl_n))
  
  big_table <- ps_table  %>% 
    group_by(age) %>% 
    summarise(cens_n = sum(cens_n)) %>% 
    left_join(means_sds_and_ses, by = c("age"))  %>%
    left_join(means_sds_and_ses_no_ps, by = c("age")) %>% 
    left_join(tl_summary, by = "age")
  
  big_table_long <- big_table %>% 
    pivot_longer(-age, names_to = c("source", ".value"), names_pattern = "(.*)_(.*)") %>% 
    filter(source != "cens" & source != "manual")
  
  plot1 <- ggplot(data = big_table_long, aes(x = as.factor(age), y = mean, group = source, colour = source)) +
    geom_line(linewidth = 1) +
    geom_point(size = 3, shape = 18, position = position_dodge(width = 0.3)) +
    geom_errorbar(size = 1, aes(ymin = mean - 1.96 * seOfmean, ymax = mean + 1.96 * seOfmean), width = 0.5, position = position_dodge(width = 0.3)) +
    scale_x_discrete(breaks = seq(11, 79, by = 1)) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  plot2 <- ggplot(data = big_table_long, aes(x = as.factor(age), y = sd, group = source, colour = source)) +
    geom_line(linewidth = 1) +
    geom_point(size = 3, shape = 18) +
    scale_x_discrete(breaks = seq(11, 79, by = 1)) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  plot3 <- ggplot(data = big_table_long, aes(x = as.factor(age), y = seOfmean, group = source, colour = source)) +
    geom_line(linewidth = 1) +
    geom_point(size = 3, shape = 18) +
    scale_x_discrete(breaks = seq(11, 79, by = 1)) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  t_test_result <- t.test(big_table$tl_mean, big_table$mrp_mean)
  
  mrp_overall_estimates <- sim_sample_with_draws %>%
    group_by(.draw) %>% 
    summarise(mean_prediction = mean(.prediction), sd_prediction = sd(.prediction)) %>%
    summarise(mrp_mean = mean(mean_prediction), 
              mrp_seOfmean = sd(mean_prediction), 
              mrp_sd = sqrt(mean(sd_prediction^2)), 
              mrp_seOfsd = sd(sd_prediction))
  
  return(list(
    plot1 = plot1,
    plot2 = plot2,
    plot3 = plot3,
    t_test_result = t_test_result,
    mrp_overall_estimates = mrp_overall_estimates
  ))
}

```





### a_spline_educ
```{r, fig.width=11}
mrp_age_norms(ps_table = cens, 
              ps_variables = c("age", "educ"),
              brm = a_spline_educ)
```

### b_full_model
```{r, fig.width=11}
mrp_age_norms(ps_table = cens, 
              ps_variables = c("mig", "age", "educ", "male", "over_19"),
              brm = b_full_model)
```







### b_fuller_model
```{r, fig.width=11}
mrp_age_norms(ps_table = cens, 
              ps_variables = c("mig", "age", "educ", "male", "over_19"),
              brm = b_fuller_model)
```

### b_fullest_model
```{r, fig.width=11}
mrp_age_norms(ps_table = cens, 
              ps_variables = c("mig", "age", "educ", "male", "over_19"),
              brm = b_fullest_model)
```

### b_fullest_model_main_over19
```{r, fig.width=11}
mrp_age_norms(ps_table = cens, 
              ps_variables = c("mig", "age", "educ", "male", "over_19"),
              brm = b_fullest_model_main_over19)
```

### b_fullest_model_no_educ
```{r, fig.width=11}
mrp_age_norms(ps_table = cens, 
              ps_variables = c("mig", "age", "educ", "male"),
              brm = a_fullest_model_random_age_slope)
```

### b_fullest_model_no_educ_fid
```{r, fig.width=11}
mrp_age_norms(ps_table = cens, 
              ps_variables = c("mig", "age", "educ", "male", "over_19"),
              brm = b_fullest_model_no_educ_fid)
```

```{r, fig.width=12}
sim_sample <- cens %>% 
  sample_n(size = 10000, weight = cens_n, replace = TRUE) %>% 
  select(age, mig, educ, male, over_19)

sim_sample_with_draws <- sim_sample %>%
  add_predicted_draws(b_fullest_model_no_educ_fid, ndraws = 1000, seed = 810,
                      allow_new_levels = T,
                      re_formula = cft_total ~ (1 | mig) + (male) + (1 | educ:over_19) + (1 | mig:male) + (1 | mig:educ) + (1 | male:educ) + (1 | mig:educ:male) + (1 | mig:educ:over_19) + (1 | male:educ:over_19) + (1 | mig:educ:male:over_19) + s(age)) %>% 
  mutate(.prediction = case_when(.prediction < 0 ~ 0, # censor predictions which go over scale limits
                                 .prediction > 56 ~ 56,
                                 TRUE ~ .prediction))


sim_sample_with_draws %>%
  group_by(.draw) %>% 
  summarise(mean_prediction = mean(.prediction), sd_prediction = sd(.prediction)) %>%
  summarise(mrp_mean = mean(mean_prediction), 
            mrp_seOfmean = sd(mean_prediction), 
            mrp_sd = sqrt(mean(sd_prediction^2)), 
            mrp_seOfsd = sd(sd_prediction))

```

### b_fullest_model_no_educ_1_per_fid
```{r, fig.width=11}
mrp_age_norms(ps_table = cens, 
              ps_variables = c("mig", "age", "educ", "male", "over_19"),
              brm = b_fullest_model_no_educ_1_per_fid)
```




### c_spline_main_only
```{r, fig.width=11}
mrp_age_norms(ps_table = cens, 
              ps_variables = c("mig", "age", "educ", "male", "over_19"),
              brm = c_spline_main_only)
```

### d_spline_fixed_main_only
```{r, fig.width=11}
mrp_age_norms(ps_table = cens, 
              ps_variables = c("mig", "age", "educ", "male", "over_19"),
              brm = d_spline_fixed_main_only)
```

### e_spline_main_only_4_sd_prior
```{r, fig.width=11}
mrp_age_norms(ps_table = cens, 
              ps_variables = c("mig", "age", "educ", "male", "over_19"),
              brm = e_spline_main_only_4_sd_prior)
```



# separate MRs, separate Ps

```{r, fig.width=11}
sim_sample <- census_Schulform_long_11_21 %>% 
  sample_n(size = 10000, weight = cens_n, replace = TRUE) %>% 
  select(age, mig, school_type, male)


sim_sample_with_draws <- sim_sample %>%
  add_predicted_draws(b_full_model_school_type_11_21, ndraws = 1000, seed = 810, allow_new_levels = T) %>% 
  mutate(.prediction = case_when(.prediction < 0 ~ 0, # censor predictions which go over scale limits
                                 .prediction > 56 ~ 56,
                                 TRUE ~ .prediction))


means_sds_and_ses_ST <- sim_sample_with_draws %>%
  group_by(age, .draw) %>% 
  summarise(mean_prediction = mean(.prediction), sd_prediction = sd(.prediction)) %>%
  summarise(mrpST_mean = mean(mean_prediction), 
            mrpST_seOfmean = sd(mean_prediction), 
            mrpST_sd = sqrt(mean(sd_prediction^2)), 
            mrpST_seOfsd = sd(sd_prediction))

sim_sample <- census_ISCED_long_15_79 %>% 
  sample_n(size = 10000, weight = cens_n, replace = TRUE) %>% 
  select(age, mig, isced, male)


sim_sample_with_draws <- sim_sample %>%
  add_predicted_draws(b_full_model_isced, ndraws = 1000, seed = 810, allow_new_levels = T) %>% 
  mutate(.prediction = case_when(.prediction < 0 ~ 0, # censor predictions which go over scale limits
                                 .prediction > 56 ~ 56,
                                 TRUE ~ .prediction))


means_sds_and_ses_ISCED <- sim_sample_with_draws %>%
  group_by(age, .draw) %>% 
  summarise(mean_prediction = mean(.prediction), sd_prediction = sd(.prediction)) %>%
  summarise(mrpISCED_mean = mean(mean_prediction), 
            mrpISCED_seOfmean = sd(mean_prediction), 
            mrpISCED_sd = sqrt(mean(sd_prediction^2)), 
            mrpISCED_seOfsd = sd(sd_prediction))

sim_sample <- cens %>% 
  sample_n(size = 10000, weight = cens_n, replace = TRUE) %>% 
  select(age, mig, educ, male, over_19)


sim_sample_with_draws <- sim_sample %>%
  add_predicted_draws(b_fullest_model, ndraws = 1000, seed = 810, allow_new_levels = T) %>% 
  mutate(.prediction = case_when(.prediction < 0 ~ 0, # censor predictions which go over scale limits
                                 .prediction > 56 ~ 56,
                                 TRUE ~ .prediction))


means_sds_and_ses_Educ <- sim_sample_with_draws %>%
  group_by(age, .draw) %>% 
  summarise(mean_prediction = mean(.prediction), sd_prediction = sd(.prediction)) %>%
  summarise(mrpEduc_mean = mean(mean_prediction), 
            mrpEduc_seOfmean = sd(mean_prediction), 
            mrpEduc_sd = sqrt(mean(sd_prediction^2)), 
            mrpEduc_seOfsd = sd(sd_prediction))

#sim_sample_with_draws <- b_full_model_school_type$data %>%
#  select(age, mig, school_type, male) %>% 
#  add_predicted_draws(q_brm_spline_age_mig_only, ndraws = 1000, seed = 810, allow_new_levels = #T) %>%
#  mutate(.prediction = case_when(.prediction < 0 ~ 0,
#                                 .prediction > 56 ~ 56,
#                                 TRUE ~ .prediction)) 

#means_sds_and_ses_no_ps <- sim_sample_with_draws %>%
#  group_by(age, .draw) %>% 
#  summarise(mean_prediction = mean(.prediction), sd_prediction = sd(.prediction)) %>%
#  summarise(mr_mean = mean(mean_prediction), mr_seOfmean = sd(mean_prediction), mr_sd = #sqrt(mean(sd_prediction^2)), mr_seOfsd = sd(sd_prediction))


tl_summary <- tl_no_1st_twins %>% 
    mutate(age = round(age)) %>% 
  group_by(age) %>% 
  summarise(tl_n = n(), tl_mean = mean(cft_total, na.rm = T), tl_sd = sd(cft_total, na.rm = T), tl_seOfmean = tl_sd/sqrt(tl_n))

big_table <- cens  %>% 
  group_by(age) %>% 
  summarise (cens_n = sum(cens_n)) %>% 
  left_join(means_sds_and_ses_ST, by = c("age"))  %>%
  left_join(means_sds_and_ses_ISCED, by = c("age")) %>% 
  left_join(means_sds_and_ses_Educ, by = c("age")) %>%
  left_join(tl_summary, by = "age")

big_table_long <- big_table %>% 
  filter(age <= 60) %>% 
  pivot_longer(-age, names_to = c("provenance", ".value"), names_pattern = "(.*)_(.*)") %>% 
  filter(provenance != "cens" & provenance != "manual")

ggplot(data = big_table_long, aes(x = as.factor(age), y = mean, group = provenance, colour = provenance)) +
  geom_line(linewidth = 1) +
  geom_point(size = 3, shape = 18, position = position_dodge(width = 0.3)) +
  geom_errorbar(size = 1, aes(ymin = mean - 1.96*seOfmean, ymax = mean + 1.96*seOfmean), width = .5, position = position_dodge(width = 0.3)) + scale_x_discrete(breaks = seq(11, 79, by = 3))

ggplot(data = big_table_long, aes(x = as.factor(age), y = sd, group = provenance, colour = provenance)) +
  geom_line(linewidth = 1) +
  geom_point(size = 3, shape = 18) +
 scale_x_discrete(breaks = seq(11, 79, by = 3))

ggplot(data = big_table_long, aes(x = as.factor(age), y = seOfmean, group = provenance, colour = provenance)) +
  geom_line(linewidth = 1) +
  geom_point(size = 3, shape = 18) +
 scale_x_discrete(breaks = seq(11, 79, by = 3))

big_table_2 <- big_table %>% filter(age <= 19)
t.test(big_table_2$tl_mean, big_table_2$mrpST_mean)
t.test(big_table_2$tl_mean, big_table_2$mrpEduc_mean)



```

# separate MRs, one P

```{r, fig.width=12}
sim_sample <- census_11_19 %>% 
  sample_n(size = 10000, weight = cens_n, replace = TRUE) %>% 
  select(age, mig, educ, male)


sim_sample_with_draws <- sim_sample %>%
  add_predicted_draws(b_full_model_school_type_11_19, ndraws = 1000, seed = 810, allow_new_levels = T) %>% 
  mutate(.prediction = case_when(.prediction < 0 ~ 0, # censor predictions which go over scale limits
                                 .prediction > 56 ~ 56,
                                 TRUE ~ .prediction))


means_sds_and_ses_ST <- sim_sample_with_draws %>%
  group_by(age, .draw) %>% 
  summarise(mean_prediction = mean(.prediction), sd_prediction = sd(.prediction)) %>%
  summarise(mrpST_mean = mean(mean_prediction), 
            mrpST_seOfmean = sd(mean_prediction), 
            mrpST_sd = sqrt(mean(sd_prediction^2)), 
            mrpST_seOfsd = sd(sd_prediction))

sim_sample <- census_20_79 %>% 
  sample_n(size = 10000, weight = cens_n, replace = TRUE) %>% 
  select(age, mig, educ, male)


sim_sample_with_draws <- sim_sample %>%
  add_predicted_draws(b_full_model_isced_20_79, ndraws = 1000, seed = 810, allow_new_levels = T) %>% 
  mutate(.prediction = case_when(.prediction < 0 ~ 0, # censor predictions which go over scale limits
                                 .prediction > 56 ~ 56,
                                 TRUE ~ .prediction))


means_sds_and_ses_ISCED <- sim_sample_with_draws %>%
  group_by(age, .draw) %>% 
  summarise(mean_prediction = mean(.prediction), sd_prediction = sd(.prediction)) %>%
  summarise(mrpISCED_mean = mean(mean_prediction), 
            mrpISCED_seOfmean = sd(mean_prediction), 
            mrpISCED_sd = sqrt(mean(sd_prediction^2)), 
            mrpISCED_seOfsd = sd(sd_prediction))

sim_sample <- cens %>% 
  sample_n(size = 10000, weight = cens_n, replace = TRUE) %>% 
  select(age, mig, educ, male, over_19)


sim_sample_with_draws <- sim_sample %>%
  add_predicted_draws(b_fullest_model, ndraws = 1000, seed = 810, allow_new_levels = T) %>% 
  mutate(.prediction = case_when(.prediction < 0 ~ 0, # censor predictions which go over scale limits
                                 .prediction > 56 ~ 56,
                                 TRUE ~ .prediction))


means_sds_and_ses_Educ <- sim_sample_with_draws %>%
  group_by(age, .draw) %>% 
  summarise(mean_prediction = mean(.prediction), sd_prediction = sd(.prediction)) %>%
  summarise(mrpEduc_mean = mean(mean_prediction), 
            mrpEduc_seOfmean = sd(mean_prediction), 
            mrpEduc_sd = sqrt(mean(sd_prediction^2)), 
            mrpEduc_seOfsd = sd(sd_prediction))

#sim_sample_with_draws <- b_full_model_school_type$data %>%
#  select(age, mig, school_type, male) %>% 
#  add_predicted_draws(q_brm_spline_age_mig_only, ndraws = 1000, seed = 810, allow_new_levels = #T) %>%
#  mutate(.prediction = case_when(.prediction < 0 ~ 0,
#                                 .prediction > 56 ~ 56,
#                                 TRUE ~ .prediction)) 

#means_sds_and_ses_no_ps <- sim_sample_with_draws %>%
#  group_by(age, .draw) %>% 
#  summarise(mean_prediction = mean(.prediction), sd_prediction = sd(.prediction)) %>%
#  summarise(mr_mean = mean(mean_prediction), mr_seOfmean = sd(mean_prediction), mr_sd = #sqrt(mean(sd_prediction^2)), mr_seOfsd = sd(sd_prediction))


tl_summary <- tl_no_1st_twins %>% 
    mutate(age = round(age)) %>% 
  group_by(age) %>% 
  summarise(tl_n = n(), tl_mean = mean(cft_total, na.rm = T), tl_sd = sd(cft_total, na.rm = T), tl_seOfmean = tl_sd/sqrt(tl_n))

big_table <- cens  %>% 
  group_by(age) %>% 
  summarise (cens_n = sum(cens_n)) %>% 
  left_join(means_sds_and_ses_ST, by = c("age"))  %>%
  left_join(means_sds_and_ses_ISCED, by = c("age")) %>% 
  left_join(means_sds_and_ses_Educ, by = c("age")) %>%
  left_join(tl_summary, by = "age")

big_table_long <- big_table %>% 
  filter(age <= 60) %>% 
  pivot_longer(-age, names_to = c("provenance", ".value"), names_pattern = "(.*)_(.*)") %>% 
  filter(provenance != "cens" & provenance != "manual")

ggplot(data = big_table_long, aes(x = as.factor(age), y = mean, group = provenance, colour = provenance)) +
  geom_line(linewidth = 1) +
  geom_point(size = 3, shape = 18, position = position_dodge(width = 0.3)) +
  geom_errorbar(size = 1, aes(ymin = mean - 1.96*seOfmean, ymax = mean + 1.96*seOfmean), width = .5, position = position_dodge(width = 0.3)) + scale_x_discrete(breaks = seq(11, 79, by = 3))

ggplot(data = big_table_long, aes(x = as.factor(age), y = sd, group = provenance, colour = provenance)) +
  geom_line(linewidth = 1) +
  geom_point(size = 3, shape = 18) +
 scale_x_discrete(breaks = seq(11, 79, by = 3))

ggplot(data = big_table_long, aes(x = as.factor(age), y = seOfmean, group = provenance, colour = provenance)) +
  geom_line(linewidth = 1) +
  geom_point(size = 3, shape = 18) +
 scale_x_discrete(breaks = seq(11, 79, by = 3))


t.test(big_table$tl_mean, big_table$mrp_mean)



```

```{r}

b_full_model_school_type$data %>% group_by(round(age)) %>% summarise(n())

b_full_model_school_type$data %>% group_by(school_type) %>% summarise(n())




mcmc_plot(b_full_model_school_type, type = "intervals", variable = "r_school_type")
mcmc_plot(b_full_model_isced, type = "intervals", variable = "r_isced")
mcmc_plot(b_fullest_model, type = "intervals", variable = "r_educ:over_19")
b_full_model_school_type$data %>% group_by(round(age), school_type) %>% summarise(n = n()) %>% mutate(perc=n/sum(n)*100) %>% kable()
b_fullest_model$data %>% group_by(round(age), educ) %>% summarise(n = n())%>% mutate(perc=n/sum(n)*100) %>% kable()


mcmc_plot(b_full_model_isced, type = "intervals", variable = "r_isced")
b_full_model_isced$data %>% group_by(round(age), isced) %>% summarise(n = n())%>% mutate(perc=n/sum(n)*100) %>% kable()

census_ISCED_long_15_79 %>% group_by(age, isced) %>% summarise(cens_n = sum(cens_n)) %>% mutate(perc=cens_n/sum(cens_n)*100) %>% kable()

census_Schulform_long_11_21 %>% group_by(school_type) %>% summarise(cens_n = sum(cens_n)) %>% mutate(perc=cens_n/sum(cens_n)*100)

b_full_model_school_type$data %>% filter(age >= 15 & age <= 21) %>% nrow()
b_full_model_isced$data %>% filter(age >= 15 & age <= 21) %>% nrow()
b_fullest_model$data %>% filter(age >= 15 & age <= 21) %>% nrow()
tl_no_1st_twins %>% group_by(round(age), educ) %>% summarise(n = n())%>% mutate(perc=n/sum(n)*100) %>% kable()

```

```{r}
mcmc_plot(b_full_model_isced, type = "intervals", variable = "r_isced")
b_full_model_isced$data %>% group_by(round(age), isced) %>% summarise(n = n())%>% mutate(perc=n/sum(n)*100) %>% kable()

census_ISCED_long_15_79 %>% group_by(age, isced) %>% summarise(cens_n = sum(cens_n)) %>% mutate(perc=cens_n/sum(cens_n)*100) %>% kable()


```

```{r}
mcmc_plot(b_full_model_isced, type = "intervals", variable = "r_isced")
b_full_model_isced$data %>% group_by(floor(age), isced) %>% summarise(n = n())%>% mutate(perc=n/sum(n)*100) %>% kable()

census_ISCED_long_15_79 %>% group_by(age, isced) %>% summarise(cens_n = sum(cens_n)) %>% mutate(perc=cens_n/sum(cens_n)*100) %>% kable()


```




