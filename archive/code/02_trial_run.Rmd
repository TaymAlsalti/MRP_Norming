---
title: "MRP norming trial run"
date: "`r Sys.Date()`"
output: 
  html_document:
    number_sections: true
    toc: true
    toc_depth: 3
    toc_float: true
---
# set up and exploration
```{r setup, message = FALSE}
knitr::opts_chunk$set(
	message = TRUE,
	warning = TRUE,
	include = TRUE,
	error = FALSE
)

options(scipen = 999, digits = 4, mc.cores = 4)


library(tidyverse)
library(tidylog)
library(brms)
library(tidybayes)
library(kableExtra)
library(ggrepel)

theme_set(theme_gray(base_size = 14))


options(mc.cores = 4, 
        brms.backend = "cmdstanr",
        brms.file_refit = "on_change")

```


## clean census data
```{r}
cens3 <- read_delim("../data/census_data3.csv", col_names = FALSE, skip = 7,
    delim = ";", escape_double = FALSE, trim_ws = TRUE, locale = locale(encoding = "windows-1252"), show_col_types = FALSE) %>% 
  filter(!if_any(everything(), ~ 
                   grepl("Insgesamt", .) |
                   grepl("^-$", .) | 
                   grepl("^Personen mit Migrationshintergrund$", .) | 
                   grepl("^Deutsche mit Migrationshintergrund$", .) |
                   grepl("^Ausländer/-innen$", .) |
                   grepl("^Deutsche ohne eigene Migrationserfahrung$", .)))%>%
  rename(mig = X1, age = X2, cens_n = X3) %>% 
  drop_na() %>% # empty rows
  mutate(age = as.numeric(parse_number(age)),
         cens_n = case_when(cens_n == "/" ~ "4",
                            TRUE ~ cens_n), # set "Zahlenwert nicht sicher genug" to 4
         cens_n = as.numeric(cens_n),
         mig = case_when(
           mig == "Personen ohne Migrationshintergrund" ~ "none",
           mig == "Ausländer/-innen mit eigener Migrationserfahrung" ~ "foreigner_own",
           mig == "Ausländer/-innen ohne eigene Migrationserfahrung" ~ "foreigner_no_own",
           mig == "Deutsche mit eigener Migrationserfahrung" ~ "citizen_own",
           mig == "Deutsche mit beidseitigem Migrationshintergrund" ~ "citizen_both_parents",
           mig == "Deutsche mit einseitigem Migrationshintergrund" ~ "citizen_one_parent"
         )) %>% 
  filter(!(age < 10 | age > 25))


```



## clean TL data
```{r}
load("../data/tl_clean.Rda")
tl <- tlperson  %>% 
  filter(ptyp == 300 | ptyp == 400) %>% 
  pivot_wider(id_cols = fid, names_from = ptyp, values_from = mig2000) %>% 
  right_join(tlperson, by = "fid") %>% 
  rename(mig2000_dad = `400`, mig2000_mom = `300`) %>% 
  mutate(mig2000_dad = as.numeric(ifelse(ptyp == 300 | ptyp == 400, NA_character_, mig2000_dad)),
         mig2000_mom = as.numeric(ifelse(ptyp == 300 | ptyp == 400, NA_character_, mig2000_mom)),
         mig0300 = recode(as.numeric(mig0300), `2` = 1),
         mig0400 = recode(as.numeric(mig0400), `2` = 1),
         mig0520 = coalesce(mig0520, 1),
         age = age0101/12,
         male = sex == 1,
         edu0400 = ifelse(is.na(edu0400), NA_character_, str_sub(as.character(as_factor(edu0400)), 4, -1)),
         eca0108 = str_sub(as.character(as_factor(eca0108)), 4, -1),
         born_abroad = case_when(
            mig2000 != 1 ~ 'self',
            mig2000 == 1 & ((coalesce(mig2000_dad, mig0400) == 1 & coalesce(mig2000_mom, mig0300) == 1)) ~ 'none',
            coalesce(mig2000_dad, mig0400) != 1 & coalesce(mig2000_mom, mig0300) != 1 ~ 'both_parents',
            mig2000_mom != 1 ~ 'one_parent',
            mig2000_dad != 1 ~ 'one_parent',  
            mig0300 != 1 ~ 'one_parent',
            mig0400 != 1 ~ 'one_parent',
            mig2000 == 1 ~ 'none',
            TRUE ~ "none"), 
         mig = case_when(
            born_abroad == "self" & mig0520 == 1 ~ "citizen_own",
            born_abroad == "self" & mig0520 != 1 ~ "foreigner_own",
            born_abroad != "self" & mig0520 != 1 ~ "foreigner_no_own",
            born_abroad == "one_parent" & mig0520 == 1 ~ "citizen_one_parent",
            born_abroad == "both_parents" & mig0520 == 1 ~ "citizen_both_parents",
            born_abroad == "none" & mig0520 == 1 ~ "none")) %>%
  filter(!is.na(cft_total) & !is.na(age) & ptyp == 1)



```



## get means and sds from the CFT norm tables
```{r}
load("../data/CFT_norms.Rda")
CFT_manual_norms <- norm_means_sds %>%
  filter(!is.na(age_group)) %>%
  mutate(age = case_when(age_group == "10:1-10:6" | age_group == "10:7-11" ~ '10',
                         age_group == "11:1-11:6" | age_group == "11:7-12" ~ '11',
                         age_group == "12:1-12:6" | age_group == "12:7-13" ~ '12',
                         age_group == "13:1-13:6" | age_group == "13:7-14" ~ '13',
                         age_group == "14:1-14:6" | age_group == "14:7-15" ~ '14',
                         age_group == "15:1-16"                          ~ '15',
                         age_group == "16:1-17"                          ~ '16',
                         age_group == "17:1-19:11"                       ~ '17')) %>% 
  filter(!is.na(age)) %>% 
  group_by(age) %>% 
  summarise(manual_n = sum(n_tables), manual_mean = mean(mean_tables), manual_sd = sqrt(mean(sd_tables^2)), manual_seOfmean = manual_sd/sqrt(manual_n)) %>% 
  add_row(age = "18", manual_mean = 41.440) %>% 
  add_row(age = "19", manual_mean = 41.440) %>% 
  mutate(age = as.numeric(age))
rm(norm_means_sds)
```


## Distributional differences between TL and census data
### marginal
```{r, fig.width=9}
tl_plot <- tl %>% 
  group_by(age0100, mig) %>% 
  summarise(tl_n = n()) %>% 
  ungroup() %>% 
  mutate(tl_percentage = 100*tl_n/sum(tl_n)) %>% 
  rename(age = "age0100")

cens_tl <- cens3 %>% 
  full_join(tl_plot, by = c("age", "mig")) %>% 
  mutate(tl_n = replace_na(tl_n, 0), tl_percentage = replace_na(tl_percentage, 0))



cens_tl_long <- cens_tl %>% 
  select(-ends_with("percentage")) %>% 
  pivot_longer(names_to = "source", values_to = "n", -c(age, mig)) %>% 
  mutate(mig = as.character(mig),
         age = as.character(age),
         source = str_sub(source, 1, -3)) %>% 
  pivot_longer(names_to = "variable", values_to = "category", -c(n, source)) %>% 
  group_by(source, variable, category) %>% 
  summarise(n = sum(n)) %>% 
  group_by(source, variable) %>% 
  mutate(percentage = n/sum(n)*100)


ggplot(cens_tl_long, aes(x = category, y = percentage, group = source, colour = source, label = round(percentage))) +
     geom_line(linewidth = 1) +
  theme_gray(base_size = 17) +
     facet_grid(. ~ variable, scales = "free", space='free') +
theme(axis.text.x = element_text(angle = 45, hjust = 1)) + geom_text_repel() 
```

### joint
```{r}
# TOP 14 LARGEST DIFFERENCES
cens_tl <- cens_tl %>% 
  mutate(cens_percentage = cens_n*100/sum(cens_n),
         delta_percentage = abs(cens_percentage-tl_percentage)) %>% 
  relocate(cens_percentage, .after = "cens_n") %>%
  arrange(-delta_percentage)
  

cens_tl %>% head(14) %>% kable() %>% kable_styling(full_width = F)
```



# Multi-level regression

## brm_mu_spline_no_mig
```{r}
brm_mu_spline_no_mig <-
  brm(cft_total ~ s(age),
      chains = 4,
      iter = 6000,
      family = gaussian(),
      seed = 810,
      file = "../brms/brm_mu_spline_no_mig",
      file_refit = "on_change", 
      data = tl) %>% 
  add_criterion("loo")
pp_check(brm_mu_spline_no_mig)
summary(brm_mu_spline_no_mig)
conditional_effects(brm_mu_spline_no_mig)
```



## brm_mu_spline_only
```{r}
brm_mu_spline_only <-
  brm(cft_total ~ s(age, by = mig),
      chains = 4,
      iter = 6000,
      family = gaussian(),
      seed = 810,
      file = "../brms/brm_mu_spline_only",
      file_refit = "on_change", 
      data = tl) %>% 
  add_criterion("loo")
pp_check(brm_mu_spline_only)
summary(brm_mu_spline_only)
conditional_effects(brm_mu_spline_only)
```

## brm_mu_fixed_main_mig 

```{r}
brm_mu_fixed_main_mig <-
  brm(cft_total ~ mig + s(age),
      chains = 4,
      iter = 6000,
      family = gaussian(),
      prior = c(set_prior("normal(0,1)", class = "b")),
      seed = 810,
      file = "../brms/brm_mu_fixed_main_mig",
      file_refit = "on_change",
      data = tl) %>% 
  add_criterion("loo")
pp_check(brm_mu_fixed_main_mig)
summary(brm_mu_fixed_main_mig)
conditional_effects(brm_mu_fixed_main_mig)
```

## brm_mu_random_main_mig
```{r}
brm_mu_random_main_mig <-
  brm(cft_total ~ (1 | mig) + s(age),
      chains = 4,
      iter = 6000,
      family = gaussian(),
      prior = c(set_prior("normal(0,1)", class = "sd")),
      seed = 810,
      file = "../brms/brm_mu_random_main_mig",
      file_refit = "on_change",
      data = tl) %>% 
  add_criterion("loo")
pp_check(brm_mu_random_main_mig)
summary(brm_mu_random_main_mig)
conditional_effects(brm_mu_random_main_mig)
mcmc_plot(brm_mu_random_main_mig, type = "intervals", variable = "r_mig")
```



## brm_sigma_splines_only
```{r}
brm_sigma_splines_only <-
  brm(bf(cft_total ~ s(age, by = mig),
      sigma ~ s(age, by = mig)),
      chains = 4,
      iter = 6000,
      family = gaussian(),
      seed = 810,
      file = "../brms/brm_sigma_splines_only",
      file_refit = "on_change",
      data = tl) %>% 
  add_criterion("loo")
pp_check(brm_sigma_splines_only)
summary(brm_sigma_splines_only)
conditional_effects(brm_sigma_splines_only)
```

## brm_sigma_fixed_main_mig

```{r}
brm_sigma_fixed_main_mig <-
  brm(bf(cft_total ~ mig + s(age),
      sigma ~ mig + s(age)),
      chains = 4,
      iter = 6000,
      family = gaussian(),
      prior = c(set_prior("normal(0,1)", class = "b")),
      seed = 810,
      file = "../brms/brm_sigma_fixed_main_mig",
      file_refit = "on_change",
      data = tl) %>% 
  add_criterion("loo")
pp_check(brm_sigma_fixed_main_mig)
summary(brm_sigma_fixed_main_mig)
conditional_effects(brm_sigma_fixed_main_mig)
```

## brm_sigma_random_main_mig 
```{r}

brm_sigma_random_main_mig <-
  brm(bf(cft_total ~ (1 | mig) + s(age),
      sigma ~ (1 | mig) + s(age)),
      chains = 4,
      iter = 6000,
      family = gaussian(),
      prior = c(set_prior("normal(0,1)", class = "sd")),
      seed = 810,
      file = "../brms/brm_sigma_random_main_mig",
      file_refit = "never",
      data = tl) %>% 
  add_criterion("loo")
pp_check(brm_sigma_random_main_mig)
summary(brm_sigma_random_main_mig)
plot(conditional_effects(brm_sigma_random_main_mig), points = T)

mcmc_plot(brm_sigma_random_main_mig, type = "intervals", variable = "r_mig")
mcmc_plot(brm_sigma_random_main_mig, type = "intervals", variable = "r_mig__sigma")


```





## compare all brms
```{r}
loo_compare(brm_mu_spline_no_mig, brm_mu_spline_only, brm_mu_fixed_main_mig, brm_mu_random_main_mig, brm_sigma_splines_only, brm_sigma_fixed_main_mig, brm_sigma_random_main_mig)

# R2 of model with best fit
loo_R2(brm_sigma_random_main_mig)
```






# Poststratification

## Simulate a sample with the same joint distribution as the census
```{r}
set.seed(810)
sim_sample <- cens3 %>% 
  sample_n(size = 10000, weight = cens_n, replace = TRUE) %>% 
  select(mig, age)
```

## Estimate CFT for those simulated participants
```{r}
sim_sample_with_draws <- sim_sample %>%
  add_predicted_draws(brm_sigma_random_main_mig, ndraws = 1000, seed = 810, allow_new_levels = T) %>% 
  mutate(.prediction = case_when(.prediction < 0 ~ 0, # censor predictions which go over scale limits
                                 .prediction > 56 ~ 56,
                                 TRUE ~ .prediction))
```



## Compute means and SDs + SEs of those means and SDs
```{r}
means_sds_and_ses <- sim_sample_with_draws %>%
  group_by(age, .draw) %>% 
  summarise(mean_prediction = mean(.prediction), sd_prediction = sd(.prediction)) %>%
  summarise(mrp_mean = mean(mean_prediction), 
            mrp_seOfmean = sd(mean_prediction), 
            mrp_sd = sqrt(mean(sd_prediction^2)), 
            mrp_seOfsd = sd(sd_prediction))
means_sds_and_ses %>% kable %>% kable_styling(full_width = FALSE)

```

## Compare with manual and raw means
```{r}
tl_summary <- tl %>% 
  group_by(age0100) %>% 
  summarise(tl_n = n(), tl_mean = mean(cft_total, na.rm = T), tl_sd = sd(cft_total, na.rm = T), tl_seOfmean = tl_sd/sqrt(tl_n)) %>% 
  rename(age = age0100)


big_table <- cens3  %>% 
  group_by(age) %>% 
  summarise (cens_n = sum(cens_n)) %>% 
  left_join(means_sds_and_ses, by = c("age")) %>% 
  left_join(CFT_manual_norms, by = c("age")) %>% 
  left_join(tl_summary, by = "age")
big_table %>% kable %>% kable_styling(full_width = FALSE)

t.test(big_table$tl_mean, big_table$mrp_mean)
```

## plot the means + CIs
```{r, fig.width=9}
big_table_long <- big_table %>% 
  pivot_longer(-age, names_to = c("source", ".value"), names_pattern = "(.*)_(.*)") %>% 
  filter(source != "cens")
ggplot(data = big_table_long, aes(x = age, y = mean, group = source, colour = source, label = round(mean, 2))) +
  geom_line(linewidth = 1) +
  geom_point(size = 3, shape = 18, position = position_dodge(width = 0.3)) +
  geom_errorbar(size = 1, aes(ymin = mean - 1.96*seOfmean, ymax = mean + 1.96*seOfmean), width = .5, position = position_dodge(width = 0.3)) +
 scale_x_discrete(limits = c(10:25)) + geom_label_repel()

#ggsave("p.png", scale = 3, height = 6, width = 9, units = "cm")
```

## plot SDs
```{r, fig.width=9}
ggplot(data = big_table_long, aes(x = age, y = sd, group = source, colour = source)) +
  geom_line(linewidth = 1) +
  geom_point(size = 3, shape = 18) +
 scale_x_discrete(limits = c(10:25))
```



# MR predictions without PS
```{r}
tl_summary <- tl %>% 
  group_by(age0100) %>% 
  summarise(tl_n = n(), tl_mean = mean(cft_total, na.rm = T), tl_sd = sd(cft_total, na.rm = T), tl_seOfmean = tl_sd/sqrt(tl_n)) %>% 
  rename(age = age0100)


sim_sample <- cens3 %>% 
  sample_n(size = 10000, weight = cens_n, replace = TRUE) %>% 
  select(mig, age)

sim_sample_with_draws <- sim_sample %>%
  add_predicted_draws(brm_sigma_random_main_mig2, ndraws = 1000, seed = 810, allow_new_levels = T) %>% 
  mutate(.prediction = case_when(.prediction < 0 ~ 0, # censor predictions which go over scale limits
                                 .prediction > 56 ~ 56,
                                 TRUE ~ .prediction))


means_sds_and_ses <- sim_sample_with_draws %>%
  group_by(age, .draw) %>% 
  summarise(mean_prediction = mean(.prediction), sd_prediction = sd(.prediction)) %>%
  summarise(mrp_mean = mean(mean_prediction), 
            mrp_seOfmean = sd(mean_prediction), 
            mrp_sd = sqrt(mean(sd_prediction^2)), 
            mrp_seOfsd = sd(sd_prediction))



sim_sample_with_draws <- tl %>%
  select(age = age0100, mig) %>% 
  add_predicted_draws(brm_sigma_random_main_mig2, ndraws = 1000, seed = 810, allow_new_levels = T) %>%
  mutate(.prediction = case_when(.prediction < 0 ~ 0,
                                 .prediction > 56 ~ 56,
                                 TRUE ~ .prediction)) 

means_sds_and_ses_no_ps <- sim_sample_with_draws %>%
  group_by(age, .draw) %>% 
  summarise(mean_prediction = mean(.prediction), sd_prediction = sd(.prediction)) %>%
  summarise(mr_mean = mean(mean_prediction), mr_seOfmean = sd(mean_prediction), mr_sd = sqrt(mean(sd_prediction^2)), mr_seOfsd = sd(sd_prediction))

big_table <- cens3  %>% 
  group_by(age) %>% 
  summarise (cens_n = sum(cens_n)) %>% 
  left_join(means_sds_and_ses, by = c("age")) %>% 
  left_join(means_sds_and_ses_no_ps, by = c("age")) %>%
#  left_join(CFT_manual_norms, by = c("age")) %>% 
  left_join(tl_summary, by = "age")

big_table_long <- big_table %>% 
  pivot_longer(-age, names_to = c("source", ".value"), names_pattern = "(.*)_(.*)") %>% 
  filter(source != "cens" & source != "manual")
ggplot(data = big_table_long, aes(x = age, y = mean, group = source, colour = source)) +
  geom_line(linewidth = 1) +
  geom_point(size = 3, shape = 18, position = position_dodge(width = 0.3)) +
  geom_errorbar(size = 1, aes(ymin = mean - 1.96*seOfmean, ymax = mean + 1.96*seOfmean), width = .5, position = position_dodge(width = 0.3)) +
 scale_x_discrete(limits = c(10:25))

ggplot(data = big_table_long, aes(x = age, y = seOfmean, group = source, colour = source)) +
  geom_line(linewidth = 1) +
  geom_point(size = 3, shape = 18) +
 scale_x_discrete(limits = c(10:25))

mean(big_table$mrp_seOfmean)

```






