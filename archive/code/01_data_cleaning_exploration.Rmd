---
title: "MRP_norming"
date: "`r Sys.Date()`"
output: 
  html_document:
    number_sections: true
    toc: true
    toc_depth: 3
    toc_float: true
---

# set up
```{r setup, message = FALSE}
knitr::opts_chunk$set(
	message = TRUE,
	warning = FALSE,
	include = TRUE,
	error = TRUE
)

options(scipen = 999, digits = 7, mc.cores = 4)

library(tidyverse)
library(tidybayes)
library(kableExtra)
library(ggrepel)
library(codebook)

```

## Load dataset and recode missings (e.g., -99 to NA)
```{r}
#tlperson_raw <- read_dta("../../data/ZA6701_person_wid1_v6-0-0.dta")
#tlperson_old <- read_sav("../../data/ZA6701_de_person_v2-0-0.sav")
#tlperson_missings <- codebook::detect_missing(tlperson_raw, ninety_nine_problems = T)
#tlperson_old_missings <- codebook::detect_missing(tlperson_old, ninety_nine_problems = T)

```


## Get migration and school federal state variables from old version of data
```{r}
#tlperson_relevant_vars <- tlperson_old_missings %>% 
#  select(pid, mig0100, mig0300, mig0400, edu0403)

#tlperson <- tlperson_missings %>%
#  left_join(tlperson_relevant_vars, by = "pid")
```

# Data exploration 1
## Compute CFT sum scores (intelligence)
```{r}
#tlperson <- tlperson %>%
#  mutate(cft_short = igf0180 + igf0280 + igf0380 + igf0480) %>% 
#  mutate(cft_long = igf0181 + igf0281 + igf0381 + igf0481) %>%
#  mutate(cft_total = igf0182 + igf0282 + igf0382 + igf0482) %>% 
#  mutate(male = sex == 1)
```


## Check range and central tendency
```{r}
#range(tlperson$cft_short, na.rm = T)
#mean(tlperson$cft_short, na.rm = T)
#range(tlperson$cft_long, na.rm = T)
#mean(tlperson$cft_long, na.rm = T)
#range(tlperson$cft_total, na.rm = T)
#mean(tlperson$cft_total, na.rm = T)
```


## Some vis
```{r}
#qplot(tlperson$age0100)
#qplot(tlperson$age0101)
#qplot(tlperson$cft_long)
#scatter.smooth(tlperson$age0100, tlperson$cft_total)
```

# Pre-processing and more exploration
## Create age groups (in months) corresponding to those in the norm tables (CFT-20R manual)
```{r}
tlperson <- tlperson %>%
  mutate(age_group = case_when(age0101 <= 10*12                           ~ '<10:1',
                               age0101 >= 10*12+1 & age0101 <= 10*12+6    ~ '10:1-10:6',
                               age0101 >= 10*12+7 & age0101 <= 11*12      ~ '10:7-11',
                               age0101 >= 11*12+1 & age0101 <= 11*12+6    ~ '11:1-11:6',
                               age0101 >= 11*12+7 & age0101 <= 12*12      ~ '11:7-12',
                               age0101 >= 12*12+1 & age0101 <= 12*12+6    ~ '12:1-12:6',
                               age0101 >= 12*12+7 & age0101 <= 13*12      ~ '12:7-13',
                               age0101 >= 13*12+1 & age0101 <= 13*12+6    ~ '13:1-13:6',
                               age0101 >= 13*12+7 & age0101 <= 14*12      ~ '13:7-14',
                               age0101 >= 14*12+1 & age0101 <= 14*12+6    ~ '14:1-14:6',
                               age0101 >= 14*12+7 & age0101 <= 15*12      ~ '14:7-15',
                               age0101 >= 15*12+1 & age0101 <= 16*12      ~ '15:1-16',
                               age0101 >= 16*12+1 & age0101 <= 17*12      ~ '16:1-17',
                               age0101 >= 17*12+1 & age0101 <= 19*12+11   ~ '17:1-19:11',
                               age0101 >= 20*12   & age0101 <= 24*12      ~ '20-24',
                               age0101 >= 25*12   & age0101 <= 29*12      ~ '25-29',
                               age0101 >= 30*12   & age0101 <= 34*12      ~ '30-34',
                               age0101 >= 35*12   & age0101 <= 39*12      ~ '35-39',
                               age0101 >= 40*12   & age0101 <= 44*12      ~ '40-44',
                               age0101 >= 45*12   & age0101 <= 49*12      ~ '45-49',
                               age0101 >= 50*12   & age0101 <= 54*12      ~ '50-54',
                               age0101 >= 55*12   & age0101 <= 59*12      ~ '55-59',
                               age0101 >= 60*12   & age0101 <= 64*12      ~ '60-64')
         )
```

## How old are the oldest twins?
```{r}
age_investig <- tlperson %>% 
  group_by(ptyp) %>% 
  summarise(max = max(age0100, na.rm = T))

age_investig2 <- tlperson %>% 
  group_by(ptyp, age_group) %>% 
  summarise(n = n(), max = max(age0101/12, na.rm = T), mean = mean(age0100, na.rm = T))
```


## Are there people between the age groups?
```{r}
tlperson %>% 
  filter(is.na(age_group)) %>% 
  filter(age0101 >= 10*12+1 & age0101 <= 19*12+11) %>% 
  nrow()
```
no

When including age >20?
```{r}
tlperson %>% 
  filter(is.na(age_group)) %>% 
  filter(age0101 >= 20*12) %>% 
  nrow()
```
yup, those between 24 and 25, 29 and 30, etc., probably.

## Gapless age groups
```{r}
tlperson <- tlperson %>%
  mutate(age_group = case_when(age0101 <= 10*12                           ~ '<10:1',
                               age0101 >= 10*12+1 & age0101 <= 10*12+6    ~ '10:1-10:6',
                               age0101 >= 10*12+7 & age0101 <= 11*12      ~ '10:7-11',
                               age0101 >= 11*12+1 & age0101 <= 11*12+6    ~ '11:1-11:6',
                               age0101 >= 11*12+7 & age0101 <= 12*12      ~ '11:7-12',
                               age0101 >= 12*12+1 & age0101 <= 12*12+6    ~ '12:1-12:6',
                               age0101 >= 12*12+7 & age0101 <= 13*12      ~ '12:7-13',
                               age0101 >= 13*12+1 & age0101 <= 13*12+6    ~ '13:1-13:6',
                               age0101 >= 13*12+7 & age0101 <= 14*12      ~ '13:7-14',
                               age0101 >= 14*12+1 & age0101 <= 14*12+6    ~ '14:1-14:6',
                               age0101 >= 14*12+7 & age0101 <= 15*12      ~ '14:7-15',
                               age0101 >= 15*12+1 & age0101 <= 16*12      ~ '15:1-16',
                               age0101 >= 16*12+1 & age0101 <= 17*12      ~ '16:1-17',
                               age0101 >= 17*12+1 & age0101 <= 19*12+11   ~ '17:1-19:11',
                               age0101 >= 20*12   & age0101 <= 24*12+11   ~ '20-24:11',
                               age0101 >= 25*12   & age0101 <= 29*12+11   ~ '25-29:11',
                               age0101 >= 30*12   & age0101 <= 34*12+11   ~ '30-34:11',
                               age0101 >= 35*12   & age0101 <= 39*12+11   ~ '35-39:11',
                               age0101 >= 40*12   & age0101 <= 44*12+11   ~ '40-44:11',
                               age0101 >= 45*12   & age0101 <= 49*12+11   ~ '45-49:11',
                               age0101 >= 50*12   & age0101 <= 54*12+11   ~ '50-54:11',
                               age0101 >= 55*12   & age0101 <= 59*12+11   ~ '55-59:11',
                               age0101 >= 60*12   & age0101 <= 64*12+11   ~ '60-64:11')
         )
```

```{r}
tlperson %>% 
  filter(is.na(age_group)) %>% 
  filter(age0101 >= 20*12) %>% 
  nrow()
```

## Gapless age groups using the age variable in years instead of months for age > 20

```{r}
tlperson <- tlperson %>%
  mutate(age_group = case_when(age0101 <= 10*12                           ~ '<10:1',
                               age0101 >= 10*12+1 & age0101 <= 10*12+6    ~ '10:1-10:6',
                               age0101 >= 10*12+7 & age0101 <= 11*12      ~ '10:7-11',
                               age0101 >= 11*12+1 & age0101 <= 11*12+6    ~ '11:1-11:6',
                               age0101 >= 11*12+7 & age0101 <= 12*12      ~ '11:7-12',
                               age0101 >= 12*12+1 & age0101 <= 12*12+6    ~ '12:1-12:6',
                               age0101 >= 12*12+7 & age0101 <= 13*12      ~ '12:7-13',
                               age0101 >= 13*12+1 & age0101 <= 13*12+6    ~ '13:1-13:6',
                               age0101 >= 13*12+7 & age0101 <= 14*12      ~ '13:7-14',
                               age0101 >= 14*12+1 & age0101 <= 14*12+6    ~ '14:1-14:6',
                               age0101 >= 14*12+7 & age0101 <= 15*12      ~ '14:7-15',
                               age0101 >= 15*12+1 & age0101 <= 16*12      ~ '15:1-16',
                               age0101 >= 16*12+1 & age0101 <= 17*12      ~ '16:1-17',
                               age0101 >= 17*12+1 & age0101 <= 19*12+11   ~ '17:1-19:11',
                               age0100 >= 20      & age0100 <= 24         ~ '20-24',
                               age0100 >= 25      & age0100 <= 29         ~ '25-29',
                               age0100 >= 30      & age0100 <= 34         ~ '30-34',
                               age0100 >= 35      & age0100 <= 39         ~ '35-39',
                               age0100 >= 40      & age0100 <= 44         ~ '40-44',
                               age0100 >= 45      & age0100 <= 49         ~ '45-49',
                               age0100 >= 50      & age0100 <= 54         ~ '50-54',
                               age0100 >= 55      & age0100 <= 59         ~ '55-59',
                               age0100 >= 60      & age0100 <= 64         ~ '60-64')
         )
```

```{r}
tlperson %>% 
  filter(is.na(age_group)) %>% 
  filter(age0101 >= 20*12) %>% 
  nrow()
```
Same effect, going with this.

## Compare norm means and SDs to norm tables
```{r}
norm_means_sds <- tlperson %>% 
  group_by(age_group) %>%
  summarise(n = n(), mean = mean(cft_total, na.rm = T), sd = sd(cft_total, na.rm = T), mean_age = mean(age0101, rm.na = T), min_age = min(age0101, rm.na = T), max_age = max(age0101, rm.na = T)) %>%
  mutate(n_tables =    c(NA_real_, 237,   236,   215,   225,   232,   221,   231,   255,   256,   239,   455,   260,   239, 1163, 288, 498, 424, 1253, 767, 963, 318, 184,  NA_real_),
         mean_tables = c(NA_real_, 30.57, 32.44, 33.17, 34.63, 35.41, 36.05, 37.12, 37.70, 38.43, 39.26, 40.25, 40.68, 41.44, 39.1, 37.7, 36.6, 36.2, 35.6, 34.4, 34, 32, 29.1,  NA_real_),
         sd_tables =   c(NA_real_, 7.03,  6.71,  7.24,  7.38,  7.14,  7.69,  7.08,  7.07,  7.29,  7.39,  7.35,  6.34,  7.68, 8.5, 8.9, 9, 8.5, 9.3, 9.5, 8.7, 9.1, 9.6,  NA_real_))

#qplot(norm_means_sds$mean_tables, norm_means_sds$mean)
#t.test(as.numeric(norm_means_sds$mean_tables), as.numeric(norm_means_sds$mean))
```

## save manual norms table
```{r}
save(norm_means_sds, file="../data/CFT_norms.Rda")
```

#### [Censor the outcome](https://bookdown.org/content/3686/tools-in-the-trunk.html#censored-data-in-jags-brms)

```{r}
range(tlperson$cft_total, na.rm = T)
tlperson %>% group_by(cft_total) %>% summarise(n()) %>% kable()
```
Abandoned since no participant reaches scale's limits, 0 and 56.


## Compute IQ scores
```{r}
tlperson <- tlperson %>%
  left_join(norm_means_sds, by = "age_group") %>% 
  mutate(z_score = (cft_total-mean_tables)/sd_tables) %>% 
  mutate(iq = z_score*15+100)
```


## mean and sd of iq by age group
```{r}
tl_person_iq_by_group <- tlperson %>% 
  group_by(age_group) %>% 
  summarise(n = n(), mean = mean(iq, na.rm = T), sd = sd(iq, na.rm = T))
```

## Exclude everyone younger than 10:1 (didn't take the CFT20)

```{r}
tlperson_older_10 <- tlperson %>% 
  filter(age0101 >= 10*12+1)
```

## Check relevant demographic variables
### rename the variables
```{r}
tlperson_older_10 <- tlperson_older_10 %>% 
  rename(age_in_months = age0101,
         type_of_school = edu0400,
         type_of_degree = eca0100,
         type_of_voc_training = eca0200,
         type_of_last_school = eca0102,
         fed_state_school = edu0403,
         birth_country = mig0100,
         birth_country_ma = mig0300,
         birth_country_pa = mig0400)
```

### merge education variables into one variable
Code pinched from [here](https://stackoverflow.com/questions/47757198/combining-2-mutually-exclusive-columns-in-r-dataframe).

#### check that education variables are actually mutually exclusive
```{r}
View(as_factor(
  tlperson %>%
  group_by(edu0400, eca0100, eca0102, eca0200, edu0301) %>% 
             summarise(n = n())
  
))
```

```{r}
View(as_factor(
  tlperson %>%
  group_by(eca0230, age_group) %>% 
             summarise(n = n())
  
))
```
```{r}
View(as_factor(
  tlperson %>%
  group_by(eca0230, eca0108) %>% 
             summarise(n = n())
  
))
```
```{r}
View(as_factor(
  tlperson %>%
  group_by(mig0100, mig0300, mig0400, age_group) %>% 
             summarise(n = n())
  
))
```

```{r}
View(as_factor(
  tlperson %>%
  group_by(mig2000) %>% 
             summarise(n = n())
  
))
```






```{r}
View(
  tlperson_older_10 %>%
  group_by(type_of_school, type_of_degree, type_of_last_school, type_of_voc_training) %>% 
             summarise(n = n())
  
)
```

#### Merge
```{r}
tlperson_older_10 <- tlperson_older_10 %>%
  mutate(education = pmax(type_of_school, type_of_degree, type_of_voc_training, type_of_last_school, na.rm = T))

#  error Caused by error in `vec_cast.haven_labelled.haven_labelled()`:
# ! Can't convert from `value` <labelled<double>> to <labelled<double>> due to loss of # precision.
# • Locations: 1, 11, 18, 39, 59, 61, 68, 103, 106, 131, 144, 158, 161, 169, 205, 208, 234...
# 
```



### Why are the ns in the norm tables smaller despite it being the same dataset?
```{r}
check_ns <- tlperson_older_10 %>% 
  group_by(ptyp, age_group) %>% 
  summarise(n(), sum(!is.na(cft_total)))
```
Not because of missings on the outcome. Probably because of missings on the variable they used to weigh the means.

### Where is age group 10:1-10:6?
```{r}
check_10.1_10.6 <- tlperson_older_10 %>% 
  group_by(ptyp, age_group) %>% 
  summarise(n())
```
No twins in that age group apparently, only siblings and only 31 of them took the CFT20 judging by the previous table (check_ns).


### Check missings in the rest of variables
```{r}
check_nas <- tlperson_older_10 %>%
  mutate(edu_missing = ifelse(
    is.na(type_of_school) &
    is.na(type_of_degree) &
    is.na(type_of_last_school), NA, 0),
    migr_missing  = ifelse(
    is.na(birth_country) &
    is.na(birth_country_ma) &
    is.na(birth_country_pa), NA, 0)) %>%
  summarise(n(),
cft_total = mean(is.na(cft_total)), 
age = mean(is.na(age_in_months)), gender = mean(is.na(male)),
edu = mean(is.na(edu_missing)),
mig = mean(is.na(migr_missing)),
state = mean(is.na(fed_state_school)))



check_nas_2 <- tlperson_older_10 %>%
  mutate(edu_missing = ifelse(
    is.na(type_of_school) &
    is.na(type_of_degree) &
    is.na(type_of_last_school), NA, 0),
    migr_missing  = ifelse(
    is.na(birth_country) &
    is.na(birth_country_ma) &
    is.na(birth_country_pa), NA, 0)) %>%
  group_by(age_group) %>% 
  summarise(n(),
cft_total = mean(is.na(cft_total)), 
age = mean(is.na(age_in_months)), gender = mean(is.na(male)),
edu = mean(is.na(edu_missing)),
mig = mean(is.na(migr_missing)),
state = mean(is.na(fed_state_school)))
```
Lots of missings, especially for birth country and fed state of school.

## Recode missings into a level of the predictor
```{r}
tlperson_older_10 <- tlperson_older_10 %>%
  mutate_at(c("type_of_degree", "type_of_school", "type_of_last_school", "birth_country", "birth_country_ma", "birth_country_pa", "fed_state_school", "male"), as.character) %>% 
    replace_na(list(type_of_degree = "unknown", 
                  type_of_school = "unknown",
                  type_of_last_school = "unknown",
                  birth_country = "unknown",
                  birth_country_ma = "unknown",
                  birth_country_pa = "unknown",
                  fed_state_school = "unknown",
                  male = "unknown"))
```

## Relevance of COB and Bundesland
### CFT and n by COB
```{r}
View(tlperson %>%
  group_by(as_factor(mig0100), age_group) %>% 
  summarise(n = n(), mean_CFT = mean(cft_total, na.rm = T))
)
```


### CFT and n by Bundesland
```{r}
View(tlperson %>%
  group_by(as_factor(edu0403), age_group) %>% 
  summarise(n = n(), mean_CFT = mean(cft_total, na.rm = T))
)
```
Why so many "doesn't apply (screened out)"??




# more exploration after/during MRP trial run


```{r}
tlperson %>% 
  filter(ptyp == 1) %>% 
  group_by(age0100) %>% 
  summarise(n())
```

```{r}
tlperson %>% 
    group_by(as_factor(ptyp)) %>% 
    summarise(n = n(), proportion_cft_missing = sum(is.na(cft_total)/n())) %>% kable(col.names = c('Type of Person', 'N', 'Proportion of missing CFT-20 scores')) %>% kable_styling(full_width = F)
```

```{r}
codebook(tl)
```


```{r}
ggplot(tl, aes(age0100)) +  geom_histogram(binwidth = 1, center = 0,
                 color = "grey92", size = 1/10) + theme_gray(base_size = 18) + 
  scale_x_continuous("age", breaks = seq(from = 10, to = 25, by = 1))

```



```{r}

tl %>% 
  group_by(age0100) %>% 
  summarise(tl_n = n()) %>% 
  rename(age_by_year = age0100) %>%
  kable() %>% kable_styling(full_width = F)

   

tl %>% 
  group_by(age0101) %>% 
  summarise(tl_n = n()) %>% 
  rename(age_by_month_div_12 = age0101) %>% 
  mutate(age_by_month_div_12 = age_by_month_div_12/12) %>%
  kable() %>% kable_styling(full_width = F)

ggplot(tl, aes(x=age0100)) + 
  geom_histogram(binwidth = 1, center = 0,
                 color = "grey92", size = 1/10) + 
  scale_x_continuous("age", breaks = seq(from = 10, to = 18, by = 1))

```


```{r}
#mcmc_plot(brm_ints_age_r, type = "intervals", variable = "r_male")
#mcmc_plot(brm_ints_age_r, type = "intervals", variable = "r_migration")
#mcmc_plot(brm_ints_age_r, type = "intervals", variable = "r_school_type")

#sd(brm_ints_age_r$data$cft_total)

#ggplot(brm_ints_age_r$data, aes(age, cft_total, color = male)) + geom_smooth() + #geom_point(alpha = 0.1)
#t.test(brm_ints_age_r$data$cft_total ~ brm_ints_age_r$data$male)
#t.test(brm_ints_age_r$data$cft_total ~ brm_ints_age_r$data$migration)

#names(brm_ints_age_r$fit)
```




## migration vars
```{r}

tl_mig <- tlperson %>% 
  filter(age0100 > 10 & !is.na(cft_total) & !is.na(male) & !is.na(age0101)) %>% 
  filter(!is.na(eca0108) | !is.na(edu0400)) %>% 
  select(starts_with("mig")) %>% 
  summarise_all(funs(sum(is.na(.))/n()))
  
mig <- tl %>%
  select(starts_with("mig"), -migration) %>% 
  head() %>% 
  rbind(tl_mig) %>% 
  filter(!is.na(mig0200))
  

as_factor(tlperson %>% group_by(ptyp) %>% select(mig2000, mig0100, mig0300, mig0400) %>% summarise_all(funs(sum(is.na(.))/n())))


as_factor(tl %>% 
  group_by(age0100, mig0300) %>% 
  summarise(sum(is.na(.))/n()))

as_factor(tl %>% group_by(migration) %>% summarise(n = sum(n())))





 
  
  
  
  select(fid, ptyp, mig2000, mig2000_dad, mig2000_mom, born_abroad)
           
  xtabs(~ mig_background, tl, exclude = NULL, addNA = T)
  xtabs(~ mig_background + born_abroad, tl, exclude = NULL, addNA = T)

  xtabs(~ born_abroad + mig2000, tl, exclude = NULL, addNA = T)


tl %>% 
  drop_na(cft_total) %>% 
  select(starts_with("mig2000"), mig0300, mig0400, born_abroad) %>% 
codebook::md_pattern()

tlperson %>%
  group_by(ptyp) %>% 
  summarise(sum(is.na(mig2000)/n()), 
#            sum(is.na(mig0300)/n()), 
#            sum(is.na(mig0400)/n()), 
            sum(is.na(mig0520)/n()), n()) %>% as_factor()
  

tlperson %>%
  group_by(ptyp) %>% 
  summarise(sum(is.na(eca0109)/n()), n()) %>% as_factor()

#  

```


```{r}
tl <- tlperson %>%
  mutate(migration = ifelse(mig2000 != 1, T, F),
         grade = recode(as.factor(edu0402), "1" = "01-04", "2" = "01-04",  "3" = "01-04", "4" = "01-04", "5" = "05-10", "6" = "05-10", "7" = "05-10", "8" = "05-10", "9" = "05-10", "10" = "05-10", "11" = "11-13", "12" = "11-13", "13" = "11-13"),
         school_type = recode(as.factor(edu0400), "1" = "Grundschule", "2" = "Grundschule",  "3" = "Hauptschule", "4" = "Realschule", "5" = "Realschule", "6" = "Gesamtschule", "7" = "Gesamtschule", "8" = "Gymnasium", "9" = "Sonstige Schule", "10" = "Sonstige Schule"),
         age = age0101/12) %>% 
  filter(ptyp == 1 & age0101 >= 10*12 & !is.na(migration) & !is.na(cft_total) & !is.na(age) & !is.na(male))

lm(cft_total ~ migration * age * male, data = tl) %>% summary()

d <- tl %>% group_by(migration, age, male) %>% summarise(n = n(), mean_cft = mean(cft_total)) %>% filter(n > 30)

d <- tl %>% group_by(migration) %>% summarise(n = n(), mean_cft = mean(cft_total)) %>% filter(n > 30)

t.test(data = tl, cft_total ~ migration)

d <- tl %>% group_by(male) %>% summarise(n = n(), mean_cft = mean(cft_total)) %>% filter(n > 30)

t.test(data = tl, cft_total ~ male)
```


## education vars
```{r}
tl_miss <- tlperson %>% 
  select(starts_with("edu"), starts_with("eca"), age0100, ptyp) %>% filter(age0100 >= 10 & age0100 <= 25 & ptyp == 1)  %>% group_by(age0100) %>% 
  summarise_all(funs(sum(is.na(.))/n()))

tl_miss <- tlperson %>% 
  select(age0100, starts_with("edu"), starts_with("eca"), ptyp) %>% filter(age0100 >= 10 & age0100 <= 25 & ptyp == 1)  %>%
  head() %>% 
  rbind(tl_miss) %>% 
  drop_na(edu0100t)



xtabs(~ eca0108 + edu0400, tl, exclude = NULL, addNA = T)

tlperson %>%  filter(!is.na(cft_total)) %>% group_by(eca0108, edu0400) %>% summarise(n()) %>% as_factor() %>% View()

ex <- tl_by_family %>% 
  group_by(ptyp, age0100, eca0108, edu0400) %>% 
  summarise(n()) %>% as_factor()

 ex <- tl %>% 
  group_by(age0100, educ) %>% 
  summarise(n()) %>% as_factor()
```

```{r}

table(tl$edu0100, tl$educ, tl$age0100 >18)
educ <- tl %>% 
  group_by(isced_accord_census, school_type_accord_census) %>% 
  summarise(n())

educ2 <- tl %>% 
  group_by(educ) %>% 
  summarise(n())

educ3 <- tl %>% 
  group_by(educ, isced_accord_census, school_type_accord_census) %>% 
  summarise(n())

educ4 <- tl %>% 
  group_by(age, educ) %>% 
  summarise(n())

over_19 <- tl %>% 
  group_by(age0100, over_19) %>% 
  summarise(n())
```




# COMPLETE GERMAN CENSUS DATA




## schulform

```{r}
library(readxl)
census_Schulform <- read_excel("../data/729305_Zensus2011_Bildung_Schulform.xlsx", 
    sheet = "Migration und Schulform") 

census_Schulform_long <- census_Schulform %>% 
  # remove redundant columns of higher at school categories (e.g., Deutsche mit Migrationshintergrund)
  select(1:2, 21:28, 45:60, 69:76, 85:100) %>%
  # exclude sex and age columns
  select(3:50) %>%
  # before iteratively naming the 48 columns, 8 (school types) * 6 (migration background) 
  set_names(map(c("no mig background", 
                  "foreigner, own mig background", 
                  "foreigner, no own mig background", 
                  "citizen, own mig background",
                  "citizen, mig background from both parents",
                  "citizen, mig background from one parent"),
                ~ paste0(.x, "_", c("total", 
                                    "no longer at school", # Entfällt, da kein/e Schüler/-innen
                                    "at school 1: primary", # Grundschule
                                    "at school 2: lower secondary", # Hauptschule
                                    "at school 3b: upper secondary, vocational", # Realschule
                                    "at school 3a: upper secondary, general", # Gymnasium
                                    "at school 3b: upper secondary, vocational2", # Gesamtschule
                                    "at school 7: other school"))) %>% # Sonstige Schule
            unlist()) %>%
  # create new columns with the sum of each pair of columns
  rowwise() %>% 
  # coerce all columns to numeric
  mutate_all(as.numeric) %>%
  mutate(`citizen, mig background from one parent_at school 3b: upper secondary, vocational` = sum(`citizen, mig background from one parent_at school 3b: upper secondary, vocational`, `citizen, mig background from one parent_at school 3b: upper secondary, vocational2`),
         `citizen, mig background from both parents_at school 3b: upper secondary, vocational` = sum(`citizen, mig background from both parents_at school 3b: upper secondary, vocational`, `citizen, mig background from both parents_at school 3b: upper secondary, vocational2`),
         `foreigner, no own mig background_at school 3b: upper secondary, vocational` = sum(`foreigner, no own mig background_at school 3b: upper secondary, vocational`, `foreigner, no own mig background_at school 3b: upper secondary, vocational2`),
         `foreigner, own mig background_at school 3b: upper secondary, vocational` = sum(`foreigner, own mig background_at school 3b: upper secondary, vocational`, `foreigner, own mig background_at school 3b: upper secondary, vocational2`),
         `no mig background_at school 3b: upper secondary, vocational` = sum(`no mig background_at school 3b: upper secondary, vocational`, `no mig background_at school 3b: upper secondary, vocational2`),
         `citizen, own mig background_at school 3b: upper secondary, vocational` = sum(`citizen, own mig background_at school 3b: upper secondary, vocational`, `citizen, own mig background_at school 3b: upper secondary, vocational2`)) %>%
  ungroup() %>%  
  select(-ends_with("vocational2")) %>% 
  mutate(age = as.numeric(parse_number(census_Schulform[[2]])),
         male = census_Schulform[[1]],
         ) %>% 
  relocate(c(age,male)) %>% 
  mutate(male = ifelse(row_number() >= 115 & row_number() <= 215, TRUE, FALSE)) %>% 
  slice(-(1:113), -215) %>% 
  pivot_longer(cols = 3:44,
               names_to = c("mig", "school_type"),
               names_sep = "_",
               values_to = "cens_n") %>%
#  mutate(cens_n = as.numeric(na_if(cens_n, "/"))) %>% 
  filter(age > 10 & age < 26)


  
```


### How many schulpflichtige kids not at school?
```{r}
not_at_school <- census_Schulform_long %>% 
  filter(age > 10 & age <= 15 & school_type == "not at school" & !is.na(cens_n)) %>% 
  group_by(age, male, mig) %>% 
  summarise(sum(cens_n))
  
sum(not_at_school$`sum(cens_n)`)
```


## ISCED
```{r}
census_ISCED <- read_excel("~/SOBER/MRP Norming/data/729305_Zensus2011_Bildung_ISCED.xlsx", sheet = "Migration und ISCED")

census_ISCED_long <- census_ISCED %>% 
  set_names(paste0("var", 1:133)) %>% 
  select(-(
    census_ISCED %>% 
    summarise(across(everything(), ~ any(str_detect(., "ISCED-Ebene")) & any(str_detect(., "Insgesamt")))) %>% 
    unlist() %>% 
    which()
  )) %>% 
  select(1:2, var24:var34, var57:var78, var90:var100, var112:var133) %>% 
  select(3:56) %>%
  set_names(map(c("no mig background", 
                  "foreigner, own mig background", 
                  "foreigner, no own mig background", 
                  "citizen, own mig background",
                  "citizen, mig background from both parents",
                  "citizen, mig background from one parent"),
                ~ paste0(.x, "_", c("total",
                                    "level 1: primary",                                
                                    "level 2a: lower secondary",                             
                                    "level 3a: upper secondary, general",                               
                                    "level 3b: upper secondary, vocational",                               
                                    "level 4a: post-secondary",                               
                                    "level 5a: tertiary, college etc.",                               
                                    "level 5b: tertiary, tech school etc.",                               
                                    "level 6: PhD"))) %>% 
            unlist()) %>% 
  mutate(age = as.numeric(parse_number(census_ISCED[[2]])),
         male = census_ISCED[[1]]) %>% 
  relocate(c(age,male)) %>% 
  mutate(male = ifelse(row_number() >= 99 & row_number() <= 186, TRUE, FALSE)) %>% 
  slice(-(1:99), -186) %>% 
  pivot_longer(cols = 3:56,
               names_to = c("mig", "isced"),
               names_sep = "_",
               values_to = "cens_n") %>%
  mutate(cens_n = as.numeric(na_if(cens_n, "/")))

 
```

### check if numbers match
```{r}
isced_total_by_age <- census_Schulform_long %>% 
  filter(age > 14, school_type != "total") %>% 
  group_by(age) %>% 
  summarise(sum(cens_n, na.rm = T))

schulform_total_by_age <- census_ISCED_long %>% 
  filter(age > 14, isced != "total") %>% 
  group_by(age) %>% 
  summarise(sum(cens_n, na.rm = T))

identical(isced_total_by_age[['cens_n']],schulform_total_by_age[['cens_n']])
```
They do


### how many people over 20 have a proper school type, i.e., are still at school
```{r}
oldies_at_school <- census_Schulform_long %>% 
  filter(age > 20 & school_type != "total" & school_type != "not at school") %>% 
  group_by(age) %>% 
  summarise(n = sum(cens_n, na.rm = T))


sum(oldies_at_school$n)/sum(census_Schulform_long$cens_n, na.rm=T)
```



### show that most people over 30 are categories as not at school
```{r}
over_thirty <- census_Schulform_long %>% 
  filter(age > 30 & (school_type == "total" | school_type == "not at school")) %>% 
  group_by(age, school_type) %>% 
  summarise(n = sum(cens_n, na.rm = T)) 
  
```

### how many people >14 are not at school
```{r}
not_at_school <- census_Schulform_long %>% 
  filter(age > 14 & (school_type == "total" | school_type == "not at school")) %>% 
  group_by(age, school_type) %>% 
  summarise(n = sum(cens_n, na.rm = T)) %>% 
  pivot_wider(names_from = school_type,
              values_from = n) %>% 
  rename(nas = "not at school") %>% 
  mutate(proportion = nas/total)

not_primary_school <- census_ISCED_long %>% 
  filter(age > 14 & (isced == "total" | isced == "level 1: primary")) %>% 
  group_by(age, isced) %>% 
  summarise(n = sum(cens_n, na.rm = T)) %>% 
  pivot_wider(names_from = isced,
              values_from = n) %>% 
  rename(nas = "level 1: primary") %>% 
  mutate(proportion = nas/total)

```


## merge
```{r}

census_Schulform_long_11_21 <- census_Schulform_long %>% 
  filter((age >= 11 & age <= 21) & school_type != "total") %>% 
  mutate(cens_n = case_when(is.na(cens_n) ~ 0,
                            TRUE ~ cens_n))


census_ISCED_long_15_79 <- census_ISCED_long %>% 
  filter((age >= 15 & age <= 79) & isced != "total") %>% 
  mutate(cens_n = case_when(is.na(cens_n) ~ 0,
                            TRUE ~ cens_n))


census_Schulform_long_11_19 <- census_Schulform_long %>% 
  filter(age <= 19 & school_type != "total") %>% 
  rename(educ = "school_type") %>% 
  relocate(educ, .after = "mig")


census_ISCED_long_20_79 <- census_ISCED_long %>% 
  filter((age >= 20 & age < 80) & isced != "total") %>% 
  rename(educ = "isced")

cens <- census_Schulform_long_11_19 %>% 
  bind_rows(census_ISCED_long_20_79) %>% 
  mutate(cens_n = case_when(is.na(cens_n) ~ 0,
                            TRUE ~ cens_n),
         over_19 = ifelse(age > 19, T, F))
  



any(duplicated(census_Schulform_long[, c("age", "male", "school_type", "mig")]))
any(duplicated(census_Schulform_long_10_19[, c("age", "male", "educ", "mig")]))


censored <- census %>% 
  filter(mig == "no mig background") %>% 
  group_by(age, mig, educ) %>% 
  summarise(mig_non_n = sum(cens_n)) %>% 
  right_join(census, by = c("age", "educ")) %>% 
  mutate(is_censored = case_when(
    !is.na(mig_non_n) & is.na(cens_n) ~ "censored",
    is.na(mig_non_n) & is.na(cens_n) ~ "not possible / not applicable",
    TRUE ~ "valid"
  )) %>% 
  group_by(is_censored) %>% 
  summarise(n())
  
```

get a sense of how much censoring happened
```{r}
d <- census_ISCED_long %>% 
  filter((age > 18 & age < 80) & isced != "total") %>% 
  group_by(age, male, mig) %>% 
  summarise(n_summed = sum(cens_n, na.rm = T))

d2 <- census_ISCED_long %>% 
  filter((age > 18 & age < 80) & isced == "total") %>% 
  group_by(age, male, mig) %>% 
  summarise(n_total = sum(cens_n, na.rm = T)) %>% 
  left_join(d, by = c("age", "male", "mig")) %>% 
  mutate(is_total_larger_or_equal = n_total >= n_summed,
         diff = n_total - n_summed,
         abs_diff = abs(n_total - n_summed))

mean(d2$diff)
mean(d2$abs_diff)
min(d2$diff)
sum(d2$abs_diff/sum(d2$n_total))


s <- census_ISCED_long_19_79 %>% 
  filter(mig == "no mig background") %>% 
  group_by(age, mig, educ) %>% 
  summarise(mig_non_n = sum(cens_n)) %>% 
  right_join(census_ISCED_long_19_79, by = c("age", "educ")) %>% 
  mutate(is_censored = case_when(
    !is.na(mig_non_n) & is.na(cens_n) ~ "censored",
    is.na(mig_non_n) & is.na(cens_n) ~ "not possible / not applicable",
    TRUE ~ "valid"
  )) %>% 
  group_by(is_censored) %>% 
  summarise(n())
```



```{r}
d <- census_Schulform_long %>% 
  filter(age < 19 & school_type != "total") %>% 
  group_by(age, male, mig) %>% 
  summarise(n_summed = sum(cens_n, na.rm = T))

d2 <- census_Schulform_long %>% 
  filter(age < 19 & school_type == "total") %>% 
  group_by(age, male, mig) %>% 
  summarise(n_total = sum(cens_n, na.rm = T)) %>% 
  left_join(d, by = c("age", "male", "mig")) %>% 
  mutate(is_total_larger_or_equal = n_total >= n_summed,
         diff = n_total - n_summed,
         abs_diff = abs(n_total - n_summed))

mean(d2$diff)
mean(d2$abs_diff)
min(d2$diff)
sum(d2$diff/sum(d2$n_total))

s2 <- census_Schulform_long_10_18 %>% 
  filter(mig == "no mig background") %>% 
  group_by(age, mig, educ) %>% 
  summarise(mig_non_n = sum(cens_n)) %>% 
  right_join(census_Schulform_long_10_18, by = c("age", "educ")) %>% 
  mutate(is_censored = case_when(
    !is.na(mig_non_n) & is.na(cens_n) ~ "censored",
    is.na(mig_non_n) & is.na(cens_n) ~ "not possible / not applicable",
    TRUE ~ "valid"
  )) %>% 
  group_by(is_censored) %>% 
  summarise(n())
```

```{r, fig.width=9}
tl_plot <- tl %>% 
  group_by(age0100, mig, ) %>% 
  summarise(tl_n = n()) %>% 
  ungroup() %>% 
  mutate(tl_percentage = 100*tl_n/sum(tl_n)) %>% 
  rename(age = "age0100")

cens_tl <- census %>% 
  full_join(tl_plot, by = c("age", "mig")) %>% 
  mutate(tl_n = replace_na(tl_n, 0), tl_percentage = replace_na(tl_percentage, 0))



cens_tl_long <- cens_tl %>% 
  select(-ends_with("percentage")) %>% 
  pivot_longer(names_to = "source", values_to = "n", -c(age, mig)) %>% 
  mutate(mig = as.character(mig),
         age = as.character(age),
         source = str_sub(source, 1, -3)) %>% 
  pivot_longer(names_to = "variable", values_to = "category", -c(n, source)) %>% 
  group_by(source, variable, category) %>% 
  summarise(n = sum(n)) %>% 
  group_by(source, variable) %>% 
  mutate(percentage = n/sum(n)*100)


ggplot(cens_tl_long, aes(x = category, y = percentage, group = source, colour = source, label = round(percentage))) +
     geom_line(linewidth = 1) +
  theme_gray(base_size = 17) +
     facet_grid(. ~ variable, scales = "free", space='free') +
theme(axis.text.x = element_text(angle = 45, hjust = 1)) + geom_text_repel() 
```

# more data pre-processing and exploration
```{r}
load("../data/tl_clean.Rda")
tl <- tlperson  %>% 
  filter(ptyp == 300 | ptyp == 400) %>% 
  pivot_wider(id_cols = fid, names_from = ptyp, values_from = mig2000) %>% 
  right_join(tlperson, by = "fid") %>% 
  rename(mig2000_dad = `400`, mig2000_mom = `300`) %>% 
  mutate(mig2000_dad = as.numeric(ifelse(ptyp == 300 | ptyp == 400, NA_character_, mig2000_dad)),
         mig2000_mom = as.numeric(ifelse(ptyp == 300 | ptyp == 400, NA_character_, mig2000_mom)),
         mig0300 = recode(as.numeric(mig0300), `2` = 1),
         mig0400 = recode(as.numeric(mig0400), `2` = 1),
         mig0520 = coalesce(mig0520, 1),
         age = age0101/12,
         male = sex == 1,
         eca0108 = str_sub(as.character(as_factor(eca0108)), 4, -1),
         born_abroad = case_when(
            mig2000 != 1 ~ 'self',
            mig2000 == 1 & ((coalesce(mig2000_dad, mig0400) == 1 & coalesce(mig2000_mom, mig0300) == 1)) ~ 'none',
            coalesce(mig2000_dad, mig0400) != 1 & coalesce(mig2000_mom, mig0300) != 1 ~ 'both_parents',
            mig2000_mom != 1 ~ 'one_parent',
            mig2000_dad != 1 ~ 'one_parent',  
            mig0300 != 1 ~ 'one_parent',
            mig0400 != 1 ~ 'one_parent',
            mig2000 == 1 ~ 'none',
            TRUE ~ "none"), 
         mig = case_when(
            born_abroad == "self" & mig0520 == 1 ~ "citizen, own mig background",
            born_abroad == "self" & mig0520 != 1 ~ "foreigner, own mig background",
            born_abroad != "self" & mig0520 != 1 ~ "foreigner, no own mig background",
            born_abroad == "one_parent" & mig0520 == 1 ~ "citizen, mig background from one parent",
            born_abroad == "both_parents" & mig0520 == 1 ~ "citizen, mig background from both parents",
            born_abroad == "none" & mig0520 == 1 ~ "no mig background"),
         school_type_accord_census = case_when(
            edu0400 == 1 ~ "level 1: primary", # Grundschule
            edu0400 == 2 ~ "level 1: primary", # Orientierungsschule
            edu0400 == 3 ~ "level 2a: lower secondary", # Realschule
            edu0400 == 4 ~ "level 3b: upper secondary, vocational", # Realschule
            edu0400 == 5 ~ "level 3b: upper secondary, vocational", # Verbundene Haupt- und Realschule (auch Sekundar-, Real-, Regel-, Mittel-, Ober- und Wirtschaftsschule, regionale Schule, erweiterte Realschule)
            edu0400 == 6 ~ "level 3b: upper secondary, vocational", # Gesamtschule
            edu0400 == 7 ~ "level 3b: upper secondary, vocational", # Waldorfschule
            edu0400 == 8 ~ "level 3a: upper secondary, general", # Gymnasium (auch Kolleg)
            edu0400 == 9 ~ "other school", # Sonderschule/Förderschule
            edu0400 == 10 ~ "other school", # Andere Schule
            edu0100 == 3 ~ "not at school"), # "ich gehe nicht mehr in die Schule"
         isced_accord_census = case_when(
            eca0108 == "3] -83: in school or training/not in school yet" & school_type_accord_census != "other school" ~ school_type_accord_census,
            eca0108 == "9] -89: not codable" ~ NA_character_,
            eca0108 == "5] -95: doesn't apply (screened out)" ~ NA_character_,
            eca0108 == "level 1" ~ "level 1: primary",
            eca0108 == "level 2a" ~ "level 2a: lower secondary",
            eca0108 == "level 3a" ~ "level 3a: upper secondary, general",
            eca0108 == "level 3b" ~ "level 3b: upper secondary, vocational",
            eca0108 == "level 3c" ~ "level 3b: upper secondary, vocational",
            eca0108 == "level 4a" ~ "level 4a: post-secondary",
            eca0108 == "level 5a" ~ "level 5a: tertiary, college etc.",
            eca0108 == " level 5b" ~ "level 5b: tertiary, tech school etc.",
            eca0108 == " level 6" ~ "level 6: PhD"),
         educ = ifelse(age0100 > 19, isced_accord_census, school_type_accord_census),
         over_19 = ifelse(age0100 > 19, T, F)
         ) %>%
 filter(!is.na(cft_total) & !is.na(educ)) # !is.na(educ) removes 272 rows, kids at school age who don't have a school type for some reason
```

## for separate models
```{r}
load("../data/tl_clean.Rda")
tl_sep_models <- tlperson  %>% 
  filter(ptyp == 300 | ptyp == 400) %>% 
  pivot_wider(id_cols = fid, names_from = ptyp, values_from = mig2000) %>% 
  right_join(tlperson, by = "fid") %>% 
  rename(mig2000_dad = `400`, mig2000_mom = `300`) %>% 
  mutate(mig2000_dad = as.numeric(ifelse(ptyp == 300 | ptyp == 400, NA_character_, mig2000_dad)),
         mig2000_mom = as.numeric(ifelse(ptyp == 300 | ptyp == 400, NA_character_, mig2000_mom)),
         mig0300 = recode(as.numeric(mig0300), `2` = 1),
         mig0400 = recode(as.numeric(mig0400), `2` = 1),
         mig0520 = coalesce(mig0520, 1),
         age = age0101/12,
         male = sex == 1,
         eca0108 = str_sub(as.character(as_factor(eca0108)), 4, -1),
         born_abroad = case_when(
            mig2000 != 1 ~ 'self',
            mig2000 == 1 & ((coalesce(mig2000_dad, mig0400) == 1 & coalesce(mig2000_mom, mig0300) == 1)) ~ 'none',
            coalesce(mig2000_dad, mig0400) != 1 & coalesce(mig2000_mom, mig0300) != 1 ~ 'both_parents',
            mig2000_mom != 1 ~ 'one_parent',
            mig2000_dad != 1 ~ 'one_parent',  
            mig0300 != 1 ~ 'one_parent',
            mig0400 != 1 ~ 'one_parent',
            mig2000 == 1 ~ 'none',
            TRUE ~ "none"), 
         mig = case_when(
            born_abroad == "self" & mig0520 == 1 ~ "citizen, own mig background",
            born_abroad == "self" & mig0520 != 1 ~ "foreigner, own mig background",
            born_abroad != "self" & mig0520 != 1 ~ "foreigner, no own mig background",
            born_abroad == "one_parent" & mig0520 == 1 ~ "citizen, mig background from one parent",
            born_abroad == "both_parents" & mig0520 == 1 ~ "citizen, mig background from both parents",
            born_abroad == "none" & mig0520 == 1 ~ "no mig background"),
         school_type = case_when(
            eca0108 == "[-95] -95: doesn't apply  (screened out)" ~ "not at school",
            edu0400 == 1 ~ "level 1: primary", # Grundschule
            edu0400 == 2 ~ "level 1: primary", # Orientierungsschule
            edu0400 == 3 ~ "level 2a: lower secondary", # Realschule
            edu0400 == 4 ~ "level 3b: upper secondary, vocational", # Realschule
            edu0400 == 5 ~ "level 3b: upper secondary, vocational", # Verbundene Haupt- und Realschule (auch Sekundar-, Real-, Regel-, Mittel-, Ober- und Wirtschaftsschule, regionale Schule, erweiterte Realschule)
            edu0400 == 6 ~ "level 3b: upper secondary, vocational", # Gesamtschule
            edu0400 == 7 ~ "level 3b: upper secondary, vocational", # Waldorfschule
            edu0400 == 8 ~ "level 3a: upper secondary, general", # Gymnasium (auch Kolleg)
            edu0400 == 9 ~ "other school",
            edu0400 == 10 ~ "other school",
            edu0100 == 3 ~ "not at school"),
         isced = case_when(
            eca0108 == "3] -83: in school or training/not in school yet" ~ "level 1: primary",
            eca0108 == "9] -89: not codable" ~ NA_character_,
            eca0108 == "5] -95: doesn't apply (screened out)" ~ NA_character_,
            eca0108 == "level 1" ~ "level 1: primary",
            eca0108 == "level 2a" ~ "level 2a: lower secondary",
            eca0108 == "level 3a" ~ "level 3a: upper secondary, general",
            eca0108 == "level 3b" ~ "level 3b: upper secondary, vocational",
            eca0108 == "level 3c" ~ "level 3b: upper secondary, vocational",
            eca0108 == "level 4a" ~ "level 4a: post-secondary",
            eca0108 == "level 5a" ~ "level 5a: tertiary, college etc.",
            eca0108 == " level 5b" ~ "level 5b: tertiary, tech school etc.",
            eca0108 == " level 6" ~ "level 6: PhD")) %>%
 filter(!is.na(cft_total) & ptyp != 1 & !is.na(educ)) # !is.na(educ) removes 272 rows, kids at school age who don't have a school type for some reason
```


## totals for the disparities plot
```{r}
age_marginals <- census_Schulform %>%
  # total column, rows for ages 11 through 79
  select(3) %>% 
  slice(23:91) %>% 
  mutate(n = as.numeric(`...3`),
         category = as.character(11:79),
         percentage = n/sum(n)*100,
         source = "cens",
         variable = "age") %>% 
  select(-1)

sex_marginals <- census_Schulform %>%
  # total column, rows for ages 11 through 79
  select(3) %>% 
  slice((125:193), (227:295)) %>% 
  mutate(category = as.character(ifelse(row_number() < 70, T, F)),
         n = as.numeric(`...3`)) %>% 
  group_by(category) %>% 
  summarize(n = sum(n)) %>% 
  mutate(source = "cens",
         variable = "male",
         percentage = n/sum(n)*100)

school_type_marginals <- census_Schulform %>% 
  select(14:20) %>% 
  slice(23:30) %>% 
  set_names(paste0(c("no longer at school", # Entfällt, da kein/e Schüler/-innen
                                    "at school 1: primary", # Grundschule
                                    "at school 2a: lower secondary", # Hauptschule
                                    "at school 3b: upper secondary, vocational", # Realschule
                                    "at school 3a: upper secondary, general", # Gymnasium
                                    "at school 3b: upper secondary, vocational2", # Gesamtschule
                                    "at school 7: other school"))) %>% # Sonstige Schule 
  mutate_all(as.numeric) %>% 
  summarise(across(everything(), ~sum(., na.rm = TRUE))) %>% 
  mutate(`at school 3b: upper secondary, vocational` = sum(`at school 3b: upper secondary, vocational`, `at school 3b: upper secondary, vocational2`)) %>%
  select(-`at school 3b: upper secondary, vocational2`) %>% 
  pivot_longer(cols = everything(), names_to = "category", values_to = "n")
  
  
educ_marginals <- census_ISCED %>% 
  select(14, 15, 17:19, 21, 22, 23) %>% 
    slice(17:77) %>% 
  set_names(paste0(c("level 1: primary",                   
                      "level 2a: lower secondary",          
                      "level 3a: upper secondary, general", 
                      "level 3b: upper secondary, vocational",
                      "level 4a: post-secondary",           
                      "level 5a: tertiary, college etc.",   
                      "level 5b: tertiary, tech school etc.",
                      "level 6: PhD"))) %>% 
  mutate_all(as.numeric) %>% 
  summarise(across(everything(), ~sum(., na.rm = TRUE))) %>% 
  pivot_longer(cols = everything(), names_to = "category", values_to = "n") %>% 
  full_join(school_type_marginals, by = "category") %>% 
  mutate(n = ifelse((is.na(n.x) | is.na(n.y)), coalesce(n.x, n.y), n.x + n.y),
         source = "cens",
         variable = "educ",
         percentage = n/sum(n)*100) %>% 
  select(-c(n.x,n.y))

mig_marginals <- census_Schulform %>% 
  select(4, 7, 8, 10, 12, 13) %>% 
  slice(23:91) %>% 
  set_names(paste0(c("no mig background", 
                  "foreigner, own mig background", 
                  "foreigner, no own mig background", 
                  "citizen, own mig background",
                  "citizen, mig background from both parents",
                  "citizen, mig background from one parent"))) %>% 
  mutate_all(as.numeric) %>% 
  summarise(across(everything(), ~sum(., na.rm = TRUE))) %>% 
  pivot_longer(cols = everything(), names_to = "category", values_to = "n") %>% 
  mutate(source = "cens",
         variable = "mig",
         percentage = n/sum(n)*100)
                     
cens_marginals <- bind_rows(age_marginals, educ_marginals, sex_marginals, mig_marginals)

```


## save final tl data
```{r}
save(tl, file="../data/tl_final.Rda")
```

## save final post-stratfication table
```{r}
save(cens, file="../data/census_final.Rda")
save(census_ISCED_long_15_79, file="../data/census_15_79.Rda")
save(census_Schulform_long_11_21, file="../data/census_11_21.Rda")
```

## save census marginals
```{r}
save(cens_marginals, file="../data/census_marginals.Rda")
```


## save final CFT manual norms table
```{r}
load("../data/CFT_norms.Rda")

CFT_manual_norms <- norm_means_sds %>%
  filter(!is.na(age_group)) %>%
  mutate(age = case_when(age_group == "10:1-10:6" | age_group == "10:7-11" ~ '10',
                         age_group == "11:1-11:6" | age_group == "11:7-12" ~ '11',
                         age_group == "12:1-12:6" | age_group == "12:7-13" ~ '12',
                         age_group == "13:1-13:6" | age_group == "13:7-14" ~ '13',
                         age_group == "14:1-14:6" | age_group == "14:7-15" ~ '14',
                         age_group == "15:1-16"                          ~ '15',
                         age_group == "16:1-17"                          ~ '16',
                         age_group == "17:1-19:11"                       ~ '17')) %>% 
  filter(!is.na(age)) %>% 
  group_by(age) %>% 
  summarise(manual_n = sum(n_tables), manual_mean = mean(mean_tables), manual_sd = sqrt(mean(sd_tables^2)), manual_seOfmean = manual_sd/sqrt(manual_n)) %>% 
  add_row(age = "18", manual_mean = 41.440) %>% 
  add_row(age = "19", manual_mean = 41.440) %>% 
  mutate(age = as.numeric(age))

```


## investigate differences in sd
```{r, fig.width=12}
sds <- tl %>% 
  group_by(age0100, ptyp) %>% 
  summarise(tl_n = n(), tl_mean = mean(cft_total, na.rm = T), tl_sd = sd(cft_total, na.rm = T), tl_seOfmean = tl_sd/sqrt(tl_n)) %>% 
  rename(age = age0100) %>% 
  mutate(ptyp = as_factor(ptyp)) %>% 
  mutate(tl_sd = ifelse(is.na(tl_sd), 0, tl_sd))

ggplot(data = sds, aes(x = as.numeric(age), y = tl_sd, group = ptyp, colour = ptyp, label = tl_n)) +
  geom_line(linewidth = 1) +
  geom_point(size = 3, shape = 18, position = position_dodge(width = 0.3))  + geom_label_repel() +
  scale_x_continuous(limits = c(11, 79), breaks = seq(11, 79, by = 2))
```

```{r, fig.width=9}
sds <- tl %>% 
  filter(age < 26) %>% 
  group_by(age0100, ptyp) %>% 
  summarise(tl_n = n(), tl_mean = mean(cft_total, na.rm = T), tl_sd = sd(cft_total, na.rm = T), tl_seOfmean = tl_sd/sqrt(tl_n)) %>% 
  rename(age = age0100) %>% 
  mutate(ptyp = as_factor(ptyp))

ggplot(data = sds, aes(x = as.numeric(age), y = tl_sd, group = ptyp, colour = ptyp, label = tl_n)) +
  geom_line(linewidth = 1) +
  geom_point(size = 3, shape = 18, position = position_dodge(width = 0.3))  + geom_label_repel() +
  scale_x_continuous(breaks = seq(11, 26, by = 1))
```



